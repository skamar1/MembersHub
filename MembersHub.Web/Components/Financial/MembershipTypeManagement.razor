@page "/financial/membership-types"
@using MembersHub.Core.Entities
@using MembersHub.Core.Interfaces
@using Microsoft.AspNetCore.Authorization
@using MembersHub.Web.Components.Financial
@inject IMembershipTypeService MembershipTypeService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@attribute [Authorize(Roles = "Admin,Owner")]

<PageTitle>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î¤ÏÏ€Ï‰Î½ Î£Ï…Î½Î´ÏÎ¿Î¼Î®Ï‚</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-6">
        <MudText Typo="Typo.h4">ğŸ·ï¸ Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î¤ÏÏ€Ï‰Î½ Î£Ï…Î½Î´ÏÎ¿Î¼Î®Ï‚</MudText>
        <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="OpenCreateDialog">
            <MudIcon Icon="Icons.Material.Filled.Add" Class="mr-2" />
            ÎÎ­Î¿Ï‚ Î¤ÏÏ€Î¿Ï‚ Î£Ï…Î½Î´ÏÎ¿Î¼Î®Ï‚
        </MudButton>
    </div>

    <!-- Summary Cards -->
    <MudGrid Class="mb-6">
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2" Style="background: linear-gradient(45deg, #f8f9fa, #e9ecef);">
                <MudCardContent Class="text-center">
                    <MudIcon Icon="Icons.Material.Filled.Category" Color="Color.Primary" Size="Size.Large" />
                    <MudText Typo="Typo.h6" Class="mt-2">@membershipTypes.Count</MudText>
                    <MudText Typo="Typo.body2">Î£Ï…Î½Î¿Î»Î¹ÎºÎ¿Î¯ Î¤ÏÏ€Î¿Î¹</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2" Style="background: linear-gradient(45deg, #d4edda, #c3e6cb);">
                <MudCardContent Class="text-center">
                    <MudIcon Icon="Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large" />
                    <MudText Typo="Typo.h6" Class="mt-2">@membershipTypes.Count(mt => mt.IsActive)</MudText>
                    <MudText Typo="Typo.body2">Î•Î½ÎµÏÎ³Î¿Î¯ Î¤ÏÏ€Î¿Î¹</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2" Style="background: linear-gradient(45deg, #fff3cd, #ffeaa7);">
                <MudCardContent Class="text-center">
                    <MudIcon Icon="Icons.Material.Filled.People" Color="Color.Warning" Size="Size.Large" />
                    <MudText Typo="Typo.h6" Class="mt-2">@membershipTypes.Sum(mt => mt.Members.Count)</MudText>
                    <MudText Typo="Typo.body2">Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ Î‘Î¸Î»Î·Ï„Î­Ï‚/ÎœÎ­Î»Î·</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2" Style="background: linear-gradient(45deg, #d1ecf1, #bee5eb);">
                <MudCardContent Class="text-center">
                    <MudIcon Icon="Icons.Material.Filled.Euro" Color="Color.Info" Size="Size.Large" />
                    <MudText Typo="Typo.h6" Class="mt-2">â‚¬@(membershipTypes.Where(mt => mt.IsActive).Any() ? membershipTypes.Where(mt => mt.IsActive).Average(mt => mt.MonthlyFee).ToString("N2") : "0.00")</MudText>
                    <MudText Typo="Typo.body2">ÎœÎ­ÏƒÎ¿ Î¤Î­Î»Î¿Ï‚</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Membership Types Table -->
    <MudCard Elevation="3">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Î¤ÏÏ€Î¿Î¹ Î£Ï…Î½Î´ÏÎ¿Î¼Î®Ï‚</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent Class="pa-0">
            <MudDataGrid T="MembershipType" Items="@membershipTypes" Filterable="true" SortMode="@SortMode.Multiple"
                         Loading="@loading" LoadingProgressColor="Color.Info" Hover="true"
                         RowsPerPage="10" Elevation="0">
                <Columns>
                    <PropertyColumn Property="x => x.Id" Title="ID" />
                    <PropertyColumn Property="x => x.Name" Title="ÎŒÎ½Î¿Î¼Î±" />
                    <PropertyColumn Property="x => x.MonthlyFee" Title="ÎœÎ·Î½Î¹Î±Î¯Î¿ Î¤Î­Î»Î¿Ï‚" Format="C2">
                        <CellTemplate>
                            <MudText Typo="Typo.body2" Style="font-weight: 600;">â‚¬@context.Item.MonthlyFee.ToString("N2")</MudText>
                        </CellTemplate>
                    </PropertyColumn>
                    <PropertyColumn Property="x => x.Description" Title="Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®">
                        <CellTemplate>
                            @if (!string.IsNullOrWhiteSpace(context.Item.Description))
                            {
                                <MudText Typo="Typo.body2">@context.Item.Description</MudText>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">Î§Ï‰ÏÎ¯Ï‚ Ï€ÎµÏÎ¹Î³ÏÎ±Ï†Î®</MudText>
                            }
                        </CellTemplate>
                    </PropertyColumn>
                    <TemplateColumn Title="Î‘Î¸Î»Î·Ï„Î­Ï‚/ÎœÎ­Î»Î·">
                        <CellTemplate>
                            <div class="d-flex align-center">
                                <MudIcon Icon="Icons.Material.Filled.People" Size="Size.Small" Class="mr-2" />
                                <MudText Typo="Typo.body2">@context.Item.Members.Count</MudText>
                            </div>
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.IsActive" Title="ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·">
                        <CellTemplate>
                            <MudChip Size="Size.Small" Color="@(context.Item.IsActive ? Color.Success : Color.Default)"
                                     Icon="@(context.Item.IsActive ? Icons.Material.Filled.CheckCircle : Icons.Material.Filled.Cancel)">
                                @(context.Item.IsActive ? "Î•Î½ÎµÏÎ³ÏŒÏ‚" : "Î‘Î½ÎµÎ½ÎµÏÎ³ÏŒÏ‚")
                            </MudChip>
                        </CellTemplate>
                    </PropertyColumn>
                    <TemplateColumn Title="Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚" CellClass="d-flex justify-end">
                        <CellTemplate>
                            <MudButtonGroup Variant="Variant.Text" Size="Size.Small">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary"
                                               OnClick="() => OpenEditDialog(context.Item)"
                                               Title="Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±" />
                                @if (context.Item.Members.Count == 0)
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                                   OnClick="() => DeleteMembershipType(context.Item)"
                                                   Title="Î”Î¹Î±Î³ÏÎ±Ï†Î®" />
                                }
                                else
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete" Color="Color.Error"
                                                   OnClick="() => ShowCannotDeleteMessage(context.Item)"
                                                   Title="Î”ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Î³ÏÎ±Ï†ÎµÎ¯" />
                                }
                            </MudButtonGroup>
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
                <PagerContent>
                    <MudDataGridPager T="MembershipType" />
                </PagerContent>
            </MudDataGrid>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private bool loading = true;
    private List<MembershipType> membershipTypes = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadMembershipTypes();
    }

    private async Task LoadMembershipTypes()
    {
        loading = true;
        try
        {
            var types = await MembershipTypeService.GetAllAsync();
            membershipTypes = types.ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· Ï„ÏÏ€Ï‰Î½ ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚: {ex.Message}", Severity.Error);
            membershipTypes = new List<MembershipType>();
        }
        finally
        {
            loading = false;
        }
    }

    private async Task OpenCreateDialog()
    {
        var parameters = new DialogParameters
        {
            { "MembershipType", new MembershipType { IsActive = true } },
            { "IsEdit", false }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<MembershipTypeDialog>(
            "ÎÎ­Î¿Ï‚ Î¤ÏÏ€Î¿Ï‚ Î£Ï…Î½Î´ÏÎ¿Î¼Î®Ï‚",
            parameters,
            options);

        var result = await dialog.Result;
        if (result is not null && !result.Canceled)
        {
            await LoadMembershipTypes();
        }
    }

    private async Task OpenEditDialog(MembershipType membershipType)
    {
        var parameters = new DialogParameters
        {
            { "MembershipType", membershipType },
            { "IsEdit", true }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<MembershipTypeDialog>(
            "Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î¤ÏÏ€Î¿Ï… Î£Ï…Î½Î´ÏÎ¿Î¼Î®Ï‚",
            parameters,
            options);

        var result = await dialog.Result;
        if (result is not null && !result.Canceled)
        {
            await LoadMembershipTypes();
        }
    }

    private async Task DeleteMembershipType(MembershipType membershipType)
    {
        var result = await DialogService.ShowMessageBox(
            "Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Î”Î¹Î±Î³ÏÎ±Ï†Î®Ï‚",
            $"Î˜Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Ï„Î¿Î½ Ï„ÏÏ€Î¿ ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚ '{membershipType.Name}';",
            yesText: "Î”Î¹Î±Î³ÏÎ±Ï†Î®", cancelText: "Î‘ÎºÏÏÏ‰ÏƒÎ·");

        if (result == true)
        {
            try
            {
                await MembershipTypeService.DeleteAsync(membershipType.Id);
                Snackbar.Add($"ÎŸ Ï„ÏÏ€Î¿Ï‚ ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚ '{membershipType.Name}' Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!", Severity.Success);
                await LoadMembershipTypes();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î®: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ShowCannotDeleteMessage(MembershipType membershipType)
    {
        await DialogService.ShowMessageBox(
            "Î‘Î´Ï…Î½Î±Î¼Î¯Î± Î”Î¹Î±Î³ÏÎ±Ï†Î®Ï‚",
            $"Î”ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Ï„Î¿Î½ Ï„ÏÏ€Î¿ ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚ '{membershipType.Name}' Î³Î¹Î±Ï„Î¯ Î­Ï‡ÎµÎ¹ Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¹Ï‡Î¹ÏƒÎ¼Î­Î½Î¿Ï…Ï‚ Î±Î¸Î»Î·Ï„Î­Ï‚/Î¼Î­Î»Î· ({membershipType.Members.Count}).\n\nÎ ÏÏÏ„Î± Î¼ÎµÏ„Î±Ï†Î­ÏÎµÏ„Îµ Ï„Î¿Ï…Ï‚ Î±Î¸Î»Î·Ï„Î­Ï‚/Î¼Î­Î»Î· ÏƒÎµ Î¬Î»Î»Î¿Î½ Ï„ÏÏ€Î¿ ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚.",
            yesText: "ÎšÎ±Ï„Î±Î½Î¿Î·Ï„ÏŒ");
    }
}