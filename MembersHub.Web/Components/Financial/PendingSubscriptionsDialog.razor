@using MembersHub.Core.Entities
@using MudBlazor
@using Microsoft.AspNetCore.Components

<MudDialog>
    <DialogContent>
        <MudContainer Class="pa-4">
            <MudText Typo="Typo.h6" Class="mb-4">ğŸ“‹ Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚ Î£Ï…Î½Î´ÏÎ¿Î¼Î­Ï‚</MudText>

            @if (PendingSubscriptions.Any())
            {
                <MudAlert Severity="Severity.Info" Class="mb-4">
                    Î’ÏÎ­Î¸Î·ÎºÎ±Î½ <strong>@PendingSubscriptions.Count()</strong> ÎµÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚ ÏƒÏ…Î½Î´ÏÎ¿Î¼Î­Ï‚ ÏƒÏ…Î½Î¿Î»Î¹ÎºÎ¿Ï Ï€Î¿ÏƒÎ¿Ï
                    <strong>â‚¬@PendingSubscriptions.Sum(s => s.Amount).ToString("N2")</strong>
                </MudAlert>

                <MudDataGrid T="Subscription" Items="@PendingSubscriptions" Filterable="true" SortMode="@SortMode.Multiple"
                             Hover="true" RowsPerPage="15" Elevation="0">
                    <Columns>
                        <TemplateColumn Title="ÎœÎ­Î»Î¿Ï‚">
                            <CellTemplate>
                                <div class="d-flex align-center">
                                    <MudAvatar Size="Size.Small" Color="Color.Primary" Class="mr-3">
                                        @context.Item.Member.FirstName.Substring(0, 1)@context.Item.Member.LastName.Substring(0, 1)
                                    </MudAvatar>
                                    <div>
                                        <MudText Typo="Typo.body2">@context.Item.Member.FirstName @context.Item.Member.LastName</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Item.Member.MemberNumber</MudText>
                                    </div>
                                </div>
                            </CellTemplate>
                        </TemplateColumn>
                        <PropertyColumn Property="x => x.Month" Title="ÎœÎ®Î½Î±Ï‚">
                            <CellTemplate>
                                @GetMonthName(context.Item.Month)
                            </CellTemplate>
                        </PropertyColumn>
                        <PropertyColumn Property="x => x.Year" Title="ÎˆÏ„Î¿Ï‚" />
                        <PropertyColumn Property="x => x.Amount" Title="Î Î¿ÏƒÏŒ" Format="C2">
                            <CellTemplate>
                                <MudText Typo="Typo.body2" Style="font-weight: 600;">â‚¬@context.Item.Amount.ToString("N2")</MudText>
                            </CellTemplate>
                        </PropertyColumn>
                        <PropertyColumn Property="x => x.DueDate" Title="ÎšÎ±Ï„Î±Î»Î·ÎºÏ„Î¹ÎºÎ®" Format="dd/MM/yyyy">
                            <CellTemplate>
                                <div class="d-flex align-center">
                                    @if (context.Item.DueDate < DateTime.Now)
                                    {
                                        <MudIcon Icon="Icons.Material.Filled.Warning" Color="Color.Error" Size="Size.Small" Class="mr-1" />
                                    }
                                    <MudText Typo="Typo.body2">@context.Item.DueDate.ToString("dd/MM/yyyy")</MudText>
                                </div>
                            </CellTemplate>
                        </PropertyColumn>
                        <PropertyColumn Property="x => x.Status" Title="ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·">
                            <CellTemplate>
                                <MudChip Size="Size.Small" Color="@GetStatusColor(context.Item.Status)"
                                         Icon="@GetStatusIcon(context.Item.Status)">
                                    @GetStatusText(context.Item.Status)
                                </MudChip>
                            </CellTemplate>
                        </PropertyColumn>
                        <TemplateColumn Title="Î—Î¼Î­ÏÎµÏ‚ ÎšÎ±Î¸Ï…ÏƒÏ„Î­ÏÎ·ÏƒÎ·Ï‚">
                            <CellTemplate>
                                @if (context.Item.DueDate < DateTime.Now)
                                {
                                    var daysOverdue = (DateTime.Now - context.Item.DueDate).Days;
                                    <MudChip Size="Size.Small" Color="Color.Error">
                                        @daysOverdue Î·Î¼Î­ÏÎµÏ‚
                                    </MudChip>
                                }
                                else
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">-</MudText>
                                }
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>
                    <PagerContent>
                        <MudDataGridPager T="Subscription" />
                    </PagerContent>
                </MudDataGrid>

                <!-- Summary by Member -->
                <MudCard Class="mt-6" Elevation="2">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">ğŸ“Š ÎŸÏ†ÎµÎ¹Î»Î­Ï‚ Î±Î½Î¬ ÎœÎ­Î»Î¿Ï‚</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudGrid>
                            @foreach (var memberGroup in PendingSubscriptions.GroupBy(s => s.Member))
                            {
                                <MudItem xs="12" sm="6" md="4" Class="mb-3">
                                    <MudPaper Class="pa-3" Elevation="1">
                                        <MudText Typo="Typo.subtitle2">@memberGroup.Key.FirstName @memberGroup.Key.LastName</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">@memberGroup.Key.MemberNumber</MudText>
                                        <MudText Typo="Typo.body1" Class="mt-2">
                                            <strong>â‚¬@memberGroup.Sum(s => s.Amount).ToString("N2")</strong>
                                            (@memberGroup.Count() ÏƒÏ…Î½Î´ÏÎ¿Î¼Î­Ï‚)
                                        </MudText>
                                    </MudPaper>
                                </MudItem>
                            }
                        </MudGrid>
                    </MudCardContent>
                </MudCard>
            }
            else
            {
                <MudAlert Severity="Severity.Success">
                    Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚ ÏƒÏ…Î½Î´ÏÎ¿Î¼Î­Ï‚! ğŸ‰
                </MudAlert>
            }
        </MudContainer>
    </DialogContent>

    <DialogActions>
        <MudButton OnClick="Close">ÎšÎ»ÎµÎ¯ÏƒÎ¹Î¼Î¿</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter] public IEnumerable<Subscription> PendingSubscriptions { get; set; } = new List<Subscription>();

    void Close() => MudDialog.Cancel();

    private string GetMonthName(int month)
    {
        var monthNames = new[] { "", "Î™Î±Î½Î¿Ï…Î¬ÏÎ¹Î¿Ï‚", "Î¦ÎµÎ²ÏÎ¿Ï…Î¬ÏÎ¹Î¿Ï‚", "ÎœÎ¬ÏÏ„Î¹Î¿Ï‚", "Î‘Ï€ÏÎ¯Î»Î¹Î¿Ï‚", "ÎœÎ¬Î¹Î¿Ï‚", "Î™Î¿ÏÎ½Î¹Î¿Ï‚",
                                "Î™Î¿ÏÎ»Î¹Î¿Ï‚", "Î‘ÏÎ³Î¿Ï…ÏƒÏ„Î¿Ï‚", "Î£ÎµÏ€Ï„Î­Î¼Î²ÏÎ¹Î¿Ï‚", "ÎŸÎºÏ„ÏÎ²ÏÎ¹Î¿Ï‚", "ÎÎ¿Î­Î¼Î²ÏÎ¹Î¿Ï‚", "Î”ÎµÎºÎ­Î¼Î²ÏÎ¹Î¿Ï‚" };
        return month >= 1 && month <= 12 ? monthNames[month] : month.ToString();
    }

    private Color GetStatusColor(SubscriptionStatus status)
    {
        return status switch
        {
            SubscriptionStatus.Paid => Color.Success,
            SubscriptionStatus.Pending => Color.Warning,
            SubscriptionStatus.Overdue => Color.Error,
            _ => Color.Default
        };
    }

    private string GetStatusIcon(SubscriptionStatus status)
    {
        return status switch
        {
            SubscriptionStatus.Paid => Icons.Material.Filled.CheckCircle,
            SubscriptionStatus.Pending => Icons.Material.Filled.Schedule,
            SubscriptionStatus.Overdue => Icons.Material.Filled.Warning,
            _ => Icons.Material.Filled.Help
        };
    }

    private string GetStatusText(SubscriptionStatus status)
    {
        return status switch
        {
            SubscriptionStatus.Paid => "Î Î»Î·ÏÏ‰Î¼Î­Î½Î·",
            SubscriptionStatus.Pending => "Î•ÎºÎºÏÎµÎ¼Î®Ï‚",
            SubscriptionStatus.Overdue => "ÎšÎ±Î¸Ï…ÏƒÏ„ÎµÏÎ·Î¼Î­Î½Î·",
            _ => status.ToString()
        };
    }
}