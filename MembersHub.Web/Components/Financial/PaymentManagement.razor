@page "/financial/payments"
@using MembersHub.Core.Entities
@using MembersHub.Core.Interfaces
@using MembersHub.Infrastructure.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject MembersHubContext Context
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject ISubscriptionService SubscriptionService
@inject IPaymentService PaymentService
@inject IDialogService DialogService
@attribute [Authorize(Roles = "Admin,Owner,Treasurer")]

@code {
    [SupplyParameterFromQuery]
    public int? MemberId { get; set; }
}

<PageTitle>Payment Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-6">
        <MudText Typo="Typo.h4">ğŸ’³ Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î Î»Î·ÏÏ‰Î¼ÏÎ½</MudText>
        <MudButtonGroup Variant="Variant.Filled">
            <MudButton Color="Color.Primary" OnClick="OpenNewPaymentDialog">
                <MudIcon Icon="Icons.Material.Filled.Add" Class="mr-2" />
                ÎÎ­Î± Î Î»Î·ÏÏ‰Î¼Î®
            </MudButton>
            <MudButton Color="Color.Secondary" OnClick="ShowPendingSubscriptions">
                <MudIcon Icon="Icons.Material.Filled.Schedule" Class="mr-2" />
                Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚ Î£Ï…Î½Î´ÏÎ¿Î¼Î­Ï‚
            </MudButton>
        </MudButtonGroup>
    </div>

    <!-- Quick Payment Section for Cashiers -->
    <AuthorizeView Roles="Treasurer" Context="treasurerContext">
        <Authorized>
            <MudCard Class="mb-6" Elevation="3" Style="background: linear-gradient(45deg, #e8f5e8, #f1f8e9);">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">âš¡ Î“ÏÎ®Î³Î¿ÏÎ· Î•Î¹ÏƒÏ€ÏÎ±Î¾Î·</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid AlignItems="Center">
                    <MudItem xs="12" sm="4">
                        <MudAutocomplete T="Member"
                                         Value="selectedMember"
                                         ValueChanged="OnSelectedMemberChanged"
                                         SearchFunc="SearchMembers"
                                         ToStringFunc="@(m => m?.FullName ?? "")"
                                         Label="Î•Ï€Î¹Î»Î­Î¾Ï„Îµ ÎœÎ­Î»Î¿Ï‚"
                                         Variant="Variant.Outlined"
                                         AdornmentIcon="Icons.Material.Filled.Person" />
                    </MudItem>
                    <MudItem xs="12" sm="3">
                        <MudNumericField @bind-Value="quickPaymentAmount"
                                         Label="Î Î¿ÏƒÏŒ (â‚¬)"
                                         Variant="Variant.Outlined"
                                         Format="N2"
                                         Min="0"
                                         AdornmentIcon="Icons.Material.Filled.Euro" />
                    </MudItem>
                    <MudItem xs="12" sm="3">
                        <MudSelect @bind-Value="quickPaymentMethod" Label="Î¤ÏÏŒÏ€Î¿Ï‚ Î Î»Î·ÏÏ‰Î¼Î®Ï‚" Variant="Variant.Outlined">
                            <MudSelectItem Value="PaymentMethod.Cash">ÎœÎµÏ„ÏÎ·Ï„Î¬</MudSelectItem>
                            <MudSelectItem Value="PaymentMethod.BankTransfer">Î¤ÏÎ±Ï€ÎµÎ¶Î¹ÎºÎ® ÎœÎµÏ„Î±Ï†Î¿ÏÎ¬</MudSelectItem>
                            <MudSelectItem Value="PaymentMethod.Card">ÎšÎ¬ÏÏ„Î±</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="2">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Success"
                                   FullWidth="true"
                                   OnClick="ProcessQuickPayment"
                                   Disabled="selectedMember == null || quickPaymentAmount <= 0">
                            <MudIcon Icon="Icons.Material.Filled.Payment" />
                            Î•Î¹ÏƒÏ€ÏÎ±Î¾Î·
                        </MudButton>
                    </MudItem>
                </MudGrid>

                @if (selectedMember != null && memberPendingSubscriptions.Any())
                {
                    <MudPaper Class="pa-3 mt-4" Elevation="1" Style="background-color: #fff3cd;">
                        <MudText Typo="Typo.subtitle2" Class="mb-2">Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚ Î£Ï…Î½Î´ÏÎ¿Î¼Î­Ï‚:</MudText>
                        @foreach (var subscription in memberPendingSubscriptions)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Class="mr-2 mb-1">
                                @GetMonthName(subscription.Month) @subscription.Year - â‚¬@subscription.Amount.ToString("N2")
                            </MudChip>
                        }
                        <MudText Typo="Typo.caption" Class="mt-2">
                            Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î¿Ï†ÎµÎ¹Î»ÏŒÎ¼ÎµÎ½Î¿: <strong>â‚¬@memberPendingSubscriptions.Sum(s => s.Amount).ToString("N2")</strong>
                        </MudText>
                    </MudPaper>
                }
            </MudCardContent>
            </MudCard>
        </Authorized>
    </AuthorizeView>

    <!-- Summary Cards -->
    <MudGrid Class="mb-6">
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent Class="text-center">
                    <MudIcon Icon="Icons.Material.Filled.Payments" Color="Color.Primary" Size="Size.Large" />
                    <MudText Typo="Typo.h6" Class="mt-2">@payments.Count</MudText>
                    <MudText Typo="Typo.body2">Î£Ï…Î½Î¿Î»Î¹ÎºÎ­Ï‚ Î Î»Î·ÏÏ‰Î¼Î­Ï‚</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2">
                <MudCardContent Class="text-center">
                    <MudIcon Icon="Icons.Material.Filled.Euro" Color="Color.Success" Size="Size.Large" />
                    <MudText Typo="Typo.h6" Class="mt-2">â‚¬@payments.Sum(p => p.Amount).ToString("N2")</MudText>
                    <MudText Typo="Typo.body2">Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î Î¿ÏƒÏŒ</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Payments Table -->
    <MudCard Elevation="3">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Î Î»Î·ÏÏ‰Î¼Î­Ï‚</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent Class="pa-0">
            <MudDataGrid T="Payment" Items="@payments" Filterable="true" SortMode="@SortMode.Multiple"
                         Loading="@loading" LoadingProgressColor="Color.Info" Hover="true"
                         RowsPerPage="10" Elevation="0">
                <Columns>
                    <PropertyColumn Property="x => x.Id" Title="ID" />
                    <TemplateColumn Title="ÎœÎ­Î»Î¿Ï‚">
                        <CellTemplate Context="paymentContext">
                            @paymentContext.Item.Member.FirstName @paymentContext.Item.Member.LastName
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.Amount" Title="Î Î¿ÏƒÏŒ" Format="C2" />
                    <PropertyColumn Property="x => x.PaymentDate" Title="Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±" Format="dd/MM/yyyy" />
                    <PropertyColumn Property="x => x.PaymentMethod" Title="Î¤ÏÏŒÏ€Î¿Ï‚ Î Î»Î·ÏÏ‰Î¼Î®Ï‚" />
                    <PropertyColumn Property="x => x.Status" Title="ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·" />
                </Columns>
                <PagerContent>
                    <MudDataGridPager T="Payment" />
                </PagerContent>
            </MudDataGrid>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private bool loading = true;
    private List<Payment> payments = new();
    private List<Member> allMembers = new();
    private Member? selectedMember;
    private decimal quickPaymentAmount = 0;
    private PaymentMethod quickPaymentMethod = PaymentMethod.Cash;
    private List<Subscription> memberPendingSubscriptions = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadPayments();
        await LoadMembers();
    }

    private async Task LoadPayments()
    {
        loading = true;
        try
        {
            payments = await Context.Payments
                .Include(p => p.Member)
                .Include(p => p.Collector)
                .Include(p => p.Subscription)
                .OrderByDescending(p => p.PaymentDate)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· Ï€Î»Î·ÏÏ‰Î¼ÏÎ½: {ex.Message}", Severity.Error);
            payments = new List<Payment>();
        }
        finally
        {
            loading = false;
        }
    }

    private async Task LoadMembers()
    {
        try
        {
            allMembers = await Context.Members
                .Where(m => m.Status == MemberStatus.Active)
                .OrderBy(m => m.LastName)
                .ThenBy(m => m.FirstName)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· Î¼ÎµÎ»ÏÎ½: {ex.Message}", Severity.Error);
        }
    }

    private async Task<IEnumerable<Member>> SearchMembers(string value, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(value))
            return allMembers.Take(10);

        return allMembers
            .Where(m => m.FullName.Contains(value, StringComparison.OrdinalIgnoreCase) ||
                       m.MemberNumber.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Take(10);
    }

    private async Task LoadMemberPendingSubscriptions(int memberId)
    {
        try
        {
            var subscriptions = await SubscriptionService.GetMemberSubscriptionsAsync(memberId);
            memberPendingSubscriptions = subscriptions
                .Where(s => s.Status == SubscriptionStatus.Pending || s.Status == SubscriptionStatus.Overdue)
                .ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· ÏƒÏ…Î½Î´ÏÎ¿Î¼ÏÎ½: {ex.Message}", Severity.Error);
            memberPendingSubscriptions = new List<Subscription>();
        }
    }

    private async Task ProcessQuickPayment()
    {
        if (selectedMember == null || quickPaymentAmount <= 0)
            return;

        try
        {
            var payment = new Payment
            {
                MemberId = selectedMember.Id,
                Amount = quickPaymentAmount,
                PaymentDate = DateTime.Now,
                PaymentMethod = quickPaymentMethod,
                Status = PaymentStatus.Confirmed,
                Notes = "Î•Î¹ÏƒÏ€ÏÎ±Î¾Î· Î±Ï€ÏŒ Ï„Î±Î¼ÎµÎ¯Î¿"
            };

            await PaymentService.CreatePaymentAsync(payment);

            Snackbar.Add($"Î— Ï€Î»Î·ÏÏ‰Î¼Î® â‚¬{quickPaymentAmount:N2} ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®Î¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚ Î³Î¹Î± Ï„Î¿Î½/Ï„Î·Î½ {selectedMember.FullName}!", Severity.Success);

            // Reset form
            selectedMember = null;
            quickPaymentAmount = 0;
            memberPendingSubscriptions.Clear();

            await LoadPayments();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ ÎºÎ±Ï„Î±Ï‡ÏÏÎ·ÏƒÎ· Ï€Î»Î·ÏÏ‰Î¼Î®Ï‚: {ex.Message}", Severity.Error);
        }
    }

    private async Task ShowPendingSubscriptions()
    {
        try
        {
            var pendingSubscriptions = await SubscriptionService.GetPendingSubscriptionsAsync();
            var overdueSubscriptions = await SubscriptionService.GetOverdueSubscriptionsAsync();

            var allPending = pendingSubscriptions.Concat(overdueSubscriptions).ToList();

            if (!allPending.Any())
            {
                Snackbar.Add("Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚ ÏƒÏ…Î½Î´ÏÎ¿Î¼Î­Ï‚!", Severity.Info);
                return;
            }

            var parameters = new DialogParameters
            {
                { "PendingSubscriptions", allPending }
            };

            var options = new DialogOptions
            {
                CloseButton = true,
                MaxWidth = MaxWidth.Large,
                FullWidth = true
            };

            await DialogService.ShowAsync<PendingSubscriptionsDialog>(
                "Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚ Î£Ï…Î½Î´ÏÎ¿Î¼Î­Ï‚",
                parameters,
                options);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· ÎµÎºÎºÏÎµÎ¼ÏÎ½ ÏƒÏ…Î½Î´ÏÎ¿Î¼ÏÎ½: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnSelectedMemberChanged(Member? member)
    {
        selectedMember = member;

        if (selectedMember != null)
        {
            await LoadMemberPendingSubscriptions(selectedMember.Id);

            // Auto-fill amount with total pending
            if (memberPendingSubscriptions.Any())
            {
                quickPaymentAmount = memberPendingSubscriptions.Sum(s => s.Amount);
            }
        }
        else
        {
            memberPendingSubscriptions.Clear();
            quickPaymentAmount = 0;
        }

        StateHasChanged();
    }

    private async Task OpenNewPaymentDialog()
    {
        Snackbar.Add("Î— Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¯Î± Î¸Î± Ï…Î»Î¿Ï€Î¿Î¹Î·Î¸ÎµÎ¯ ÏƒÏÎ½Ï„Î¿Î¼Î±", Severity.Info);
    }

    private string GetMonthName(int month)
    {
        var monthNames = new[] { "", "Î™Î±Î½Î¿Ï…Î¬ÏÎ¹Î¿Ï‚", "Î¦ÎµÎ²ÏÎ¿Ï…Î¬ÏÎ¹Î¿Ï‚", "ÎœÎ¬ÏÏ„Î¹Î¿Ï‚", "Î‘Ï€ÏÎ¯Î»Î¹Î¿Ï‚", "ÎœÎ¬Î¹Î¿Ï‚", "Î™Î¿ÏÎ½Î¹Î¿Ï‚",
                                "Î™Î¿ÏÎ»Î¹Î¿Ï‚", "Î‘ÏÎ³Î¿Ï…ÏƒÏ„Î¿Ï‚", "Î£ÎµÏ€Ï„Î­Î¼Î²ÏÎ¹Î¿Ï‚", "ÎŸÎºÏ„ÏÎ²ÏÎ¹Î¿Ï‚", "ÎÎ¿Î­Î¼Î²ÏÎ¹Î¿Ï‚", "Î”ÎµÎºÎ­Î¼Î²ÏÎ¹Î¿Ï‚" };
        return month >= 1 && month <= 12 ? monthNames[month] : month.ToString();
    }
}