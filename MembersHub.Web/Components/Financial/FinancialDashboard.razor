@page "/financial/dashboard"
@using MembersHub.Core.Entities
@using MembersHub.Core.Interfaces
@using Microsoft.AspNetCore.Authorization
@using MembersHub.Application.Services
@inject IFinancialService FinancialService
@inject ISnackbar Snackbar
@inject TimeZoneService TimeZone
@attribute [Authorize(Roles = "Admin,Owner,Treasurer")]

<PageTitle>Financial Dashboard</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-6">ğŸ’° Financial Dashboard</MudText>

    <!-- Period Selection -->
    <MudPaper Class="pa-4 mb-6" Elevation="2">
        <MudGrid AlignItems="Center">
            <MudItem xs="12" sm="6" md="3">
                <MudDatePicker Label="Î‘Ï€ÏŒ" @bind-Date="startDate" />
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudDatePicker Label="ÎˆÏ‰Ï‚" @bind-Date="endDate" />
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="LoadDashboardData"
                           Class="mt-4"
                           Disabled="@loading">
                    @if (loading)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">Î¦ÏŒÏÏ„Ï‰ÏƒÎ·...</MudText>
                    }
                    else
                    {
                        <MudIcon Icon="Icons.Material.Filled.Refresh" Class="mr-2" />
                        <MudText>Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·</MudText>
                    }
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="string" Label="Î“ÏÎ®Î³Î¿ÏÎ· ÎµÏ€Î¹Î»Î¿Î³Î®" Value="@selectedPeriod" ValueChanged="OnPeriodChanged">
                    <MudSelectItem Value="@("this_month")">Î‘Ï…Ï„ÏŒÏ‚ Î¿ Î¼Î®Î½Î±Ï‚</MudSelectItem>
                    <MudSelectItem Value="@("last_month")">Î ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿Ï‚ Î¼Î®Î½Î±Ï‚</MudSelectItem>
                    <MudSelectItem Value="@("this_year")">Î¦Î­Ï„Î¿Ï‚</MudSelectItem>
                    <MudSelectItem Value="@("last_year")">Î Î­ÏÏƒÎ¹</MudSelectItem>
                </MudSelect>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (loading)
    {
        <div class="d-flex justify-center pa-8">
            <MudProgressCircular Indeterminate="true" Size="Size.Large" />
        </div>
    }
    else if (summary != null)
    {
        <!-- Financial Summary Cards -->
        <MudGrid Class="mb-6">
            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="3">
                    <MudCardContent Class="text-center">
                        <MudIcon Icon="Icons.Material.Filled.TrendingUp" Size="Size.Large" Color="Color.Success" Class="mb-2" />
                        <MudText Typo="Typo.h6" Color="Color.Success">Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÎˆÏƒÎ¿Î´Î±</MudText>
                        <MudText Typo="Typo.h4">â‚¬@summary.TotalIncome.ToString("N2")</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Î£Ï…Î½Î´ÏÎ¿Î¼Î­Ï‚: â‚¬@summary.MembershipIncome.ToString("N2")
                        </MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="3">
                    <MudCardContent Class="text-center">
                        <MudIcon Icon="Icons.Material.Filled.TrendingDown" Size="Size.Large" Color="Color.Error" Class="mb-2" />
                        <MudText Typo="Typo.h6" Color="Color.Error">Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÎˆÎ¾Î¿Î´Î±</MudText>
                        <MudText Typo="Typo.h4">â‚¬@summary.TotalExpenses.ToString("N2")</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Î›ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¹ÎºÎ¬: â‚¬@summary.OperationalExpenses.ToString("N2")
                        </MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="3">
                    <MudCardContent Class="text-center">
                        <MudIcon Icon="Icons.Material.Filled.AccountBalance" Size="Size.Large"
                                Color="@(summary.NetProfit >= 0 ? Color.Success : Color.Error)" Class="mb-2" />
                        <MudText Typo="Typo.h6" Color="@(summary.NetProfit >= 0 ? Color.Success : Color.Error)">
                            ÎšÎ±Î¸Î±ÏÏŒ ÎšÎ­ÏÎ´Î¿Ï‚
                        </MudText>
                        <MudText Typo="Typo.h4">â‚¬@summary.NetProfit.ToString("N2")</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: â‚¬@summary.CurrentBalance.ToString("N2")
                        </MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="3">
                    <MudCardContent Class="text-center">
                        <MudIcon Icon="Icons.Material.Filled.Groups" Size="Size.Large" Color="Color.Info" Class="mb-2" />
                        <MudText Typo="Typo.h6" Color="Color.Info">Î‘Î¸Î»Î·Ï„Î­Ï‚/ÎœÎ­Î»Î·</MudText>
                        <MudText Typo="Typo.h4">@summary.PaidMembers/@summary.TotalMembers</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚: @summary.PendingPayments
                        </MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- Charts Row -->
        <MudGrid Class="mb-6">
            <MudItem xs="12" md="8">
                <MudCard Elevation="3" Class="pa-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">ğŸ“Š ÎœÎ·Î½Î¹Î±Î¯Î± Î•Î¾Î­Î»Î¹Î¾Î·</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (monthlyData.Any())
                        {
                            <div style="height: 400px;">
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                                    Î£ÏÎ³ÎºÏÎ¹ÏƒÎ· ÎµÏƒÏŒÎ´Ï‰Î½ ÎºÎ±Î¹ ÎµÎ¾ÏŒÎ´Ï‰Î½ Î±Î½Î¬ Î¼Î®Î½Î±
                                </MudText>
                                <!-- Chart implementation would go here -->
                                <div class="d-flex justify-center align-center" style="height: 350px; background: linear-gradient(45deg, #f5f5f5, #e0e0e0); border-radius: 8px;">
                                    <MudText Typo="Typo.h6" Color="Color.Secondary">ğŸ“ˆ Chart Component</MudText>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="text-center pa-8">
                                <MudText Typo="Typo.body1" Color="Color.Secondary">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± Ï„Î·Î½ Ï€ÎµÏÎ¯Î¿Î´Î¿</MudText>
                            </div>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" md="4">
                <MudCard Elevation="3" Class="pa-4">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">ğŸ’³ Î¤ÏÏŒÏ€Î¿Î¹ Î Î»Î·ÏÏ‰Î¼Î®Ï‚</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        @if (paymentMethodStats.Any())
                        {
                            @foreach (var method in paymentMethodStats)
                            {
                                <div class="d-flex justify-space-between align-center mb-3">
                                    <div>
                                        <MudText Typo="Typo.body1">@GetPaymentMethodName(method.PaymentMethod)</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">@method.Count Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚</MudText>
                                    </div>
                                    <MudText Typo="Typo.h6">â‚¬@method.Total.ToString("N2")</MudText>
                                </div>
                                <MudProgressLinear Value="@(GetPaymentMethodPercentage(method.Total))" Color="Color.Primary" Class="mb-3" />
                            }
                        }
                        else
                        {
                            <div class="text-center pa-4">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚</MudText>
                            </div>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- Outstanding Payments Section -->
        <MudCard Elevation="3" Class="mb-6">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">âš ï¸ Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚ Î Î»Î·ÏÏ‰Î¼Î­Ï‚</MudText>
                </CardHeaderContent>
                <CardHeaderActions>
                    <MudButton Variant="Variant.Text" Color="Color.Primary" Href="/financial/subscriptions">
                        Î ÏÎ¿Î²Î¿Î»Î® ÎŒÎ»Ï‰Î½
                    </MudButton>
                </CardHeaderActions>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Class="pa-4 text-center" Style="background: #fff3cd;">
                            <MudIcon Icon="Icons.Material.Filled.Schedule" Color="Color.Warning" Size="Size.Large" />
                            <MudText Typo="Typo.h6" Class="mt-2">@summary.PendingPayments</MudText>
                            <MudText Typo="Typo.body2">Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚</MudText>
                            <MudText Typo="Typo.caption">â‚¬@summary.PendingAmount.ToString("N2")</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Class="pa-4 text-center" Style="background: #f8d7da;">
                            <MudIcon Icon="Icons.Material.Filled.Warning" Color="Color.Error" Size="Size.Large" />
                            <MudText Typo="Typo.h6" Class="mt-2">@summary.OverduePayments</MudText>
                            <MudText Typo="Typo.body2">ÎšÎ±Î¸Ï…ÏƒÏ„ÎµÏÎ·Î¼Î­Î½ÎµÏ‚</MudText>
                            <MudText Typo="Typo.caption">â‚¬@summary.OverdueAmount.ToString("N2")</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Class="pa-4 text-center" Style="background: #d1ecf1;">
                            <MudIcon Icon="Icons.Material.Filled.Payments" Color="Color.Info" Size="Size.Large" />
                            <MudText Typo="Typo.h6" Class="mt-2">@summary.TotalPayments</MudText>
                            <MudText Typo="Typo.body2">Î£Ï…Î½Î¿Î»Î¹ÎºÎ­Ï‚ Î Î»Î·ÏÏ‰Î¼Î­Ï‚</MudText>
                            <MudText Typo="Typo.caption">Î‘Ï…Ï„Î®Î½ Ï„Î·Î½ Ï€ÎµÏÎ¯Î¿Î´Î¿</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudPaper Class="pa-4 text-center" Style="background: #d4edda;">
                            <MudIcon Icon="Icons.Material.Filled.TrendingUp" Color="Color.Success" Size="Size.Large" />
                            <MudText Typo="Typo.h6" Class="mt-2">â‚¬@GetAveragePayment()</MudText>
                            <MudText Typo="Typo.body2">ÎœÎ­ÏƒÎ¿Ï‚ ÎŒÏÎ¿Ï‚</MudText>
                            <MudText Typo="Typo.caption">Î Î»Î·ÏÏ‰Î¼Î®</MudText>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudCardContent>
        </MudCard>

        <!-- Quick Actions -->
        <MudCard Elevation="3">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">âš¡ Î“ÏÎ®Î³Î¿ÏÎµÏ‚ Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12" sm="6" md="3">
                        <MudButton Variant="Variant.Outlined" Color="Color.Primary" FullWidth="true"
                                   Href="/financial/payments/new" Class="pa-4">
                            <div class="text-center">
                                <MudIcon Icon="Icons.Material.Filled.Add" Size="Size.Large" Class="mb-2" />
                                <br />ÎÎ­Î± Î Î»Î·ÏÏ‰Î¼Î®
                            </div>
                        </MudButton>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudButton Variant="Variant.Outlined" Color="Color.Secondary" FullWidth="true"
                                   Href="/financial/expenses/new" Class="pa-4">
                            <div class="text-center">
                                <MudIcon Icon="Icons.Material.Filled.Receipt" Size="Size.Large" Class="mb-2" />
                                <br />ÎÎ­Î¿ ÎˆÎ¾Î¿Î´Î¿
                            </div>
                        </MudButton>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudButton Variant="Variant.Outlined" Color="Color.Tertiary" FullWidth="true"
                                   Href="/financial/invoices/generate" Class="pa-4">
                            <div class="text-center">
                                <MudIcon Icon="Icons.Material.Filled.Description" Size="Size.Large" Class="mb-2" />
                                <br />Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î¤Î¹Î¼Î¿Î»Î¿Î³Î¯Ï‰Î½
                            </div>
                        </MudButton>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="3">
                        <MudButton Variant="Variant.Outlined" Color="Color.Info" FullWidth="true"
                                   Href="/financial/reports" Class="pa-4">
                            <div class="text-center">
                                <MudIcon Icon="Icons.Material.Filled.Assessment" Size="Size.Large" Class="mb-2" />
                                <br />Î‘Î½Î±Ï†Î¿ÏÎ­Ï‚
                            </div>
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudCardContent>
        </MudCard>
    }
</MudContainer>

@code {
    private bool loading = true;
    private DateTime? startDate;
    private DateTime? endDate;
    private string selectedPeriod = "this_month";
    private FinancialSummary? summary;
    private List<MonthlyFinancialData> monthlyData = new();
    private List<(string PaymentMethod, int Count, decimal Total)> paymentMethodStats = new();

    protected override async Task OnInitializedAsync()
    {
        SetCurrentMonth();
        await LoadDashboardData();
    }

    private void SetCurrentMonth()
    {
        var greekNow = TimeZone.GetGreekNow();
        var firstDay = new DateTime(greekNow.Year, greekNow.Month, 1);
        var lastDay = firstDay.AddMonths(1).AddDays(-1);

        startDate = TimeZone.ConvertToUtc(firstDay);
        endDate = TimeZone.ConvertToUtc(lastDay.AddDays(1).AddSeconds(-1)); // End of last day
    }

    private async Task OnPeriodChanged(string period)
    {
        selectedPeriod = period;
        var greekNow = TimeZone.GetGreekNow();

        switch (period)
        {
            case "this_month":
                var firstDay = new DateTime(greekNow.Year, greekNow.Month, 1);
                var lastDay = firstDay.AddMonths(1).AddDays(-1);
                startDate = TimeZone.ConvertToUtc(firstDay);
                endDate = TimeZone.ConvertToUtc(lastDay.AddDays(1).AddSeconds(-1));
                break;
            case "last_month":
                var lastMonthFirst = new DateTime(greekNow.Year, greekNow.Month, 1).AddMonths(-1);
                var lastMonthLast = lastMonthFirst.AddMonths(1).AddDays(-1);
                startDate = TimeZone.ConvertToUtc(lastMonthFirst);
                endDate = TimeZone.ConvertToUtc(lastMonthLast.AddDays(1).AddSeconds(-1));
                break;
            case "this_year":
                var yearStart = new DateTime(greekNow.Year, 1, 1);
                var yearEnd = new DateTime(greekNow.Year, 12, 31, 23, 59, 59);
                startDate = TimeZone.ConvertToUtc(yearStart);
                endDate = TimeZone.ConvertToUtc(yearEnd);
                break;
            case "last_year":
                var lastYearStart = new DateTime(greekNow.Year - 1, 1, 1);
                var lastYearEnd = new DateTime(greekNow.Year - 1, 12, 31, 23, 59, 59);
                startDate = TimeZone.ConvertToUtc(lastYearStart);
                endDate = TimeZone.ConvertToUtc(lastYearEnd);
                break;
        }

        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        if (startDate == null || endDate == null) return;

        loading = true;
        try
        {
            // Load financial summary
            summary = await FinancialService.GetFinancialSummaryAsync(startDate.Value, endDate.Value);

            // Load monthly data for charts
            monthlyData = await FinancialService.GetMonthlyDataAsync(startDate.Value.Year);

            // Load payment method statistics
            paymentMethodStats = await FinancialService.GetPaymentMethodStatsAsync(startDate.Value, endDate.Value);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½: {ex.Message}", Severity.Error);

            // Create mock data for demonstration
            summary = new FinancialSummary
            {
                PeriodStart = startDate.Value,
                PeriodEnd = endDate.Value,
                TotalIncome = 2500m,
                MembershipIncome = 2200m,
                TotalExpenses = 1800m,
                OperationalExpenses = 1500m,
                NetProfit = 700m,
                CurrentBalance = 15000m,
                TotalMembers = 85,
                PaidMembers = 72,
                PendingPayments = 13,
                OverduePayments = 3,
                PendingAmount = 390m,
                OverdueAmount = 90m,
                TotalPayments = 45,
                GeneratedAt = TimeZone.ConvertToUtc(TimeZone.GetGreekNow())
            };

            paymentMethodStats = new List<(string, int, decimal)>
            {
                ("Cash", 25, 1200m),
                ("Card", 15, 900m),
                ("BankTransfer", 5, 400m)
            };
        }
        finally
        {
            loading = false;
        }
    }

    private string GetPaymentMethodName(string method)
    {
        return method switch
        {
            "Cash" => "ÎœÎµÏ„ÏÎ·Ï„Î¬",
            "Card" => "ÎšÎ¬ÏÏ„Î±",
            "BankTransfer" => "ÎˆÎ¼Î²Î±ÏƒÎ¼Î±",
            "DigitalWallet" => "Î¨Î·Ï†Î¹Î±ÎºÏŒ Î Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹",
            "Check" => "Î•Ï€Î¹Ï„Î±Î³Î®",
            _ => method
        };
    }

    private double GetPaymentMethodPercentage(decimal amount)
    {
        var total = paymentMethodStats.Sum(x => x.Total);
        return total > 0 ? (double)(amount / total * 100) : 0;
    }

    private string GetAveragePayment()
    {
        if (summary?.TotalPayments > 0 && summary.TotalIncome > 0)
        {
            var average = summary.TotalIncome / summary.TotalPayments;
            return average.ToString("N2");
        }
        return "0.00";
    }
}