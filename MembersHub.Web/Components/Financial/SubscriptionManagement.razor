@page "/financial/subscriptions"
@using MembersHub.Core.Entities
@using MembersHub.Core.Interfaces
@using MembersHub.Infrastructure.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using MembersHub.Web.Components.Financial
@using MembersHub.Web.Models
@inject IDbContextFactory<MembersHubContext> ContextFactory
@inject IFinancialService FinancialService
@inject ISubscriptionService SubscriptionService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IEmailNotificationService EmailService
@inject ISessionService SessionService
@attribute [Authorize(Roles = "Admin,Owner,Treasurer")]

<PageTitle>Subscription Management</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-6">
        <MudText Typo="Typo.h4">ğŸ“… Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î£Ï…Î½Î´ÏÎ¿Î¼ÏÎ½</MudText>
        <MudButtonGroup Variant="Variant.Filled">
            <MudButton Color="Color.Primary" OnClick="ShowGenerateSubscriptionsDialog">
                <MudIcon Icon="Icons.Material.Filled.Add" Class="mr-2" />
                Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î£Ï…Î½Î´ÏÎ¿Î¼ÏÎ½ ÎœÎ®Î½Î±
            </MudButton>
            <MudButton Color="Color.Secondary" OnClick="SendPaymentReminders">
                <MudIcon Icon="Icons.Material.Filled.Email" Class="mr-2" />
                Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î¥Ï€ÎµÎ½Î¸Ï…Î¼Î¯ÏƒÎµÏ‰Î½
            </MudButton>
        </MudButtonGroup>
    </div>

    <!-- Filters -->
    <MudPaper Class="pa-4 mb-6" Elevation="2">
        <MudGrid AlignItems="Center">
            <MudItem xs="12" sm="6" md="2">
                <MudSelect T="int" Label="ÎˆÏ„Î¿Ï‚" @bind-Value="selectedYear">
                    @foreach (var year in availableYears)
                    {
                        <MudSelectItem T="int" Value="@year">@year</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="2">
                <MudSelect T="int?" Label="ÎœÎ®Î½Î±Ï‚" @bind-Value="selectedMonth" Clearable="true">
                    <MudSelectItem Value="@((int?)1)">Î™Î±Î½Î¿Ï…Î¬ÏÎ¹Î¿Ï‚</MudSelectItem>
                    <MudSelectItem Value="@((int?)2)">Î¦ÎµÎ²ÏÎ¿Ï…Î¬ÏÎ¹Î¿Ï‚</MudSelectItem>
                    <MudSelectItem Value="@((int?)3)">ÎœÎ¬ÏÏ„Î¹Î¿Ï‚</MudSelectItem>
                    <MudSelectItem Value="@((int?)4)">Î‘Ï€ÏÎ¯Î»Î¹Î¿Ï‚</MudSelectItem>
                    <MudSelectItem Value="@((int?)5)">ÎœÎ¬Î¹Î¿Ï‚</MudSelectItem>
                    <MudSelectItem Value="@((int?)6)">Î™Î¿ÏÎ½Î¹Î¿Ï‚</MudSelectItem>
                    <MudSelectItem Value="@((int?)7)">Î™Î¿ÏÎ»Î¹Î¿Ï‚</MudSelectItem>
                    <MudSelectItem Value="@((int?)8)">Î‘ÏÎ³Î¿Ï…ÏƒÏ„Î¿Ï‚</MudSelectItem>
                    <MudSelectItem Value="@((int?)9)">Î£ÎµÏ€Ï„Î­Î¼Î²ÏÎ¹Î¿Ï‚</MudSelectItem>
                    <MudSelectItem Value="@((int?)10)">ÎŸÎºÏ„ÏÎ²ÏÎ¹Î¿Ï‚</MudSelectItem>
                    <MudSelectItem Value="@((int?)11)">ÎÎ¿Î­Î¼Î²ÏÎ¹Î¿Ï‚</MudSelectItem>
                    <MudSelectItem Value="@((int?)12)">Î”ÎµÎºÎ­Î¼Î²ÏÎ¹Î¿Ï‚</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="2">
                <MudSelect T="SubscriptionStatus?" Label="ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·" @bind-Value="selectedStatus" Clearable="true">
                    <MudSelectItem Value="@((SubscriptionStatus?)SubscriptionStatus.Pending)">Î•ÎºÎºÏÎµÎ¼Î®Ï‚</MudSelectItem>
                    <MudSelectItem Value="@((SubscriptionStatus?)SubscriptionStatus.Paid)">Î Î»Î·ÏÏ‰Î¼Î­Î½Î·</MudSelectItem>
                    <MudSelectItem Value="@((SubscriptionStatus?)SubscriptionStatus.Overdue)">ÎšÎ±Î¸Ï…ÏƒÏ„ÎµÏÎ·Î¼Î­Î½Î·</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="2">
                <MudSelect T="int" Label="Î¤Î¼Î®Î¼Î±" @bind-Value="selectedDepartmentId">
                    <MudSelectItem T="int" Value="0">ÎŒÎ»Î± Ï„Î± Ï„Î¼Î®Î¼Î±Ï„Î±</MudSelectItem>
                    @foreach (var dept in departments)
                    {
                        <MudSelectItem T="int" Value="@dept.Id">@dept.Name</MudSelectItem>
                    }
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="2">
                <MudTextField @bind-Value="memberSearch" Label="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· ÎœÎ­Î»Î¿Ï…Ï‚"
                              Adornment="Adornment.End" AdornmentIcon="Icons.Material.Filled.Search" />
            </MudItem>
            <MudItem xs="12" sm="6" md="2">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="LoadSubscriptions"
                           Class="mt-4"
                           Disabled="@loading">
                    @if (loading)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·...</MudText>
                    }
                    else
                    {
                        <MudIcon Icon="Icons.Material.Filled.Search" Class="mr-2" />
                        <MudText>Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·</MudText>
                    }
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>

    <!-- Summary Statistics -->
    <MudGrid Class="mb-6">
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2" Style="background: linear-gradient(45deg, #f8f9fa, #e9ecef);">
                <MudCardContent Class="text-center">
                    <MudIcon Icon="Icons.Material.Filled.CalendarMonth" Color="Color.Primary" Size="Size.Large" />
                    <MudText Typo="Typo.h6" Class="mt-2">@subscriptions.Count</MudText>
                    <MudText Typo="Typo.body2">Î£Ï…Î½Î¿Î»Î¹ÎºÎ­Ï‚ Î£Ï…Î½Î´ÏÎ¿Î¼Î­Ï‚</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2" Style="background: linear-gradient(45deg, #d4edda, #c3e6cb);">
                <MudCardContent Class="text-center">
                    <MudIcon Icon="Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Large" />
                    <MudText Typo="Typo.h6" Class="mt-2">@subscriptions.Count(s => s.Status == SubscriptionStatus.Paid)</MudText>
                    <MudText Typo="Typo.body2">Î Î»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2" Style="background: linear-gradient(45deg, #fff3cd, #ffeaa7);">
                <MudCardContent Class="text-center">
                    <MudIcon Icon="Icons.Material.Filled.Schedule" Color="Color.Warning" Size="Size.Large" />
                    <MudText Typo="Typo.h6" Class="mt-2">@subscriptions.Count(s => s.Status == SubscriptionStatus.Pending)</MudText>
                    <MudText Typo="Typo.body2">Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6" md="3">
            <MudCard Elevation="2" Style="background: linear-gradient(45deg, #f8d7da, #f5c6cb);">
                <MudCardContent Class="text-center">
                    <MudIcon Icon="Icons.Material.Filled.Warning" Color="Color.Error" Size="Size.Large" />
                    <MudText Typo="Typo.h6" Class="mt-2">@subscriptions.Count(s => s.Status == SubscriptionStatus.Overdue)</MudText>
                    <MudText Typo="Typo.body2">ÎšÎ±Î¸Ï…ÏƒÏ„ÎµÏÎ·Î¼Î­Î½ÎµÏ‚</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Revenue Summary -->
    <MudGrid Class="mb-6">
        <MudItem xs="12" sm="6">
            <MudCard Elevation="3">
                <MudCardContent>
                    <MudText Typo="Typo.h6" Class="mb-4">ğŸ’° ÎŸÎ¹ÎºÎ¿Î½Î¿Î¼Î¹ÎºÎ¬ Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î±</MudText>
                    @{
                        var totalAmount = subscriptions.Sum(s => s.Amount);
                        var paidAmountTotal = subscriptions.Sum(s => s.Payments.Where(p => p.Status == PaymentStatus.Confirmed).Sum(p => p.Amount));
                        var outstandingAmount = totalAmount - paidAmountTotal;
                    }
                    <MudText Typo="Typo.body1">
                        <strong>Î£Ï…Î½Î¿Î»Î¹ÎºÏŒ Î Î¿ÏƒÏŒ:</strong> â‚¬@totalAmount.ToString("N2")
                    </MudText>
                    <MudText Typo="Typo.body1" Class="mt-2">
                        <strong>Î•Î¹ÏƒÏ€ÏÎ±Ï‡Î¸Î­Î½ Î Î¿ÏƒÏŒ:</strong> â‚¬@paidAmountTotal.ToString("N2")
                    </MudText>
                    <MudText Typo="Typo.body1" Class="mt-2" Color="@(outstandingAmount > 0 ? Color.Error : Color.Success)">
                        <strong>Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿:</strong> â‚¬@outstandingAmount.ToString("N2")
                    </MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem xs="12" sm="6">
            <MudCard Elevation="3">
                <MudCardContent>
                    <MudText Typo="Typo.h6" Class="mb-4">ğŸ“Š Î Î¿ÏƒÎ¿ÏƒÏ„Î¬</MudText>
                    <div class="mb-3">
                        <MudText Typo="Typo.body2">Î Î»Î·ÏÏ‰Î¼Î­Î½ÎµÏ‚: @GetPaymentPercentage()%</MudText>
                        <MudProgressLinear Value="@GetPaymentPercentage()" Color="Color.Success" />
                    </div>
                    <div class="mb-3">
                        <MudText Typo="Typo.body2">Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚: @GetPendingPercentage()%</MudText>
                        <MudProgressLinear Value="@GetPendingPercentage()" Color="Color.Warning" />
                    </div>
                    <div>
                        <MudText Typo="Typo.body2">ÎšÎ±Î¸Ï…ÏƒÏ„ÎµÏÎ·Î¼Î­Î½ÎµÏ‚: @GetOverduePercentage()%</MudText>
                        <MudProgressLinear Value="@GetOverduePercentage()" Color="Color.Error" />
                    </div>
                </MudCardContent>
            </MudCard>
        </MudItem>
    </MudGrid>

    <!-- Subscriptions Table -->
    <MudCard Elevation="3">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Î£Ï…Î½Î´ÏÎ¿Î¼Î­Ï‚</MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudChipSet T="string">
                    <MudChip T="string" Text="ÎŒÎ»ÎµÏ‚" Color="@(selectedStatus == null ? Color.Primary : Color.Default)"
                             OnClick="() => FilterByStatus(null)" />
                    <MudChip T="string" Text="Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚" Color="@(selectedStatus == SubscriptionStatus.Pending ? Color.Warning : Color.Default)"
                             OnClick="() => FilterByStatus(SubscriptionStatus.Pending)" />
                    <MudChip T="string" Text="ÎšÎ±Î¸Ï…ÏƒÏ„ÎµÏÎ·Î¼Î­Î½ÎµÏ‚" Color="@(selectedStatus == SubscriptionStatus.Overdue ? Color.Error : Color.Default)"
                             OnClick="() => FilterByStatus(SubscriptionStatus.Overdue)" />
                </MudChipSet>
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent Class="pa-0">
            <MudDataGrid T="Subscription" Items="@filteredSubscriptions" Filterable="false" SortMode="@SortMode.Multiple"
                         Loading="@loading" LoadingProgressColor="Color.Info" Hover="true"
                         RowsPerPage="15" Elevation="0">
                <Columns>
                    <PropertyColumn Property="x => x.Id" Title="ID" />
                    <TemplateColumn Title="ÎœÎ­Î»Î¿Ï‚">
                        <CellTemplate>
                            <div class="d-flex align-center">
                                <MudAvatar Size="Size.Small" Color="Color.Primary" Class="mr-3">
                                    @context.Item.Member.FirstName.Substring(0, 1)@context.Item.Member.LastName.Substring(0, 1)
                                </MudAvatar>
                                <div>
                                    <MudText Typo="Typo.body2">@context.Item.Member.FirstName @context.Item.Member.LastName</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">@context.Item.Member.MemberNumber</MudText>
                                </div>
                            </div>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Î¤Î¼Î®Î¼Î±">
                        <CellTemplate>
                            <MudText Typo="Typo.body2">@(context.Item.Member.Department?.Name ?? "-")</MudText>
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.Year" Title="ÎˆÏ„Î¿Ï‚" />
                    <PropertyColumn Property="x => x.Month" Title="ÎœÎ®Î½Î±Ï‚">
                        <CellTemplate>
                            @GetMonthName(context.Item.Month)
                        </CellTemplate>
                    </PropertyColumn>
                    <TemplateColumn Title="Î Î¿ÏƒÏŒ / Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿">
                        <CellTemplate>
                            @{
                                var paidAmount = context.Item.Payments.Where(p => p.Status == PaymentStatus.Confirmed).Sum(p => p.Amount);
                                var remainingAmount = context.Item.Amount - paidAmount;
                            }
                            <div>
                                <MudText Typo="Typo.body2" Style="font-weight: 600;">â‚¬@context.Item.Amount.ToString("N2")</MudText>
                                @if (paidAmount > 0)
                                {
                                    <MudText Typo="Typo.caption" Color="@(remainingAmount > 0 ? Color.Warning : Color.Success)">
                                        Î Î»Î·ÏÏÎ¸Î·ÎºÎµ: â‚¬@paidAmount.ToString("N2")
                                        @if (remainingAmount > 0)
                                        {
                                            <br />
                                            <span>Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: â‚¬@remainingAmount.ToString("N2")</span>
                                        }
                                    </MudText>
                                }
                            </div>
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.DueDate" Title="ÎšÎ±Ï„Î±Î»Î·ÎºÏ„Î¹ÎºÎ®" Format="dd/MM/yyyy">
                        <CellTemplate>
                            <div class="d-flex align-center">
                                @if (context.Item.DueDate < DateTime.Now && context.Item.Status != SubscriptionStatus.Paid)
                                {
                                    <MudIcon Icon="Icons.Material.Filled.Warning" Color="Color.Error" Size="Size.Small" Class="mr-1" />
                                }
                                <MudText Typo="Typo.body2">@context.Item.DueDate.ToString("dd/MM/yyyy")</MudText>
                            </div>
                        </CellTemplate>
                    </PropertyColumn>
                    <TemplateColumn Title="ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·">
                        <CellTemplate>
                            @{
                                var paidAmt = context.Item.Payments.Where(p => p.Status == PaymentStatus.Confirmed).Sum(p => p.Amount);
                                var isPartiallyPaid = paidAmt > 0 && paidAmt < context.Item.Amount;
                            }
                            @if (isPartiallyPaid)
                            {
                                <MudChip Size="Size.Small" Color="Color.Info"
                                         Icon="@Icons.Material.Filled.PendingActions">
                                    ÎœÎµÏÎ¹ÎºÏÏ‚ Î Î»Î·ÏÏ‰Î¼Î­Î½Î·
                                </MudChip>
                            }
                            else
                            {
                                <MudChip Size="Size.Small" Color="@GetStatusColor(context.Item.Status)"
                                         Icon="@GetStatusIcon(context.Item.Status)">
                                    @GetStatusText(context.Item.Status)
                                </MudChip>
                            }
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Î Î»Î·ÏÏ‰Î¼Î­Ï‚">
                        <CellTemplate>
                            @if (context.Item.Payments.Any())
                            {
                                <MudTooltip Text="@string.Join(", ", context.Item.Payments.Select(p => $"â‚¬{p.Amount:N2} ({p.PaymentDate:dd/MM})"))">
                                    <MudChip Size="Size.Small" Color="Color.Success">
                                        @context.Item.Payments.Count Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚
                                    </MudChip>
                                </MudTooltip>
                            }
                            else
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">ÎšÎ±Î¼Î¯Î± Ï€Î»Î·ÏÏ‰Î¼Î®</MudText>
                            }
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚" CellClass="d-flex justify-end">
                        <CellTemplate>
                            <MudButtonGroup Variant="Variant.Text" Size="Size.Small">
                                @if (context.Item.Status == SubscriptionStatus.Pending)
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Payment" Color="Color.Success"
                                                   OnClick="() => MarkAsPaid(context.Item)"
                                                   Title="Î£Î®Î¼Î±Î½ÏƒÎ· Ï‰Ï‚ Î Î»Î·ÏÏ‰Î¼Î­Î½Î·" />
                                }
                                <MudIconButton Icon="@Icons.Material.Filled.Email" Color="Color.Info"
                                               OnClick="() => SendReminder(context.Item)"
                                               Title="Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î¥Ï€ÎµÎ½Î¸ÏÎ¼Î¹ÏƒÎ·Ï‚" />
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" Color="Color.Primary"
                                               OnClick="() => EditSubscription(context.Item)"
                                               Title="Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±" />
                            </MudButtonGroup>
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
                <PagerContent>
                    <MudDataGridPager T="Subscription" />
                </PagerContent>
            </MudDataGrid>
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private bool loading = true;
    private int selectedYear = DateTime.Now.Year;
    private int? selectedMonth = DateTime.Now.Month;
    private SubscriptionStatus? selectedStatus;
    private string memberSearch = "";
    private int selectedDepartmentId = 0;

    private List<int> availableYears = new();
    private List<Subscription> subscriptions = new();
    private List<Department> departments = new();
    private List<int> allowedDepartmentIds = new();
    private bool shouldFilterByDepartment = false;

    private IEnumerable<Subscription> filteredSubscriptions =>
        subscriptions.Where(s =>
            (string.IsNullOrWhiteSpace(memberSearch) ||
             s.Member.FirstName.Contains(memberSearch, StringComparison.OrdinalIgnoreCase) ||
             s.Member.LastName.Contains(memberSearch, StringComparison.OrdinalIgnoreCase) ||
             s.Member.MemberNumber.Contains(memberSearch, StringComparison.OrdinalIgnoreCase)) &&
            (selectedDepartmentId == 0 || s.Member.DepartmentId == selectedDepartmentId));

    protected override async Task OnInitializedAsync()
    {
        // Î‘ÏÏ‡Î¹ÎºÎ¿Ï€Î¿Î¯Î·ÏƒÎ· Î»Î¯ÏƒÏ„Î±Ï‚ ÎµÏ„ÏÎ½ (Ï„ÏÎ­Ï‡Î¿Î½ Î­Ï„Î¿Ï‚ Â± 2)
        var currentYear = DateTime.Now.Year;
        availableYears = new List<int>();
        for (int year = currentYear - 2; year <= currentYear + 1; year++)
        {
            availableYears.Add(year);
        }

        // Check user role - only Admin/Owner see everything
        var currentUser = await SessionService.GetCurrentUserAsync();
        bool isAdminOrOwner = currentUser != null &&
            (currentUser.Role == UserRole.Admin || currentUser.Role == UserRole.Owner);
        shouldFilterByDepartment = currentUser != null && !isAdminOrOwner;

        // Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½ Î³Î¹Î± Ï„Î¿ dropdown
        using var context = ContextFactory.CreateDbContext();

        // Load allowed departments for non-Admin/Owner users
        if (shouldFilterByDepartment)
        {
            allowedDepartmentIds = await context.UserDepartments
                .Where(ud => ud.UserId == currentUser!.Id)
                .Select(ud => ud.DepartmentId)
                .ToListAsync();
        }

        // Filter departments dropdown for non-Admin/Owner users
        var departmentsQuery = context.Departments.Where(d => d.IsActive);

        if (shouldFilterByDepartment)
        {
            if (allowedDepartmentIds.Any())
            {
                departmentsQuery = departmentsQuery.Where(d => allowedDepartmentIds.Contains(d.Id));
            }
            else
            {
                departmentsQuery = departmentsQuery.Where(d => false); // No departments = empty list
            }
        }

        departments = await departmentsQuery.OrderBy(d => d.Name).ToListAsync();

        await LoadSubscriptions();
    }

    private async Task LoadSubscriptions()
    {
        loading = true;
        try
        {
            // Î ÏÏÏ„Î± ÎµÎ½Î·Î¼ÎµÏÏÎ½Î¿Ï…Î¼Îµ Ï„Î¹Ï‚ ÎºÎ±Ï„Î±ÏƒÏ„Î¬ÏƒÎµÎ¹Ï‚ Ï„Ï‰Î½ ÏƒÏ…Î½Î´ÏÎ¿Î¼ÏÎ½ (ÎºÎ±Î¸Ï…ÏƒÏ„ÎµÏÎ·Î¼Î­Î½ÎµÏ‚ ÎºÎ»Ï€)
            await SubscriptionService.AutoUpdateSubscriptionStatusesAsync();

            using var context = ContextFactory.CreateDbContext();
            var query = context.Subscriptions
                .Include(s => s.Member)
                    .ThenInclude(m => m.Department)
                .Include(s => s.Payments)
                .Where(s => s.Year == selectedYear);

            // Filter by member's department (for non-Admin/Owner users)
            if (shouldFilterByDepartment)
            {
                query = query.Where(s => s.Member.DepartmentId.HasValue &&
                    allowedDepartmentIds.Contains(s.Member.DepartmentId.Value));
            }

            if (selectedMonth.HasValue)
                query = query.Where(s => s.Month == selectedMonth.Value);

            if (selectedStatus.HasValue)
                query = query.Where(s => s.Status == selectedStatus.Value);

            subscriptions = await query
                .OrderBy(s => s.Month)
                .ThenBy(s => s.Member.LastName)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· ÏƒÏ…Î½Î´ÏÎ¿Î¼ÏÎ½: {ex.Message}", Severity.Error);
            subscriptions = new List<Subscription>();
        }
        finally
        {
            loading = false;
        }
    }

    private async Task FilterByStatus(SubscriptionStatus? status)
    {
        selectedStatus = status;
        await LoadSubscriptions();
    }

    private async Task ShowGenerateSubscriptionsDialog()
    {
        var currentDate = DateTime.Now;
        var dialogParameters = new DialogParameters
        {
            { "Year", currentDate.Year },
            { "Month", currentDate.Month }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<GenerateSubscriptionsDialog>(
            "Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î£Ï…Î½Î´ÏÎ¿Î¼ÏÎ½",
            dialogParameters,
            options);

        var result = await dialog.Result;
        if (result is not null && !result.Canceled && result.Data is GenerateSubscriptionsResult generateResult)
        {
            await GenerateSubscriptions(generateResult.Year, generateResult.Month);
        }
    }

    private async Task GenerateSubscriptions(int year, int month)
    {
        try
        {
            var count = await SubscriptionService.GenerateMonthlySubscriptionsAsync(year, month);
            Snackbar.Add($"Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î®Î¸Î·ÎºÎ±Î½ {count} ÏƒÏ…Î½Î´ÏÎ¿Î¼Î­Ï‚ Î³Î¹Î± {GetMonthName(month)} {year}!", Severity.Success);
            await LoadSubscriptions();
        }
        catch (InvalidOperationException ex) when (ex.Message.Contains("already exist"))
        {
            Snackbar.Add($"ÎŸÎ¹ ÏƒÏ…Î½Î´ÏÎ¿Î¼Î­Ï‚ Î³Î¹Î± {GetMonthName(month)} {year} Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î®Î´Î·!", Severity.Warning);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÏƒÏ…Î½Î´ÏÎ¿Î¼ÏÎ½: {ex.Message}", Severity.Error);
        }
    }

    private async Task SendPaymentReminders()
    {
        var overdueCount = subscriptions.Count(s => s.Status == SubscriptionStatus.Overdue);
        var pendingCount = subscriptions.Count(s => s.Status == SubscriptionStatus.Pending);

        var result = await DialogService.ShowMessageBox(
            "Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î® Î¥Ï€ÎµÎ½Î¸Ï…Î¼Î¯ÏƒÎµÏ‰Î½",
            $"Î˜Î± ÏƒÏ„Î±Î»Î¿ÏÎ½ Ï…Ï€ÎµÎ½Î¸Ï…Î¼Î¯ÏƒÎµÎ¹Ï‚ ÏƒÎµ {pendingCount} Î±Î¸Î»Î·Ï„Î­Ï‚/Î¼Î­Î»Î· Î¼Îµ ÎµÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚ ÏƒÏ…Î½Î´ÏÎ¿Î¼Î­Ï‚ ÎºÎ±Î¹ {overdueCount} Î¼Îµ ÎºÎ±Î¸Ï…ÏƒÏ„ÎµÏÎ·Î¼Î­Î½ÎµÏ‚. Î£Ï…Î½Î­Ï‡ÎµÎ¹Î±;",
            yesText: "Î‘Ï€Î¿ÏƒÏ„Î¿Î»Î®", cancelText: "Î‘ÎºÏÏÏ‰ÏƒÎ·");

        if (result == true)
        {
            Snackbar.Add($"Î£Ï„Î¬Î»Î¸Î·ÎºÎ±Î½ Ï…Ï€ÎµÎ½Î¸Ï…Î¼Î¯ÏƒÎµÎ¹Ï‚ ÏƒÎµ {pendingCount + overdueCount} Î±Î¸Î»Î·Ï„Î­Ï‚/Î¼Î­Î»Î·!", Severity.Success);
        }
    }

    private async Task MarkAsPaid(Subscription subscription)
    {
        try
        {
            using var context = ContextFactory.CreateDbContext();

            subscription.Status = SubscriptionStatus.Paid;
            context.Subscriptions.Update(subscription);
            await context.SaveChangesAsync();

            Snackbar.Add("Î— ÏƒÏ…Î½Î´ÏÎ¿Î¼Î® ÏƒÎ·Î¼Î¬Î½Î¸Î·ÎºÎµ Ï‰Ï‚ Ï€Î»Î·ÏÏ‰Î¼Î­Î½Î·!", Severity.Success);
            await LoadSubscriptions();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î±: {ex.Message}", Severity.Error);
        }
    }

    private async Task SendReminder(Subscription subscription)
    {
        try
        {
            if (string.IsNullOrEmpty(subscription.Member.Email))
            {
                Snackbar.Add($"Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ email Î³Î¹Î± Ï„Î¿Î½/Ï„Î·Î½ {subscription.Member.FirstName} {subscription.Member.LastName}", Severity.Warning);
                return;
            }

            var subject = $"Î¥Ï€ÎµÎ½Î¸ÏÎ¼Î¹ÏƒÎ· Î£Ï…Î½Î´ÏÎ¿Î¼Î®Ï‚ - {GetMonthName(subscription.Month)} {subscription.Year}";
            var body = $@"
                <h3>Î‘Î³Î±Ï€Î·Ï„Î­/Î® {subscription.Member.FirstName} {subscription.Member.LastName},</h3>
                <p>Î£Î±Ï‚ Ï…Ï€ÎµÎ½Î¸Ï…Î¼Î¯Î¶Î¿Ï…Î¼Îµ ÏŒÏ„Î¹ Î· ÏƒÏ…Î½Î´ÏÎ¿Î¼Î® ÏƒÎ±Ï‚ Î³Î¹Î± Ï„Î¿Î½ Î¼Î®Î½Î± <strong>{GetMonthName(subscription.Month)} {subscription.Year}</strong>
                Ï€Î±ÏÎ±Î¼Î­Î½ÎµÎ¹ Î±Î½ÎµÎ¾ÏŒÏ†Î»Î·Ï„Î·.</p>

                <p><strong>Î£Ï„Î¿Î¹Ï‡ÎµÎ¯Î± Î£Ï…Î½Î´ÏÎ¿Î¼Î®Ï‚:</strong></p>
                <ul>
                    <li>Î Î¿ÏƒÏŒ: â‚¬{subscription.Amount:N2}</li>
                    <li>ÎšÎ±Ï„Î±Î»Î·ÎºÏ„Î¹ÎºÎ® Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±: {subscription.DueDate:dd/MM/yyyy}</li>
                    <li>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·: {GetStatusText(subscription.Status)}</li>
                </ul>

                <p>Î Î±ÏÎ±ÎºÎ±Î»Î¿ÏÎ¼Îµ Ï€ÏÎ¿Î²ÎµÎ¯Ï„Îµ ÏƒÏ„Î·Î½ ÎµÎ¾ÏŒÏ†Î»Î·ÏƒÎ· Ï„Î¿ ÏƒÏ…Î½Ï„Î¿Î¼ÏŒÏ„ÎµÏÎ¿ Î´Ï…Î½Î±Ï„ÏŒ.</p>

                <p>ÎœÎµ ÎµÎºÏ„Î¯Î¼Î·ÏƒÎ·,<br>Î— Î”Î¹Î¿Î¯ÎºÎ·ÏƒÎ·</p>
            ";

            var (success, message) = await EmailService.SendEmailAsync(subscription.Member.Email, subject, body);

            if (success)
            {
                Snackbar.Add($"Î£Ï„Î¬Î»Î¸Î·ÎºÎµ Ï…Ï€ÎµÎ½Î¸ÏÎ¼Î¹ÏƒÎ· ÏƒÏ„Î¿Î½/ÏƒÏ„Î·Î½ {subscription.Member.FirstName} {subscription.Member.LastName}!", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Î‘Ï€Î¿Ï„Ï…Ï‡Î¯Î± Î±Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚ email: {message}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Î±Ï€Î¿ÏƒÏ„Î¿Î»Î® Ï…Ï€ÎµÎ½Î¸ÏÎ¼Î¹ÏƒÎ·Ï‚: {ex.Message}", Severity.Error);
        }
    }

    private async Task EditSubscription(Subscription subscription)
    {
        var parameters = new DialogParameters
        {
            { "Subscription", subscription }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Small,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<SubscriptionEditDialog>(
            "Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î£Ï…Î½Î´ÏÎ¿Î¼Î®Ï‚",
            parameters,
            options);

        var result = await dialog.Result;
        if (result is not null && !result.Canceled)
        {
            await LoadSubscriptions();
        }
    }

    private string GetMonthName(int month)
    {
        var monthNames = new[] { "", "Î™Î±Î½Î¿Ï…Î¬ÏÎ¹Î¿Ï‚", "Î¦ÎµÎ²ÏÎ¿Ï…Î¬ÏÎ¹Î¿Ï‚", "ÎœÎ¬ÏÏ„Î¹Î¿Ï‚", "Î‘Ï€ÏÎ¯Î»Î¹Î¿Ï‚", "ÎœÎ¬Î¹Î¿Ï‚", "Î™Î¿ÏÎ½Î¹Î¿Ï‚",
                                "Î™Î¿ÏÎ»Î¹Î¿Ï‚", "Î‘ÏÎ³Î¿Ï…ÏƒÏ„Î¿Ï‚", "Î£ÎµÏ€Ï„Î­Î¼Î²ÏÎ¹Î¿Ï‚", "ÎŸÎºÏ„ÏÎ²ÏÎ¹Î¿Ï‚", "ÎÎ¿Î­Î¼Î²ÏÎ¹Î¿Ï‚", "Î”ÎµÎºÎ­Î¼Î²ÏÎ¹Î¿Ï‚" };
        return month >= 1 && month <= 12 ? monthNames[month] : month.ToString();
    }

    private Color GetStatusColor(SubscriptionStatus status)
    {
        return status switch
        {
            SubscriptionStatus.Paid => Color.Success,
            SubscriptionStatus.Pending => Color.Warning,
            SubscriptionStatus.Overdue => Color.Error,
            _ => Color.Default
        };
    }

    private string GetStatusIcon(SubscriptionStatus status)
    {
        return status switch
        {
            SubscriptionStatus.Paid => Icons.Material.Filled.CheckCircle,
            SubscriptionStatus.Pending => Icons.Material.Filled.Schedule,
            SubscriptionStatus.Overdue => Icons.Material.Filled.Warning,
            _ => Icons.Material.Filled.Help
        };
    }

    private string GetStatusText(SubscriptionStatus status)
    {
        return status switch
        {
            SubscriptionStatus.Paid => "Î Î»Î·ÏÏ‰Î¼Î­Î½Î·",
            SubscriptionStatus.Pending => "Î•ÎºÎºÏÎµÎ¼Î®Ï‚",
            SubscriptionStatus.Overdue => "ÎšÎ±Î¸Ï…ÏƒÏ„ÎµÏÎ·Î¼Î­Î½Î·",
            _ => status.ToString()
        };
    }

    private double GetPaymentPercentage()
    {
        if (!subscriptions.Any()) return 0;
        return Math.Round((double)subscriptions.Count(s => s.Status == SubscriptionStatus.Paid) / subscriptions.Count * 100, 1);
    }

    private double GetPendingPercentage()
    {
        if (!subscriptions.Any()) return 0;
        return Math.Round((double)subscriptions.Count(s => s.Status == SubscriptionStatus.Pending) / subscriptions.Count * 100, 1);
    }

    private double GetOverduePercentage()
    {
        if (!subscriptions.Any()) return 0;
        return Math.Round((double)subscriptions.Count(s => s.Status == SubscriptionStatus.Overdue) / subscriptions.Count * 100, 1);
    }
}