@page "/expenses"
@using Microsoft.AspNetCore.Authorization
@using MembersHub.Core.Entities
@using MembersHub.Core.Interfaces
@using MembersHub.Web.Components.Dialogs
@attribute [Authorize]
@using MudBlazor
@inject IExpenseService ExpenseService
@inject IExpenseCategoryService ExpenseCategoryService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject ISessionService SessionService

<PageTitle>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î•Î¾ÏŒÎ´Ï‰Î½ - MembersHub</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Color="Color.Primary">
        ğŸ’³ Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î•Î¾ÏŒÎ´Ï‰Î½
    </MudText>

    <MudPaper Class="pa-4 mt-4" Elevation="2">
        <!-- Header Î¼Îµ ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ ÎºÎ±Î¹ ÎºÎ¿Ï…Î¼Ï€Î¯ Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ·Ï‚ -->
        <div class="d-flex flex-column flex-sm-row justify-space-between align-center mb-4 gap-3">
            <div class="d-flex flex-wrap gap-2 justify-center">
                <MudBadge Content="@pendingCount" Color="Color.Warning" Overlap="true">
                    <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.HourglassEmpty">
                        Î•ÎºÎºÏÎµÎ¼Î®
                    </MudButton>
                </MudBadge>
                <MudBadge Content="@approvedCount" Color="Color.Success" Overlap="true">
                    <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.CheckCircle">
                        Î•Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î±
                    </MudButton>
                </MudBadge>
                <MudBadge Content="@rejectedCount" Color="Color.Error" Overlap="true">
                    <MudButton Variant="Variant.Outlined" StartIcon="@Icons.Material.Filled.Cancel">
                        Î‘Ï€Î¿ÏÏÎ¹Ï†Î¸Î­Î½Ï„Î±
                    </MudButton>
                </MudBadge>
            </div>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="@OpenCreateDialog">
                ÎÎ­Î¿ ÎˆÎ¾Î¿Î´Î¿
            </MudButton>
        </div>

        <!-- Search ÎºÎ±Î¹ Filters -->
        <div class="d-flex flex-column flex-md-row gap-3 mb-4">
            <MudTextField @bind-Value="searchString"
                          Label="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·..."
                          Variant="Variant.Outlined"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Class="flex-grow-1" />

            <MudSelect @bind-Value="selectedCategoryId"
                       Label="ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±"
                       Variant="Variant.Outlined"
                       Clearable="true">
                <MudSelectItem T="int?" Value="@((int?)null)">ÎŒÎ»ÎµÏ‚</MudSelectItem>
                @foreach (var category in categories)
                {
                    <MudSelectItem T="int?" Value="@category.Id">
                        @category.Name
                    </MudSelectItem>
                }
            </MudSelect>

            <MudSelect @bind-Value="selectedStatus"
                       Label="ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·"
                       Variant="Variant.Outlined"
                       Clearable="true">
                <MudSelectItem T="ExpenseStatus?" Value="@((ExpenseStatus?)null)">ÎŒÎ»ÎµÏ‚</MudSelectItem>
                <MudSelectItem T="ExpenseStatus?" Value="@ExpenseStatus.Pending">Î•ÎºÎºÏÎµÎ¼Î­Ï‚</MudSelectItem>
                <MudSelectItem T="ExpenseStatus?" Value="@ExpenseStatus.Approved">Î•Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿</MudSelectItem>
                <MudSelectItem T="ExpenseStatus?" Value="@ExpenseStatus.Rejected">Î‘Ï€Î¿ÏÏÎ¹Ï†Î¸Î­Î½</MudSelectItem>
                <MudSelectItem T="ExpenseStatus?" Value="@ExpenseStatus.Reimbursed">Î‘Ï€Î¿Î¶Î·Î¼Î¹Ï‰Î¼Î­Î½Î¿</MudSelectItem>
            </MudSelect>
        </div>

        <!-- Desktop DataGrid -->
        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <MudDataGrid Items="@filteredExpenses"
                         Dense="true"
                         Hover="true"
                         Bordered="true"
                         Striped="true"
                         Loading="@loading"
                         LoadingProgressColor="Color.Primary">
                <Columns>
                    <PropertyColumn Property="x => x.ExpenseNumber" Title="Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚" />
                    <PropertyColumn Property="x => x.Date" Title="Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±" Format="dd/MM/yyyy" />
                    <TemplateColumn Title="ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±">
                        <CellTemplate>
                            @(context.Item.Category?.Name ?? "Î”ÎµÎ½ ÎºÎ±Î¸Î¿ÏÎ¯ÏƒÏ„Î·ÎºÎµ")
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.Amount" Title="Î Î¿ÏƒÏŒ" Format="C2" />
                    <PropertyColumn Property="x => x.Description" Title="Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®" />
                    <PropertyColumn Property="x => x.Submitter.FullName" Title="Î¥Ï€Î¿Î²Î»Î®Î¸Î·ÎºÎµ Î±Ï€ÏŒ" />
                    <TemplateColumn Title="ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·">
                        <CellTemplate>
                            <MudChip T="string" Size="Size.Small"
                                     Color="@GetStatusColor(context.Item.Status)">
                                @GetStatusText(context.Item.Status)
                            </MudChip>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚" Sortable="false">
                        <CellTemplate>
                            <div class="d-flex gap-2">
                                @if (context.Item.Status == ExpenseStatus.Pending && CanEdit(context.Item))
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                   Size="Size.Small"
                                                   Color="Color.Primary"
                                                   Variant="Variant.Filled"
                                                   OnClick="() => EditExpense(context.Item)"
                                                   title="Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±" />
                                }
                                @if (context.Item.Status == ExpenseStatus.Pending && CanApprove())
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Check"
                                                   Size="Size.Small"
                                                   Color="Color.Success"
                                                   Variant="Variant.Filled"
                                                   OnClick="() => ApproveExpense(context.Item)"
                                                   title="ÎˆÎ³ÎºÏÎ¹ÏƒÎ·" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Close"
                                                   Size="Size.Small"
                                                   Color="Color.Error"
                                                   Variant="Variant.Filled"
                                                   OnClick="() => RejectExpense(context.Item)"
                                                   title="Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ·" />
                                }
                                @if (context.Item.Status == ExpenseStatus.Pending && CanDelete(context.Item))
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                   Size="Size.Small"
                                                   Color="Color.Error"
                                                   Variant="Variant.Filled"
                                                   OnClick="() => DeleteExpense(context.Item)"
                                                   title="Î”Î¹Î±Î³ÏÎ±Ï†Î®" />
                                }
                            </div>
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
            </MudDataGrid>
        </MudHidden>

        <!-- Mobile Cards -->
        <MudHidden Breakpoint="Breakpoint.MdAndUp">
            <MudGrid>
                @foreach (var expense in filteredExpenses)
                {
                    <MudItem xs="12">
                        <MudCard Class="mb-3">
                            <MudCardContent>
                                <div class="d-flex justify-space-between align-center mb-2">
                                    <MudText Typo="Typo.h6">@expense.ExpenseNumber</MudText>
                                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(expense.Status)">
                                        @GetStatusText(expense.Status)
                                    </MudChip>
                                </div>
                                <MudText Typo="Typo.body2" Class="mb-1">
                                    <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Small" /> @expense.Date.ToString("dd/MM/yyyy")
                                </MudText>
                                <MudText Typo="Typo.body2" Class="mb-1">
                                    <MudIcon Icon="@Icons.Material.Filled.Category" Size="Size.Small" /> @(expense.Category?.Name ?? "Î”ÎµÎ½ ÎºÎ±Î¸Î¿ÏÎ¯ÏƒÏ„Î·ÎºÎµ")
                                </MudText>
                                <MudText Typo="Typo.body2" Class="mb-1" Color="Color.Primary">
                                    <MudIcon Icon="@Icons.Material.Filled.Euro" Size="Size.Small" /> â‚¬@expense.Amount.ToString("N2")
                                </MudText>
                                <MudText Typo="Typo.body2" Class="mb-1">
                                    @expense.Description
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Default">
                                    Î¥Ï€Î¿Î²Î»Î®Î¸Î·ÎºÎµ Î±Ï€ÏŒ: @expense.Submitter.FullName
                                </MudText>
                            </MudCardContent>
                            <MudCardActions>
                                @if (expense.Status == ExpenseStatus.Pending && CanEdit(expense))
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                   Size="Size.Small"
                                                   Color="Color.Primary"
                                                   OnClick="() => EditExpense(expense)" />
                                }
                                @if (expense.Status == ExpenseStatus.Pending && CanApprove())
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Check"
                                                   Size="Size.Small"
                                                   Color="Color.Success"
                                                   OnClick="() => ApproveExpense(expense)" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Close"
                                                   Size="Size.Small"
                                                   Color="Color.Error"
                                                   OnClick="() => RejectExpense(expense)" />
                                }
                                @if (expense.Status == ExpenseStatus.Pending && CanDelete(expense))
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                   Size="Size.Small"
                                                   Color="Color.Error"
                                                   OnClick="() => DeleteExpense(expense)" />
                                }
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        </MudHidden>

        @if (!filteredExpenses.Any() && !loading)
        {
            <div class="text-center pa-8">
                <MudIcon Icon="@Icons.Material.Filled.ReceiptLong" Size="Size.Large" Color="Color.Default" />
                <MudText Typo="Typo.h6" Color="Color.Default" Class="mt-2">
                    Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î­Î¾Î¿Î´Î± Î¼Îµ Î±Ï…Ï„Î¬ Ï„Î± ÎºÏÎ¹Ï„Î®ÏÎ¹Î±
                </MudText>
            </div>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<Expense> expenses = new();
    private List<ExpenseCategory> categories = new();
    private bool loading = true;
    private User? currentUser;

    private string searchString = "";
    private int? selectedCategoryId = null;
    private ExpenseStatus? selectedStatus = null;

    private int pendingCount => expenses.Count(e => e.Status == ExpenseStatus.Pending);
    private int approvedCount => expenses.Count(e => e.Status == ExpenseStatus.Approved);
    private int rejectedCount => expenses.Count(e => e.Status == ExpenseStatus.Rejected);

    private IEnumerable<Expense> filteredExpenses => expenses.Where(e =>
        (string.IsNullOrWhiteSpace(searchString) ||
         e.ExpenseNumber.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
         e.Description.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
         (e.Vendor?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false)) &&
        (selectedCategoryId == null || e.ExpenseCategoryId == selectedCategoryId) &&
        (selectedStatus == null || e.Status == selectedStatus)
    ).OrderByDescending(e => e.Date);

    protected override async Task OnInitializedAsync()
    {
        currentUser = await SessionService.GetCurrentUserAsync();
        categories = await ExpenseCategoryService.GetAllCategoriesAsync();
        await LoadData();
    }

    private async Task LoadData()
    {
        loading = true;
        try
        {
            if (currentUser == null) return;

            // Collectors see only their own expenses, Admins/Treasurers see all
            if (CanApprove())
            {
                expenses = await ExpenseService.GetExpensesByStatusAsync(ExpenseStatus.Pending);
                var approved = await ExpenseService.GetExpensesByStatusAsync(ExpenseStatus.Approved);
                var rejected = await ExpenseService.GetExpensesByStatusAsync(ExpenseStatus.Rejected);
                var reimbursed = await ExpenseService.GetExpensesByStatusAsync(ExpenseStatus.Reimbursed);
                expenses = expenses.Concat(approved).Concat(rejected).Concat(reimbursed).ToList();
            }
            else
            {
                expenses = await ExpenseService.GetExpensesByUserAsync(currentUser.Id);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task OpenCreateDialog()
    {
        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ExpenseDialog>("ÎÎ­Î¿ ÎˆÎ¾Î¿Î´Î¿", options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            await LoadData();
        }
    }

    private async Task EditExpense(Expense expense)
    {
        var parameters = new DialogParameters<ExpenseDialog>
        {
            { x => x.ExistingExpense, expense }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ExpenseDialog>($"Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î•Î¾ÏŒÎ´Î¿Ï… - {expense.ExpenseNumber}", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            await LoadData();
        }
    }

    private async Task ApproveExpense(Expense expense)
    {
        var result = await DialogService.ShowMessageBox(
            "ÎˆÎ³ÎºÏÎ¹ÏƒÎ· Î•Î¾ÏŒÎ´Î¿Ï…",
            $"Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± ÎµÎ³ÎºÏÎ¯Î½ÎµÏ„Îµ Ï„Î¿ Î­Î¾Î¿Î´Î¿ '{expense.ExpenseNumber}' Ï€Î¿ÏƒÎ¿Ï â‚¬{expense.Amount:N2};",
            yesText: "ÎˆÎ³ÎºÏÎ¹ÏƒÎ·",
            cancelText: "Î†ÎºÏ…ÏÎ¿");

        if (result == true && currentUser != null)
        {
            try
            {
                await ExpenseService.ApproveExpenseAsync(expense.Id, currentUser.Id);
                Snackbar.Add($"Î¤Î¿ Î­Î¾Î¿Î´Î¿ {expense.ExpenseNumber} ÎµÎ³ÎºÏÎ¯Î¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚", Severity.Success);
                await LoadData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± Î­Î³ÎºÏÎ¹ÏƒÎ·Ï‚: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task RejectExpense(Expense expense)
    {
        // TODO: Add a dialog to enter rejection reason
        var reason = "Î‘Ï€Î¿ÏÏÎ¯Ï†Î¸Î·ÎºÎµ Î±Ï€ÏŒ Ï„Î¿Î½ Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®";

        if (currentUser != null)
        {
            try
            {
                await ExpenseService.RejectExpenseAsync(expense.Id, currentUser.Id, reason);
                Snackbar.Add($"Î¤Î¿ Î­Î¾Î¿Î´Î¿ {expense.ExpenseNumber} Î±Ï€Î¿ÏÏÎ¯Ï†Î¸Î·ÎºÎµ", Severity.Success);
                await LoadData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± Î±Ï€ÏŒÏÏÎ¹ÏˆÎ·Ï‚: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteExpense(Expense expense)
    {
        var result = await DialogService.ShowMessageBox(
            "Î”Î¹Î±Î³ÏÎ±Ï†Î® Î•Î¾ÏŒÎ´Î¿Ï…",
            $"Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Ï„Î¿ Î­Î¾Î¿Î´Î¿ '{expense.ExpenseNumber}';",
            yesText: "Î”Î¹Î±Î³ÏÎ±Ï†Î®",
            cancelText: "Î†ÎºÏ…ÏÎ¿");

        if (result == true)
        {
            try
            {
                await ExpenseService.DeleteExpenseAsync(expense.Id);
                Snackbar.Add($"Î¤Î¿ Î­Î¾Î¿Î´Î¿ {expense.ExpenseNumber} Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚", Severity.Success);
                await LoadData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚: {ex.Message}", Severity.Error);
            }
        }
    }

    private bool CanApprove()
    {
        return currentUser?.Role == UserRole.Admin ||
               currentUser?.Role == UserRole.Owner ||
               currentUser?.Role == UserRole.Treasurer;
    }

    private bool CanEdit(Expense expense)
    {
        return currentUser?.Id == expense.SubmittedBy;
    }

    private bool CanDelete(Expense expense)
    {
        return currentUser?.Id == expense.SubmittedBy || CanApprove();
    }

    private Color GetStatusColor(ExpenseStatus status) => status switch
    {
        ExpenseStatus.Pending => Color.Warning,
        ExpenseStatus.Approved => Color.Success,
        ExpenseStatus.Rejected => Color.Error,
        ExpenseStatus.Reimbursed => Color.Info,
        _ => Color.Default
    };

    private string GetStatusText(ExpenseStatus status) => status switch
    {
        ExpenseStatus.Pending => "Î•ÎºÎºÏÎµÎ¼Î­Ï‚",
        ExpenseStatus.Approved => "Î•Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿",
        ExpenseStatus.Rejected => "Î‘Ï€Î¿ÏÏÎ¹Ï†Î¸Î­Î½",
        ExpenseStatus.Reimbursed => "Î‘Ï€Î¿Î¶Î·Î¼Î¹Ï‰Î¼Î­Î½Î¿",
        _ => status.ToString()
    };
}
