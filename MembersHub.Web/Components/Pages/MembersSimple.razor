@page "/members-simple"
@using MembersHub.Core.Entities
@using MembersHub.Infrastructure.Data
@using MudBlazor
@using Microsoft.EntityFrameworkCore
@inject IServiceScopeFactory ScopeFactory
@inject ISnackbar Snackbar
@rendermode InteractiveServer

<PageTitle>Î‘Î¸Î»Î·Ï„Î­Ï‚/ÎœÎ­Î»Î· - MembersHub</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Color="Color.Primary" Class="mb-4">
        ğŸ‘¥ Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· ÎœÎµÎ»ÏÎ½
    </MudText>

    <MudPaper Class="pa-4" Elevation="2">
        @if (loading)
        {
            <div class="d-flex justify-center pa-4">
                <MudProgressCircular Indeterminate="true" />
                <MudText Class="ml-3">Î¦ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½...</MudText>
            </div>
        }
        else if (!members.Any())
        {
            <div class="text-center pa-8">
                <MudIcon Icon="Icons.Material.Filled.PersonOff" Size="Size.Large" />
                <MudText Typo="Typo.h6" Class="mt-2">
                    Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î±Î¸Î»Î·Ï„Î­Ï‚/Î¼Î­Î»Î· ÏƒÏ„Î· Î²Î¬ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Î±Î¸Î»Î·Ï„Î­Ï‚/Î¼Î­Î»Î· Î±Ï€ÏŒ Ï„Î· Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ·
                </MudText>
            </div>
        }
        else
        {
            <MudText Typo="Typo.h6" Class="mb-3">
                Î£ÏÎ½Î¿Î»Î¿ Î¼ÎµÎ»ÏÎ½: @members.Count | Î•Î½ÎµÏÎ³Î¬: @members.Count(m => m.Status == MemberStatus.Active)
            </MudText>
            
            <MudTable Items="@members" Hover="true" Striped="true" Dense="true" Class="thick-borders">
                <HeaderContent>
                    <MudTh>Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚</MudTh>
                    <MudTh>ÎŸÎ½Î¿Î¼Î±Ï„ÎµÏ€ÏÎ½Ï…Î¼Î¿</MudTh>
                    <MudTh>Î¤Î·Î»Î­Ï†Ï‰Î½Î¿</MudTh>
                    <MudTh>Email</MudTh>
                    <MudTh>Î¤ÏÏ€Î¿Ï‚</MudTh>
                    <MudTh>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚">@context.MemberNumber</MudTd>
                    <MudTd DataLabel="ÎŒÎ½Î¿Î¼Î±">@context.FullName</MudTd>
                    <MudTd DataLabel="Î¤Î·Î»Î­Ï†Ï‰Î½Î¿">@context.Phone</MudTd>
                    <MudTd DataLabel="Email">@(context.Email ?? "-")</MudTd>
                    <MudTd DataLabel="Î¤ÏÏ€Î¿Ï‚">@context.MembershipType?.Name</MudTd>
                    <MudTd DataLabel="ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·">
                        <MudText Color="@GetStatusColor(context.Status)">
                            @GetStatusText(context.Status)
                        </MudText>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<Member> members = new();
    private bool loading = true;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }
    
    private async Task LoadData()
    {
        loading = true;
        
        try
        {
            using var scope = ScopeFactory.CreateScope();
            var dbContext = scope.ServiceProvider.GetRequiredService<MembersHubContext>();
            
            members = await dbContext.Members
                .Include(m => m.MembershipType)
                .OrderBy(m => m.MemberNumber)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }
    
    private Color GetStatusColor(MemberStatus status) => status switch
    {
        MemberStatus.Active => Color.Success,
        MemberStatus.Inactive => Color.Default,
        MemberStatus.Suspended => Color.Warning,
        _ => Color.Default
    };
    
    private string GetStatusText(MemberStatus status) => status switch
    {
        MemberStatus.Active => "Î•Î½ÎµÏÎ³ÏŒ",
        MemberStatus.Inactive => "Î‘Î½ÎµÎ½ÎµÏÎ³ÏŒ",
        MemberStatus.Suspended => "Î‘Î½Î±ÏƒÏ„Î¿Î»Î®",
        _ => "Î†Î³Î½Ï‰ÏƒÏ„Î¿"
    };
}