@page "/collector-card"
@page "/collector-card/{UserId:int}"
@using MembersHub.Core.Entities
@using MembersHub.Core.Interfaces
@using MembersHub.Infrastructure.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using MembersHub.Application.Services
@inject IDbContextFactory<MembersHubContext> ContextFactory
@inject ICashierHandoverService HandoverService
@inject ISessionService SessionService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject TimeZoneService TimeZone
@attribute [Authorize(Roles = "Admin,Owner,Treasurer")]

<PageTitle>Î— ÎšÎ±ÏÏ„Î­Î»Î± Î¼Î¿Ï… - MembersHub</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    @if (loading)
    {
        <div class="d-flex justify-center pa-8">
            <MudProgressCircular Indeterminate="true" Size="Size.Large" />
        </div>
    }
    else if (collector != null)
    {
        <!-- Header -->
        <div class="d-flex justify-space-between align-center mb-6">
            <div>
                <MudText Typo="Typo.h4">ğŸ’¼ ÎŸÎ¹ÎºÎ¿Î½Î¿Î¼Î¹ÎºÎ® ÎšÎ±ÏÏ„Î­Î»Î±</MudText>
                <MudText Typo="Typo.subtitle1" Color="Color.Secondary">
                    @collector.FullName (@collector.Username)
                </MudText>
            </div>
            <div class="d-flex gap-4 align-center">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Success"
                           StartIcon="@Icons.Material.Filled.AccountBalanceWallet"
                           Href="/cashier-handover">
                    Î Î±ÏÎ¬Î´Î¿ÏƒÎ· Î¤Î±Î¼ÎµÎ¯Î¿Ï…
                </MudButton>
                <AuthorizeView Roles="Admin,Owner">
                    <Authorized>
                        @if (canSelectCollector)
                        {
                            <MudAutocomplete T="User"
                                             Value="collector"
                                             ValueChanged="OnCollectorChanged"
                                             SearchFunc="SearchCollectors"
                                             ToStringFunc="@(u => u?.FullName ?? "")"
                                             Label="Î•Ï€Î¹Î»Î¿Î³Î® Î•Î¹ÏƒÏ€ÏÎ¬ÎºÏ„Î¿ÏÎ±"
                                             Variant="Variant.Outlined"
                                             AdornmentIcon="@Icons.Material.Filled.Person"
                                             Style="min-width: 300px;" />
                        }
                    </Authorized>
                </AuthorizeView>
            </div>
        </div>

        <!-- Period Selection -->
        <MudPaper Class="pa-4 mb-6" Elevation="2">
            <MudGrid>
                <MudItem xs="12" sm="4">
                    <MudDatePicker Label="Î‘Ï€ÏŒ" Date="startDate" DateChanged="OnStartDateChanged" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudDatePicker Label="ÎˆÏ‰Ï‚" Date="endDate" DateChanged="OnEndDateChanged" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudSelect T="string" Label="Î“ÏÎ®Î³Î¿ÏÎ· ÎµÏ€Î¹Î»Î¿Î³Î®" Value="@selectedPeriod" ValueChanged="OnPeriodChanged">
                        <MudSelectItem Value="@("today")">Î£Î®Î¼ÎµÏÎ±</MudSelectItem>
                        <MudSelectItem Value="@("this_week")">Î‘Ï…Ï„Î® Ï„Î·Î½ ÎµÎ²Î´Î¿Î¼Î¬Î´Î±</MudSelectItem>
                        <MudSelectItem Value="@("this_month")">Î‘Ï…Ï„ÏŒÏ‚ Î¿ Î¼Î®Î½Î±Ï‚</MudSelectItem>
                        <MudSelectItem Value="@("last_month")">Î ÏÎ¿Î·Î³Î¿ÏÎ¼ÎµÎ½Î¿Ï‚ Î¼Î®Î½Î±Ï‚</MudSelectItem>
                    </MudSelect>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <!-- Summary Cards -->
        <MudGrid Class="mb-6">
            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="3" Style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <MudCardContent Class="text-center" Style="color: white;">
                        <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Large" Class="mb-2" />
                        <MudText Typo="Typo.h6">Î£Ï…Î½Î¿Î»Î¹ÎºÎ­Ï‚ Î•Î¹ÏƒÏ€ÏÎ¬Î¾ÎµÎ¹Ï‚</MudText>
                        <MudText Typo="Typo.h3">â‚¬@totalCollections.ToString("N2")</MudText>
                        <MudText Typo="Typo.caption">@paymentsCount Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="3" Style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <MudCardContent Class="text-center" Style="color: white;">
                        <MudIcon Icon="@Icons.Material.Filled.TrendingDown" Size="Size.Large" Class="mb-2" />
                        <MudText Typo="Typo.h6">Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÎˆÎ¾Î¿Î´Î±</MudText>
                        <MudText Typo="Typo.h3">â‚¬@totalExpenses.ToString("N2")</MudText>
                        <MudText Typo="Typo.caption">@expensesCount Î­Î¾Î¿Î´Î±</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="3" Style="@GetBalanceCardStyle()">
                    <MudCardContent Class="text-center" Style="color: white;">
                        <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Size="Size.Large" Class="mb-2" />
                        <MudText Typo="Typo.h6">Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿</MudText>
                        <MudText Typo="Typo.h3">â‚¬@balance.ToString("N2")</MudText>
                        <MudText Typo="Typo.caption">@GetBalanceDescription()</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" sm="6" md="3">
                <MudCard Elevation="3" Style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <MudCardContent Class="text-center" Style="color: white;">
                        <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Large" Class="mb-2" />
                        <MudText Typo="Typo.h6">Î Î±ÏÎ¬Î´Î¿ÏƒÎ· Î¤Î±Î¼ÎµÎ¯Î¿Ï…</MudText>
                        <MudText Typo="Typo.h5">@(lastDeliveryDate?.ToString("dd/MM/yyyy") ?? "Î Î¿Ï„Î­")</MudText>
                        <MudText Typo="Typo.caption">@GetDaysSinceDelivery()</MudText>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- Payments and Expenses Tables -->
        <MudGrid>
            <MudItem xs="12" lg="6">
                <MudCard Elevation="3">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">ğŸ’° Î•Î¹ÏƒÏ€ÏÎ¬Î¾ÎµÎ¹Ï‚</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudIconButton Icon="@Icons.Material.Filled.Add"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           Href="/payments/new" />
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent Class="pa-0">
                        @if (payments.Any())
                        {
                            <MudTable Items="@payments" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm">
                                <HeaderContent>
                                    <MudTh>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</MudTh>
                                    <MudTh>ÎœÎ­Î»Î¿Ï‚</MudTh>
                                    <MudTh Style="text-align: right;">Î Î¿ÏƒÏŒ</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±">@context.PaymentDate.ToString("dd/MM/yyyy")</MudTd>
                                    <MudTd DataLabel="ÎœÎ­Î»Î¿Ï‚">
                                        <MudText Typo="Typo.body2">@context.Member.FullName</MudText>
                                    </MudTd>
                                    <MudTd DataLabel="Î Î¿ÏƒÏŒ" Style="text-align: right;">
                                        <MudText Typo="Typo.body2" Color="Color.Success">
                                            <strong>â‚¬@context.Amount.ToString("N2")</strong>
                                        </MudText>
                                    </MudTd>
                                </RowTemplate>
                                <PagerContent>
                                    <MudTablePager PageSizeOptions="new int[] { 10, 25, 50 }" />
                                </PagerContent>
                            </MudTable>
                        }
                        else
                        {
                            <div class="text-center pa-8">
                                <MudIcon Icon="@Icons.Material.Filled.Receipt" Size="Size.Large" Color="Color.Default" />
                                <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mt-2">
                                    Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎ¹ÏƒÏ€ÏÎ¬Î¾ÎµÎ¹Ï‚ Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ Ï€ÎµÏÎ¯Î¿Î´Î¿
                                </MudText>
                            </div>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <MudItem xs="12" lg="6">
                <MudCard Elevation="3">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">ğŸ§¾ ÎˆÎ¾Î¿Î´Î±</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <MudIconButton Icon="@Icons.Material.Filled.Add"
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           Href="/expenses" />
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent Class="pa-0">
                        @if (expenses.Any())
                        {
                            <MudTable Items="@expenses" Dense="true" Hover="true" Breakpoint="Breakpoint.Sm">
                                <HeaderContent>
                                    <MudTh>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</MudTh>
                                    <MudTh>ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±</MudTh>
                                    <MudTh Style="text-align: right;">Î Î¿ÏƒÏŒ</MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±">@context.Date.ToString("dd/MM/yyyy")</MudTd>
                                    <MudTd DataLabel="ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±">
                                        <MudText Typo="Typo.body2">@(context.Category?.Name ?? "N/A")</MudText>
                                    </MudTd>
                                    <MudTd DataLabel="Î Î¿ÏƒÏŒ" Style="text-align: right;">
                                        <MudText Typo="Typo.body2" Color="Color.Error">
                                            <strong>â‚¬@context.Amount.ToString("N2")</strong>
                                        </MudText>
                                    </MudTd>
                                </RowTemplate>
                                <PagerContent>
                                    <MudTablePager PageSizeOptions="new int[] { 10, 25, 50 }" />
                                </PagerContent>
                            </MudTable>
                        }
                        else
                        {
                            <div class="text-center pa-8">
                                <MudIcon Icon="@Icons.Material.Filled.Receipt" Size="Size.Large" Color="Color.Default" />
                                <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mt-2">
                                    Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î­Î¾Î¿Î´Î± Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ Ï€ÎµÏÎ¯Î¿Î´Î¿
                                </MudText>
                            </div>
                        }
                    </MudCardContent>
                </MudCard>
            </MudItem>
        </MudGrid>

        <!-- Breakdown by Payment Method -->
        <MudCard Elevation="3" Class="mt-6">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">ğŸ’³ Î‘Î½Î¬Î»Ï…ÏƒÎ· Î¤ÏÏŒÏ€Ï‰Î½ Î Î»Î·ÏÏ‰Î¼Î®Ï‚</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @if (paymentsByMethod.Any())
                {
                    <MudGrid>
                        @foreach (var method in paymentsByMethod)
                        {
                            <MudItem xs="12" sm="6" md="3">
                                <MudPaper Class="pa-4 text-center" Elevation="1">
                                    <MudText Typo="Typo.body1" Color="Color.Primary">
                                        <strong>@GetPaymentMethodName(method.Key)</strong>
                                    </MudText>
                                    <MudText Typo="Typo.h5" Class="mt-2">â‚¬@method.Value.ToString("N2")</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @paymentMethodCounts[method.Key] Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚
                                    </MudText>
                                </MudPaper>
                            </MudItem>
                        }
                    </MudGrid>
                }
                else
                {
                    <div class="text-center pa-4">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÎµÎ¹ÏƒÏ€ÏÎ¬Î¾ÎµÎ¹Ï‚</MudText>
                    </div>
                }
            </MudCardContent>
        </MudCard>

        <!-- Breakdown by Expense Category -->
        <MudCard Elevation="3" Class="mt-6">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">ğŸ“‚ Î‘Î½Î¬Î»Ï…ÏƒÎ· ÎšÎ±Ï„Î·Î³Î¿ÏÎ¹ÏÎ½ Î•Î¾ÏŒÎ´Ï‰Î½</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                @if (expensesByCategory.Any())
                {
                    <MudGrid>
                        @foreach (var category in expensesByCategory)
                        {
                            <MudItem xs="12" sm="6" md="3">
                                <MudPaper Class="pa-4 text-center" Elevation="1">
                                    <MudText Typo="Typo.body1" Color="Color.Error">
                                        <strong>@category.Key</strong>
                                    </MudText>
                                    <MudText Typo="Typo.h5" Class="mt-2">â‚¬@category.Value.ToString("N2")</MudText>
                                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                                        @expenseCategoryCounts[category.Key] Î­Î¾Î¿Î´Î±
                                    </MudText>
                                </MudPaper>
                            </MudItem>
                        }
                    </MudGrid>
                }
                else
                {
                    <div class="text-center pa-4">
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Î­Î¾Î¿Î´Î±</MudText>
                    </div>
                }
            </MudCardContent>
        </MudCard>
    }
</MudContainer>

@code {
    [Parameter]
    public int? UserId { get; set; }

    private bool loading = true;
    private User? collector;
    private User? currentUser;
    private List<User> allCollectors = new();
    private bool canSelectCollector = false;

    // Date range
    private DateTime? startDate;
    private DateTime? endDate;
    private string selectedPeriod = "today";

    // Financial data
    private List<Payment> payments = new();
    private List<Expense> expenses = new();
    private decimal totalCollections = 0;
    private decimal totalExpenses = 0;
    private decimal balance = 0;
    private int paymentsCount = 0;
    private int expensesCount = 0;
    private DateTime? lastDeliveryDate;

    // Analytics
    private Dictionary<PaymentMethod, decimal> paymentsByMethod = new();
    private Dictionary<PaymentMethod, int> paymentMethodCounts = new();
    private Dictionary<string, decimal> expensesByCategory = new();
    private Dictionary<string, int> expenseCategoryCounts = new();

    protected override async Task OnInitializedAsync()
    {
        // Initialize dates to Greek today
        var greekToday = TimeZone.GetGreekNow().Date;
        startDate = TimeZone.ConvertToUtc(greekToday);
        endDate = TimeZone.ConvertToUtc(greekToday.AddDays(1).AddSeconds(-1));

        currentUser = await SessionService.GetCurrentUserAsync();

        if (currentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        // Role-based access control
        if (currentUser.Role == UserRole.Admin || currentUser.Role == UserRole.Owner)
        {
            // Admin/Owner: can select any collector
            canSelectCollector = true;
            await LoadCollectors();

            if (UserId.HasValue)
            {
                // Viewing specific collector
                collector = allCollectors.FirstOrDefault(c => c.Id == UserId.Value);
            }
            else if (allCollectors.Any())
            {
                // Default to first collector
                collector = allCollectors.First();
            }
        }
        else if (currentUser.Role == UserRole.Treasurer)
        {
            // Treasurer: can only see their own card
            canSelectCollector = false;
            collector = currentUser;
        }
        else
        {
            // Other roles: no access, redirect to home
            Snackbar.Add("Î”ÎµÎ½ Î­Ï‡ÎµÏ„Îµ Î´Î¹ÎºÎ±Î¯Ï‰Î¼Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·Ï‚ ÏƒÎµ Î±Ï…Ï„Î® Ï„Î· ÏƒÎµÎ»Î¯Î´Î±", Severity.Warning);
            Navigation.NavigateTo("/");
            return;
        }

        if (collector != null)
        {
            await LoadData();
        }

        loading = false;
    }

    private async Task LoadCollectors()
    {
        try
        {
            using var context = ContextFactory.CreateDbContext();
            allCollectors = await context.Users
                .Where(u => u.Role == UserRole.Treasurer && u.IsActive)
                .OrderBy(u => u.LastName)
                .ThenBy(u => u.FirstName)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ ÎµÎ¹ÏƒÏ€ÏÎ±ÎºÏ„ÏŒÏÏ‰Î½: {ex.Message}", Severity.Error);
        }
    }

    private async Task<IEnumerable<User>> SearchCollectors(string value, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(value))
            return allCollectors.Take(10);

        return allCollectors
            .Where(u => u.FullName.Contains(value, StringComparison.OrdinalIgnoreCase) ||
                       u.Username.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Take(10);
    }

    private async Task OnCollectorChanged(User? selectedCollector)
    {
        if (selectedCollector == null) return;

        collector = selectedCollector;
        Navigation.NavigateTo($"/collector-card/{collector.Id}");
        await LoadData();
    }

    private async Task OnPeriodChanged(string period)
    {
        selectedPeriod = period;
        var greekNow = TimeZone.GetGreekNow();
        var greekToday = greekNow.Date;

        switch (period)
        {
            case "today":
                startDate = TimeZone.ConvertToUtc(greekToday);
                endDate = TimeZone.ConvertToUtc(greekToday.AddDays(1).AddSeconds(-1));
                break;
            case "this_week":
                var dayOfWeek = (int)greekToday.DayOfWeek;
                var monday = dayOfWeek == 0 ? greekToday.AddDays(-6) : greekToday.AddDays(1 - dayOfWeek);
                startDate = TimeZone.ConvertToUtc(monday);
                endDate = TimeZone.ConvertToUtc(monday.AddDays(7).AddSeconds(-1));
                break;
            case "this_month":
                var monthStart = new DateTime(greekToday.Year, greekToday.Month, 1);
                var monthEnd = monthStart.AddMonths(1).AddSeconds(-1);
                startDate = TimeZone.ConvertToUtc(monthStart);
                endDate = TimeZone.ConvertToUtc(monthEnd);
                break;
            case "last_month":
                var lastMonthStart = new DateTime(greekToday.Year, greekToday.Month, 1).AddMonths(-1);
                var lastMonthEnd = lastMonthStart.AddMonths(1).AddSeconds(-1);
                startDate = TimeZone.ConvertToUtc(lastMonthStart);
                endDate = TimeZone.ConvertToUtc(lastMonthEnd);
                break;
        }

        await LoadData();
    }

    private async Task OnStartDateChanged(DateTime? newDate)
    {
        startDate = newDate;
        await LoadData();
    }

    private async Task OnEndDateChanged(DateTime? newDate)
    {
        endDate = newDate;
        await LoadData();
    }

    private async Task LoadData()
    {
        if (collector == null || startDate == null || endDate == null) return;

        loading = true;
        try
        {
            using var context = ContextFactory.CreateDbContext();

            // Load payments collected by this user
            payments = await context.Payments
                .Include(p => p.Member)
                .Where(p => p.CollectorId == collector.Id &&
                           p.PaymentDate >= startDate.Value &&
                           p.PaymentDate <= endDate.Value.AddDays(1))
                .OrderByDescending(p => p.PaymentDate)
                .ToListAsync();

            // Load expenses submitted by this user
            expenses = await context.Expenses
                .Include(e => e.Category)
                .Where(e => e.SubmittedBy == collector.Id &&
                           e.Date >= startDate.Value &&
                           e.Date <= endDate.Value.AddDays(1))
                .OrderByDescending(e => e.Date)
                .ToListAsync();

            // Calculate totals
            totalCollections = payments.Sum(p => p.Amount);
            totalExpenses = expenses.Sum(e => e.Amount);
            balance = totalCollections - totalExpenses;
            paymentsCount = payments.Count;
            expensesCount = expenses.Count;

            // Get last handover date (from the new system)
            var lastHandover = await context.CashierHandovers
                .Where(h => h.CashierId == collector.Id && h.Status == HandoverStatus.Confirmed)
                .OrderByDescending(h => h.PeriodEndDate)
                .FirstOrDefaultAsync();

            lastDeliveryDate = lastHandover?.PeriodEndDate;

            // Analytics - Payment methods
            paymentsByMethod = payments
                .GroupBy(p => p.PaymentMethod)
                .ToDictionary(g => g.Key, g => g.Sum(p => p.Amount));

            paymentMethodCounts = payments
                .GroupBy(p => p.PaymentMethod)
                .ToDictionary(g => g.Key, g => g.Count());

            // Analytics - Expense categories
            expensesByCategory = expenses
                .GroupBy(e => e.Category?.Name ?? "Î§Ï‰ÏÎ¯Ï‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±")
                .ToDictionary(g => g.Key, g => g.Sum(e => e.Amount));

            expenseCategoryCounts = expenses
                .GroupBy(e => e.Category?.Name ?? "Î§Ï‰ÏÎ¯Ï‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±")
                .ToDictionary(g => g.Key, g => g.Count());
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private string GetBalanceCardStyle()
    {
        if (balance > 0)
            return "background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);";
        else if (balance < 0)
            return "background: linear-gradient(135deg, #ee0979 0%, #ff6a00 100%);";
        else
            return "background: linear-gradient(135deg, #bdc3c7 0%, #2c3e50 100%);";
    }

    private string GetBalanceDescription()
    {
        if (balance > 0)
            return "Î˜ÎµÏ„Î¹ÎºÏŒ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿";
        else if (balance < 0)
            return "Î‘ÏÎ½Î·Ï„Î¹ÎºÏŒ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿";
        else
            return "ÎœÎ·Î´ÎµÎ½Î¹ÎºÏŒ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€Î¿";
    }

    private string GetDaysSinceDelivery()
    {
        if (lastDeliveryDate == null)
            return "Î”ÎµÎ½ Î­Ï‡ÎµÎ¹ Î³Î¯Î½ÎµÎ¹ Ï€Î±ÏÎ¬Î´Î¿ÏƒÎ·";

        var greekToday = TimeZone.GetGreekNow().Date;
        var deliveryGreekDate = TimeZone.ConvertToGreekTime(lastDeliveryDate.Value).Date;
        var days = (greekToday - deliveryGreekDate).Days;

        if (days == 0)
            return "Î£Î®Î¼ÎµÏÎ±";
        else if (days == 1)
            return "Î§Î¸ÎµÏ‚";
        else
            return $"Î ÏÎ¹Î½ {days} Î·Î¼Î­ÏÎµÏ‚";
    }

    private string GetPaymentMethodName(PaymentMethod method)
    {
        return method switch
        {
            PaymentMethod.Cash => "ÎœÎµÏ„ÏÎ·Ï„Î¬",
            PaymentMethod.Card => "ÎšÎ¬ÏÏ„Î±",
            PaymentMethod.BankTransfer => "ÎˆÎ¼Î²Î±ÏƒÎ¼Î±",
            PaymentMethod.DigitalWallet => "Î¨Î·Ï†Î¹Î±ÎºÏŒ Î Î¿ÏÏ„Î¿Ï†ÏŒÎ»Î¹",
            PaymentMethod.Check => "Î•Ï€Î¹Ï„Î±Î³Î®",
            _ => method.ToString()
        };
    }
}
