@page "/payments/new"
@using MembersHub.Core.Entities
@using MembersHub.Core.Interfaces
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@using System.ComponentModel.DataAnnotations
@using MudBlazor
@inject IPaymentService PaymentService
@inject IMemberService MemberService
@inject ISubscriptionService SubscriptionService
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JSRuntime
@attribute [Authorize]

<PageTitle>Νέα Είσπραξη</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h4">
                    <MudIcon Icon="@Icons.Material.Filled.Payment" Class="mr-2" />
                    Νέα Είσπραξη
                </MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudIconButton Icon="@Icons.Material.Filled.Close"
                               Color="Color.Default"
                               OnClick="@(() => Navigation.NavigateTo("/financial/payments"))"
                               Title="Κλείσιμο" />
            </CardHeaderActions>
        </MudCardHeader>

        <MudCardContent>
            <MudForm @ref="form" @bind-IsValid="@formIsValid" @bind-Errors="@errors">
                <MudGrid>
                    <!-- Member Selection -->
                    <MudItem xs="12">
                        <MudAutocomplete T="Member"
                                         Value="selectedMember"
                                         ValueChanged="OnMemberSelected"
                                         Label="Επιλογή Μέλους *"
                                         Placeholder="Πληκτρολογήστε για αναζήτηση..."
                                         HelperText="Πληκτρολογήστε τουλάχιστον 2 χαρακτήρες για αναζήτηση"
                                         Variant="Variant.Outlined"
                                         Required="true"
                                         RequiredError="Παρακαλώ επιλέξτε μέλος"
                                         SearchFunc="@SearchMembers"
                                         ToStringFunc="@(m => m?.FullName ?? "")"
                                         ShowProgressIndicator="true"
                                         Dense="false"
                                         Margin="Margin.Dense"
                                         AdornmentIcon="@Icons.Material.Filled.Person"
                                         AdornmentColor="Color.Primary"
                                         ResetValueOnEmptyText="true"
                                         CoerceText="false"
                                         CoerceValue="false">
                            <ItemTemplate Context="member">
                                <MudGrid AlignItems="Center">
                                    <MudItem xs="8">
                                        <MudText Typo="Typo.body1">@member.FullName</MudText>
                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                            @member.MemberNumber | @member.Phone
                                        </MudText>
                                    </MudItem>
                                    <MudItem xs="4" Class="text-right">
                                        <MudChip T="string" Color="@GetMemberStatusColor(member.Status)" Size="Size.Small">
                                            @GetMemberStatusText(member.Status)
                                        </MudChip>
                                    </MudItem>
                                </MudGrid>
                            </ItemTemplate>
                        </MudAutocomplete>
                    </MudItem>

                    <!-- Member Info Card (shown when member is selected) -->
                    @if (selectedMember != null)
                    {
                        <MudItem xs="12">
                            <MudAlert Severity="Severity.Info" Dense="true">
                                <MudGrid AlignItems="Center">
                                    <MudItem xs="12" md="3">
                                        <MudText Typo="Typo.subtitle2">Μέλος:</MudText>
                                        <MudText Typo="Typo.body2">@selectedMember.FullName</MudText>
                                    </MudItem>
                                    <MudItem xs="12" md="3">
                                        <MudText Typo="Typo.subtitle2">Τύπος Συνδρομής:</MudText>
                                        <MudText Typo="Typo.body2">@selectedMember.MembershipType?.Name</MudText>
                                    </MudItem>
                                    <MudItem xs="12" md="3">
                                        <MudText Typo="Typo.subtitle2">Μηνιαία Συνδρομή:</MudText>
                                        <MudText Typo="Typo.body2">€@selectedMember.MembershipType?.MonthlyFee.ToString("F2")</MudText>
                                    </MudItem>
                                    <MudItem xs="12" md="3">
                                        <MudText Typo="Typo.subtitle2">Υπόλοιπο:</MudText>
                                        <MudText Typo="Typo.body2" Style="@GetBalanceStyle()">
                                            <strong>€@memberBalance.ToString("F2")</strong>
                                        </MudText>
                                    </MudItem>
                                </MudGrid>
                            </MudAlert>
                        </MudItem>

                        <!-- Outstanding Subscriptions Details -->
                        @if (outstandingSubscriptions.Any())
                        {
                            <MudItem xs="12">
                                <MudAlert Severity="Severity.Warning" Dense="true">
                                    <MudGrid AlignItems="Center">
                                        <MudItem xs="12">
                                            <MudText Typo="Typo.subtitle2">
                                                <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" Class="mr-1" />
                                                Εκκρεμείς Συνδρομές (@outstandingSubscriptions.Count)
                                            </MudText>
                                        </MudItem>
                                        <MudItem xs="12">
                                            <MudText Typo="Typo.body2" Class="mb-2">
                                                Υπόλοιπο προς πληρωμή: <strong>€@memberBalance.ToString("F2")</strong>
                                            </MudText>
                                            <MudChip T="string" Size="Size.Small" Color="Color.Default" Class="mr-1 mb-1"
                                                     Icon="@Icons.Material.Filled.Info">
                                                @outstandingSubscriptions.Count συνδρομές
                                            </MudChip>
                                            @if (outstandingSubscriptions.Any(s => s.Status == SubscriptionStatus.Overdue))
                                            {
                                                var overdueCount = outstandingSubscriptions.Count(s => s.Status == SubscriptionStatus.Overdue);
                                                <MudChip T="string" Size="Size.Small" Color="Color.Error" Class="mr-1 mb-1"
                                                         Icon="@Icons.Material.Filled.Warning">
                                                    @overdueCount ληξιπρόθεσμες
                                                </MudChip>
                                            }
                                            @{
                                                var partiallyPaidCount = outstandingSubscriptions.Count(s =>
                                                    s.Payments.Any(p => p.Status == PaymentStatus.Confirmed) &&
                                                    s.Payments.Where(p => p.Status == PaymentStatus.Confirmed).Sum(p => p.Amount) < s.Amount);

                                                if (partiallyPaidCount > 0)
                                                {
                                                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Class="mr-1 mb-1"
                                                             Icon="@Icons.Material.Filled.PendingActions">
                                                        @partiallyPaidCount μερικώς πληρωμένες
                                                    </MudChip>
                                                }
                                            }
                                        </MudItem>
                                        <MudItem xs="12">
                                            <MudDivider Class="my-2" />
                                            <MudText Typo="Typo.caption" Class="mb-2"><strong>Λεπτομέρειες Συνδρομών:</strong></MudText>
                                            @foreach (var sub in outstandingSubscriptions.Take(5))
                                            {
                                                var paidAmount = sub.Payments.Where(p => p.Status == PaymentStatus.Confirmed).Sum(p => p.Amount);
                                                var remainingAmount = sub.Amount - paidAmount;
                                                <MudText Typo="Typo.caption" Class="mb-1">
                                                    • @GetMonthName(sub.Month) @sub.Year:
                                                    @if (paidAmount > 0)
                                                    {
                                                        <span>€@paidAmount.ToString("F2") / €@sub.Amount.ToString("F2") (Υπόλοιπο: €@remainingAmount.ToString("F2"))</span>
                                                    }
                                                    else
                                                    {
                                                        <span>€@sub.Amount.ToString("F2") (Απλήρωτη)</span>
                                                    }
                                                </MudText>
                                            }
                                            @if (outstandingSubscriptions.Count > 5)
                                            {
                                                <MudText Typo="Typo.caption" Class="mt-1" Color="Color.Secondary">
                                                    ... και @(outstandingSubscriptions.Count - 5) ακόμα
                                                </MudText>
                                            }
                                        </MudItem>
                                    </MudGrid>
                                </MudAlert>
                            </MudItem>
                        }
                        else
                        {
                            <MudItem xs="12">
                                <MudAlert Severity="Severity.Success" Dense="true">
                                    <MudText Typo="Typo.body2">
                                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Size="Size.Small" Class="mr-1" />
                                        Το μέλος δεν έχει εκκρεμείς συνδρομές
                                    </MudText>
                                </MudAlert>
                            </MudItem>
                        }
                    }

                    <!-- Subscription Selection -->
                    @if (outstandingSubscriptions.Any())
                    {
                        <MudItem xs="12" md="6">
                            <MudSelect T="int?"
                                       Value="selectedSubscriptionId"
                                       ValueChanged="OnSubscriptionChanged"
                                       Label="Για Συνδρομή *"
                                       Variant="Variant.Outlined"
                                       Required="true"
                                       RequiredError="Επιλέξτε συνδρομή"
                                       HelperText="Επιλέξτε από ποια συνδρομή θα ξεκινήσει η πληρωμή"
                                       Margin="Margin.Dense"
                                       AdornmentIcon="@Icons.Material.Filled.CalendarMonth"
                                       AdornmentColor="Color.Primary">
                                @foreach (var sub in outstandingSubscriptions)
                                {
                                    var paidAmount = sub.Payments.Where(p => p.Status == PaymentStatus.Confirmed).Sum(p => p.Amount);
                                    var remainingAmount = sub.Amount - paidAmount;

                                    <MudSelectItem T="int?" Value="@sub.Id">
                                        <div class="d-flex align-center justify-space-between">
                                            <span>@GetMonthName(sub.Month) @sub.Year</span>
                                            @if (paidAmount > 0)
                                            {
                                                <span class="ml-2" style="font-size: 0.875em; color: #666;">
                                                    €@paidAmount.ToString("F2") / €@sub.Amount.ToString("F2") (Υπ: €@remainingAmount.ToString("F2"))
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="ml-2" style="font-size: 0.875em; color: #666;">€@sub.Amount.ToString("F2")</span>
                                            }
                                        </div>
                                    </MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                    }

                    <!-- Amount -->
                    <MudItem xs="12" md="6">
                        <MudNumericField Value="payment.Amount"
                                         ValueChanged="@((decimal val) => OnAmountChanged(val))"
                                         Label="Ποσό (€) *"
                                         Variant="Variant.Outlined"
                                         Required="true"
                                         RequiredError="Το ποσό είναι υποχρεωτικό"
                                         Min="0.01m"
                                         Step="0.01m"
                                         Format="F2"
                                         Margin="Margin.Dense"
                                         AdornmentIcon="@Icons.Material.Filled.Euro"
                                         AdornmentColor="Color.Success" />
                    </MudItem>

                    <!-- Payment Distribution Preview -->
                    @if (selectedSubscriptionId.HasValue && payment.Amount > 0)
                    {
                        <MudItem xs="12">
                            <MudAlert Severity="Severity.Info" Dense="true">
                                <MudText Typo="Typo.subtitle2" Class="mb-2">
                                    <MudIcon Icon="@Icons.Material.Filled.Info" Size="Size.Small" />
                                    Προεπισκόπηση Κατανομής Πληρωμής
                                </MudText>
                                @{
                                    var distribution = CalculatePaymentDistribution(selectedSubscriptionId.Value, payment.Amount);
                                }
                                @if (distribution.Any())
                                {
                                    @foreach (var item in distribution)
                                    {
                                        <MudText Typo="Typo.body2" Class="mb-1">
                                            • @GetMonthName(item.Subscription.Month) @item.Subscription.Year:
                                            <strong>€@item.AmountToApply.ToString("F2")</strong>
                                            @if (item.AmountToApply >= item.RemainingAmount)
                                            {
                                                <MudChip T="string" Size="Size.Small" Color="Color.Success" Class="ml-1" Style="height: 20px;">Πλήρης</MudChip>
                                            }
                                            else
                                            {
                                                <MudChip T="string" Size="Size.Small" Color="Color.Warning" Class="ml-1" Style="height: 20px;">Μερική</MudChip>
                                            }
                                        </MudText>
                                    }
                                    @if (distribution.Sum(d => d.AmountToApply) < payment.Amount)
                                    {
                                        var excess = payment.Amount - distribution.Sum(d => d.AmountToApply);
                                        <MudText Typo="Typo.body2" Color="Color.Warning" Class="mt-2">
                                            <MudIcon Icon="@Icons.Material.Filled.Warning" Size="Size.Small" />
                                            Υπερβάλλον ποσό: €@excess.ToString("F2") (θα καταγραφεί ως πίστωση)
                                        </MudText>
                                    }
                                }
                            </MudAlert>
                        </MudItem>
                    }

                    <!-- Payment Method -->
                    <MudItem xs="12" md="6">
                        <MudSelect @bind-Value="payment.PaymentMethod"
                                   Label="Μέθοδος Είσπραξης *"
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   RequiredError="Επιλέξτε μέθοδο είσπραξης"
                                   Margin="Margin.Dense"
                                   AdornmentIcon="@Icons.Material.Filled.CreditCard"
                                   AdornmentColor="Color.Primary">
                            <MudSelectItem Value="@PaymentMethod.Cash">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Money" Class="mr-2" />
                                    Μετρητά
                                </div>
                            </MudSelectItem>
                            <MudSelectItem Value="@PaymentMethod.Card">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.CreditCard" Class="mr-2" />
                                    Κάρτα
                                </div>
                            </MudSelectItem>
                            <MudSelectItem Value="@PaymentMethod.BankTransfer">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.AccountBalance" Class="mr-2" />
                                    Τραπεζικό Έμβασμα
                                </div>
                            </MudSelectItem>
                            <MudSelectItem Value="@PaymentMethod.DigitalWallet">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Wallet" Class="mr-2" />
                                    Ψηφιακό Πορτοφόλι
                                </div>
                            </MudSelectItem>
                            <MudSelectItem Value="@PaymentMethod.Check">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.Receipt" Class="mr-2" />
                                    Επιταγή
                                </div>
                            </MudSelectItem>
                            <MudSelectItem Value="@PaymentMethod.Other">
                                <div class="d-flex align-center">
                                    <MudIcon Icon="@Icons.Material.Filled.MoreHoriz" Class="mr-2" />
                                    Άλλο
                                </div>
                            </MudSelectItem>
                        </MudSelect>
                    </MudItem>

                    <!-- Payment Date -->
                    <MudItem xs="12" md="6">
                        <MudDatePicker @bind-Date="paymentDate"
                                       Label="Ημερομηνία Είσπραξης *"
                                       Variant="Variant.Outlined"
                                       DateFormat="dd/MM/yyyy"
                                       MaxDate="DateTime.Today"
                                       Required="true"
                                       RequiredError="Η ημερομηνία είναι υποχρεωτική"
                                       Margin="Margin.Dense"
                                       AdornmentIcon="@Icons.Material.Filled.CalendarToday"
                                       AdornmentColor="Color.Primary" />
                    </MudItem>

                    <!-- Transaction Reference (for non-cash payments) -->
                    @if (payment.PaymentMethod != PaymentMethod.Cash)
                    {
                        <MudItem xs="12" md="6">
                            <MudTextField @bind-Value="payment.TransactionReference"
                                          Label="Αριθμός Αναφοράς"
                                          Variant="Variant.Outlined"
                                          HelperText="Αριθμός συναλλαγής, επιταγής κλπ."
                                          Margin="Margin.Dense"
                                          AdornmentIcon="@Icons.Material.Filled.Tag"
                                          AdornmentColor="Color.Secondary" />
                        </MudItem>
                    }

                    <!-- Notes -->
                    <MudItem xs="12">
                        <MudTextField @bind-Value="payment.Notes"
                                      Label="Σημειώσεις"
                                      Variant="Variant.Outlined"
                                      Lines="3"
                                      Margin="Margin.Dense"
                                      AdornmentIcon="@Icons.Material.Filled.Notes"
                                      AdornmentColor="Color.Secondary" />
                    </MudItem>

                    <!-- Options -->
                    <MudItem xs="12">
                        <MudSwitch @bind-Value="sendEmailReceipt"
                                   Label="Αποστολή απόδειξης με email"
                                   Color="Color.Primary" />
                        @if (sendEmailReceipt && selectedMember != null && string.IsNullOrEmpty(selectedMember.Email))
                        {
                            <MudAlert Severity="Severity.Warning" Dense="true" Class="mt-2">
                                <MudText Typo="Typo.caption">
                                    Το μέλος δεν έχει email διεύθυνση. Η απόδειξη δεν θα σταλεί.
                                </MudText>
                            </MudAlert>
                        }
                    </MudItem>

                    <!-- Validation Errors -->
                    @if (errors?.Length > 0)
                    {
                        <MudItem xs="12">
                            <MudAlert Severity="Severity.Error" Dense="true">
                                @foreach (var error in errors)
                                {
                                    <MudText Typo="Typo.body2">• @error</MudText>
                                }
                            </MudAlert>
                        </MudItem>
                    }
                </MudGrid>
            </MudForm>
        </MudCardContent>

        <MudCardActions>
            <MudButton OnClick="Cancel" Variant="Variant.Text">
                <MudIcon Icon="@Icons.Material.Filled.Cancel" Class="mr-2" />
                Ακύρωση
            </MudButton>
            <MudSpacer />
            <MudButton Color="Color.Secondary"
                       Variant="Variant.Filled"
                       OnClick="SaveAndNew"
                       Disabled="@(!formIsValid || processing)"
                       Class="mr-2">
                <MudIcon Icon="@Icons.Material.Filled.AddCircle" Class="mr-2" />
                Αποθήκευση & Νέα
            </MudButton>
            <MudButton Color="Color.Primary"
                       Variant="Variant.Filled"
                       OnClick="Submit"
                       Disabled="@(!formIsValid || processing)">
                @if (processing)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                    <MudText Class="ms-2">Αποθήκευση...</MudText>
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Filled.Save" Class="mr-2" />
                    <MudText>Αποθήκευση</MudText>
                }
            </MudButton>
        </MudCardActions>
    </MudCard>

    <!-- Recent Payments Preview -->
    @if (recentPayments.Any())
    {
        <MudCard Class="mt-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Πρόσφατες Εισπράξεις</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudSimpleTable Dense="true" Hover="true" Bordered="true">
                    <thead>
                        <tr>
                            <th>Απόδειξη</th>
                            <th>Μέλος</th>
                            <th>Ποσό</th>
                            <th>Ημερομηνία</th>
                            <th>Ενέργειες</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in recentPayments.Take(5))
                        {
                            <tr>
                                <td>@p.ReceiptNumber</td>
                                <td>@p.Member?.FullName</td>
                                <td>€@p.Amount.ToString("F2")</td>
                                <td>@p.PaymentDate.ToString("dd/MM/yyyy")</td>
                                <td>
                                    <MudIconButton Icon="@Icons.Material.Filled.Print"
                                                   Size="Size.Small"
                                                   Color="Color.Primary"
                                                   OnClick="@(() => PrintReceipt(p.Id))"
                                                   Title="Εκτύπωση Απόδειξης" />
                                </td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>
            </MudCardContent>
        </MudCard>
    }
</MudContainer>

@code {
    [SupplyParameterFromQuery]
    public int? MemberId { get; set; }

    private MudForm form = null!;
    private bool formIsValid;
    private string[] errors = Array.Empty<string>();
    private bool processing;
    private bool sendEmailReceipt = true;

    private Payment payment = new();
    private Member? selectedMember;
    private DateTime? paymentDate = DateTime.SpecifyKind(DateTime.Today, DateTimeKind.Utc);
    private List<Subscription> outstandingSubscriptions = new();
    private List<Payment> recentPayments = new();
    private decimal memberBalance = 0;
    private int? selectedSubscriptionId;

    private class PaymentDistributionItem
    {
        public Subscription Subscription { get; set; } = null!;
        public decimal RemainingAmount { get; set; }
        public decimal AmountToApply { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        payment = new Payment
        {
            PaymentMethod = PaymentMethod.Cash,
            Status = PaymentStatus.Confirmed
        };

        await LoadRecentPayments();

        // If MemberId is provided, pre-select the member
        if (MemberId.HasValue)
        {
            await PreSelectMember(MemberId.Value);
        }
    }

    private async Task PreSelectMember(int memberId)
    {
        try
        {
            var members = await MemberService.SearchAsync("");
            selectedMember = members.FirstOrDefault(m => m.Id == memberId);

            if (selectedMember != null)
            {
                await LoadMemberSubscriptions();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Σφάλμα φόρτωσης μέλους: {ex.Message}", Severity.Warning);
        }
    }

    private async Task LoadRecentPayments()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);

            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out var userId))
            {
                var payments = await PaymentService.GetCollectorPaymentsAsync(userId);
                recentPayments = payments.OrderByDescending(p => p.CreatedAt).Take(5).ToList();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Σφάλμα φόρτωσης πρόσφατων πληρωμών: {ex.Message}", Severity.Warning);
        }
    }

    private async Task<IEnumerable<Member>> SearchMembers(string value, CancellationToken token)
    {
        if (string.IsNullOrEmpty(value) || value.Length < 2)
            return Array.Empty<Member>();

        try
        {
            var members = await MemberService.SearchAsync(value);
            return members.Take(10);
        }
        catch
        {
            return Array.Empty<Member>();
        }
    }

    private async Task OnMemberSelected(Member? member)
    {
        selectedMember = member;

        if (member != null)
        {
            await LoadMemberSubscriptions();
        }
        else
        {
            // Reset balance and subscriptions when member is cleared
            memberBalance = 0;
            outstandingSubscriptions.Clear();
            payment.Amount = 0;
        }
    }

    private async Task LoadMemberSubscriptions()
    {
        if (selectedMember == null) return;

        try
        {
            var subscriptions = await SubscriptionService.GetMemberSubscriptionsAsync(selectedMember.Id);
            outstandingSubscriptions = subscriptions
                .Where(s => s.Status == SubscriptionStatus.Pending || s.Status == SubscriptionStatus.Overdue)
                .OrderBy(s => s.Year)
                .ThenBy(s => s.Month)
                .ToList();

            // Calculate member balance (total outstanding amount minus paid amounts)
            memberBalance = 0;
            foreach (var subscription in outstandingSubscriptions)
            {
                var paidAmount = subscription.Payments
                    .Where(p => p.Status == PaymentStatus.Confirmed)
                    .Sum(p => p.Amount);
                var remainingAmount = subscription.Amount - paidAmount;
                memberBalance += remainingAmount > 0 ? remainingAmount : 0;
            }

            // Auto-select oldest outstanding subscription and calculate amount
            if (outstandingSubscriptions.Any())
            {
                selectedSubscriptionId = outstandingSubscriptions.First().Id;
                payment.Amount = memberBalance;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Σφάλμα φόρτωσης συνδρομών: {ex.Message}", Severity.Error);
        }
    }

    private void OnSubscriptionChanged(int? newSubscriptionId)
    {
        selectedSubscriptionId = newSubscriptionId;

        if (newSubscriptionId.HasValue)
        {
            // Auto-fill with remaining balance starting from this subscription
            var startIndex = outstandingSubscriptions.FindIndex(s => s.Id == newSubscriptionId.Value);
            if (startIndex >= 0)
            {
                decimal suggestedAmount = 0;
                foreach (var sub in outstandingSubscriptions.Skip(startIndex))
                {
                    var paidAmount = sub.Payments.Where(p => p.Status == PaymentStatus.Confirmed).Sum(p => p.Amount);
                    var remaining = sub.Amount - paidAmount;
                    suggestedAmount += remaining > 0 ? remaining : 0;
                }
                payment.Amount = suggestedAmount;
            }
        }
        StateHasChanged();
    }

    private void OnAmountChanged(decimal newAmount)
    {
        payment.Amount = newAmount;
        StateHasChanged();
    }

    private List<PaymentDistributionItem> CalculatePaymentDistribution(int startingSubscriptionId, decimal totalAmount)
    {
        var distribution = new List<PaymentDistributionItem>();
        var remainingPayment = totalAmount;

        // Find the starting subscription index
        var startIndex = outstandingSubscriptions.FindIndex(s => s.Id == startingSubscriptionId);
        if (startIndex == -1) return distribution;

        // Distribute payment starting from selected subscription
        for (int i = startIndex; i < outstandingSubscriptions.Count && remainingPayment > 0; i++)
        {
            var subscription = outstandingSubscriptions[i];
            var paidAmount = subscription.Payments.Where(p => p.Status == PaymentStatus.Confirmed).Sum(p => p.Amount);
            var remaining = subscription.Amount - paidAmount;

            if (remaining > 0)
            {
                var amountToApply = Math.Min(remainingPayment, remaining);
                distribution.Add(new PaymentDistributionItem
                {
                    Subscription = subscription,
                    RemainingAmount = remaining,
                    AmountToApply = amountToApply
                });
                remainingPayment -= amountToApply;
            }
        }

        return distribution;
    }

    private async Task Submit()
    {
        await SavePayment(false);
    }

    private async Task SaveAndNew()
    {
        await SavePayment(true);
    }

    private async Task SavePayment(bool createNew)
    {
        if (!formIsValid || selectedMember == null || !paymentDate.HasValue) return;

        // Validate subscription selection if outstanding subscriptions exist
        if (outstandingSubscriptions.Any() && !selectedSubscriptionId.HasValue)
        {
            Snackbar.Add("Παρακαλώ επιλέξτε συνδρομή", Severity.Warning);
            return;
        }

        processing = true;
        try
        {
            // Get current user as collector
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var userIdClaim = authState.User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier);
            int collectorId = 0;

            if (userIdClaim != null && int.TryParse(userIdClaim.Value, out var userId))
            {
                collectorId = userId;
            }

            var createdPayments = new List<Payment>();

            // Calculate payment distribution
            if (selectedSubscriptionId.HasValue)
            {
                var distribution = CalculatePaymentDistribution(selectedSubscriptionId.Value, payment.Amount);

                // Create separate payment record for each subscription in distribution
                foreach (var item in distribution)
                {
                    var paymentRecord = new Payment
                    {
                        MemberId = selectedMember.Id,
                        SubscriptionId = item.Subscription.Id,
                        Amount = item.AmountToApply,
                        PaymentDate = paymentDate.Value,
                        CollectorId = collectorId,
                        PaymentMethod = payment.PaymentMethod,
                        TransactionReference = payment.TransactionReference,
                        Notes = distribution.Count > 1
                            ? $"{payment.Notes} (Μέρος πληρωμής για {GetMonthName(item.Subscription.Month)} {item.Subscription.Year})"
                            : payment.Notes,
                        Status = PaymentStatus.Confirmed,
                        CreatedAt = DateTime.UtcNow
                    };

                    var created = await PaymentService.CreatePaymentAsync(paymentRecord);
                    createdPayments.Add(created);
                }

                // Handle excess payment (overpayment)
                var totalDistributed = distribution.Sum(d => d.AmountToApply);
                if (payment.Amount > totalDistributed)
                {
                    var excessAmount = payment.Amount - totalDistributed;
                    var creditPayment = new Payment
                    {
                        MemberId = selectedMember.Id,
                        SubscriptionId = null, // No specific subscription - credit
                        Amount = excessAmount,
                        PaymentDate = paymentDate.Value,
                        CollectorId = collectorId,
                        PaymentMethod = payment.PaymentMethod,
                        TransactionReference = payment.TransactionReference,
                        Notes = $"{payment.Notes} (Πίστωση - Υπερβάλλον ποσό)",
                        Status = PaymentStatus.Confirmed,
                        CreatedAt = DateTime.UtcNow
                    };
                    var created = await PaymentService.CreatePaymentAsync(creditPayment);
                    createdPayments.Add(created);
                }
            }
            else
            {
                // No subscription selected - create as general payment
                payment.MemberId = selectedMember.Id;
                payment.PaymentDate = paymentDate.Value;
                payment.CollectorId = collectorId;
                payment.CreatedAt = DateTime.UtcNow;
                var created = await PaymentService.CreatePaymentAsync(payment);
                createdPayments.Add(created);
            }

            // Send email receipt if requested (for the first payment record)
            if (sendEmailReceipt && !string.IsNullOrEmpty(selectedMember.Email) && createdPayments.Any())
            {
                try
                {
                    await PaymentService.SendReceiptAsync(createdPayments.First().Id);
                    Snackbar.Add("Απόδειξη στάλθηκε με email", Severity.Info);
                }
                catch
                {
                    Snackbar.Add("Η είσπραξη δημιουργήθηκε αλλά δεν στάλθηκε email", Severity.Warning);
                }
            }

            if (createdPayments.Count == 1)
            {
                Snackbar.Add($"Η είσπραξη {createdPayments.First().ReceiptNumber} καταχωρήθηκε επιτυχώς", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Δημιουργήθηκαν {createdPayments.Count} εισπράξεις επιτυχώς", Severity.Success);
            }

            if (createNew)
            {
                // Reset form for new payment
                payment = new Payment
                {
                    PaymentMethod = PaymentMethod.Cash,
                    Status = PaymentStatus.Confirmed
                };
                selectedMember = null;
                selectedSubscriptionId = null;
                paymentDate = DateTime.SpecifyKind(DateTime.Today, DateTimeKind.Utc);
                outstandingSubscriptions.Clear();
                memberBalance = 0;
                await LoadRecentPayments();
                StateHasChanged();
            }
            else
            {
                Navigation.NavigateTo("/financial/payments");
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Σφάλμα: {ex.Message}", Severity.Error);
        }
        finally
        {
            processing = false;
        }
    }

    private async Task PrintReceipt(int paymentId)
    {
        try
        {
            var pdfBytes = await PaymentService.GenerateReceiptPdfAsync(paymentId);
            var base64 = Convert.ToBase64String(pdfBytes);
            await JSRuntime.InvokeVoidAsync("open", $"data:application/pdf;base64,{base64}", "_blank");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Σφάλμα εκτύπωσης: {ex.Message}", Severity.Error);
        }
    }

    private void Cancel() => Navigation.NavigateTo("/financial/payments");

    private static Color GetMemberStatusColor(MemberStatus status) => status switch
    {
        MemberStatus.Active => Color.Success,
        MemberStatus.Inactive => Color.Warning,
        MemberStatus.Suspended => Color.Error,
        _ => Color.Default
    };

    private static string GetMemberStatusText(MemberStatus status) => status switch
    {
        MemberStatus.Active => "Ενεργό",
        MemberStatus.Inactive => "Ανενεργό",
        MemberStatus.Suspended => "Αναστολή",
        _ => status.ToString()
    };

    private static string GetSubscriptionStatusText(SubscriptionStatus status) => status switch
    {
        SubscriptionStatus.Pending => "Εκκρεμής",
        SubscriptionStatus.Paid => "Εξοφλημένη",
        SubscriptionStatus.Overdue => "Ληξιπρόθεσμη",
        _ => status.ToString()
    };

    private string GetBalanceStyle()
    {
        if (memberBalance > 0)
        {
            return "color: #d84315; font-size: 1.1em;"; // Red color for outstanding balance
        }
        return "color: #2e7d32; font-size: 1.1em;"; // Green color for zero balance
    }

    private string GetMonthName(int month)
    {
        var monthNames = new[] { "", "Ιανουάριος", "Φεβρουάριος", "Μάρτιος", "Απρίλιος", "Μάιος", "Ιούνιος",
                                "Ιούλιος", "Αύγουστος", "Σεπτέμβριος", "Οκτώβριος", "Νοέμβριος", "Δεκέμβριος" };
        return month >= 1 && month <= 12 ? monthNames[month] : month.ToString();
    }
}