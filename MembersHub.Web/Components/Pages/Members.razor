@page "/members"
@using Microsoft.AspNetCore.Authorization
@using MembersHub.Core.Entities
@using MembersHub.Core.Interfaces
@using MembersHub.Infrastructure.Data
@using MembersHub.Web.Components.Dialogs
@attribute [Authorize]
@using MudBlazor
@using Microsoft.EntityFrameworkCore
@inject IServiceScopeFactory ScopeFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IAuditService AuditService
@inject ISessionService SessionService
@inject IHttpContextInfoService HttpContextInfo
@inject NavigationManager Navigation
@attribute [Authorize]

<PageTitle>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· ÎœÎµÎ»ÏÎ½ - MembersHub</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Color="Color.Primary">
        ğŸ‘¥ Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· ÎœÎµÎ»ÏÎ½
    </MudText>

    <MudPaper Class="pa-4 mt-4" Elevation="2">
        <!-- Header Î¼Îµ ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ ÎºÎ±Î¹ ÎºÎ¿Ï…Î¼Ï€Î¯ Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ·Ï‚ -->
        <div class="d-flex flex-column flex-sm-row justify-space-between align-center mb-4 gap-3">
            <div class="d-flex flex-wrap gap-2 justify-center">
                <MudBadge Content="@totalMembers" Color="Color.Primary" Overlap="true">
                    <MudButton Variant="Variant.Outlined" StartIcon="Icons.Material.Filled.Group">
                        Î£ÏÎ½Î¿Î»Î¿ ÎœÎµÎ»ÏÎ½
                    </MudButton>
                </MudBadge>
                <MudBadge Content="@activeMembers" Color="Color.Success" Overlap="true">
                    <MudButton Variant="Variant.Outlined" StartIcon="Icons.Material.Filled.CheckCircle">
                        Î•Î½ÎµÏÎ³Î¬
                    </MudButton>
                </MudBadge>
                <MudBadge Content="@(totalMembers - activeMembers)" Color="Color.Warning" Overlap="true">
                    <MudButton Variant="Variant.Outlined" StartIcon="Icons.Material.Filled.Pause">
                        Î‘Î½ÎµÎ½ÎµÏÎ³Î¬
                    </MudButton>
                </MudBadge>
            </div>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       StartIcon="Icons.Material.Filled.Add"
                       OnClick="@OpenCreateDialog">
                ÎÎ­Î¿ ÎœÎ­Î»Î¿Ï‚
            </MudButton>
        </div>

        <!-- Search ÎºÎ±Î¹ Filters -->
        <div class="d-flex flex-column flex-md-row gap-3 mb-4">
            <MudTextField @bind-Value="searchString"
                          Label="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Î¼ÎµÎ»ÏÎ½..."
                          Variant="Variant.Outlined"
                          Adornment="Adornment.Start"
                          AdornmentIcon="Icons.Material.Filled.Search"
                          Class="flex-grow-1" />

            <MudSelect @bind-Value="selectedDepartmentId"
                       Label="Î¤Î¼Î®Î¼Î±"
                       Variant="Variant.Outlined"
                       Clearable="true">
                <MudSelectItem Value="0">ÎŒÎ»Î± Ï„Î± Ï„Î¼Î®Î¼Î±Ï„Î±</MudSelectItem>
                @foreach (var dept in departments)
                {
                    <MudSelectItem Value="dept.Id">@dept.Name</MudSelectItem>
                }
            </MudSelect>

            <MudSelect @bind-Value="selectedMembershipType"
                       Label="Î¤ÏÏ€Î¿Ï‚ Î£Ï…Î½Î´ÏÎ¿Î¼Î®Ï‚"
                       Variant="Variant.Outlined"
                       Clearable="true">
                <MudSelectItem Value="0">ÎŒÎ»Î¿Î¹</MudSelectItem>
                @foreach (var type in membershipTypes)
                {
                    <MudSelectItem Value="type.Id">@type.Name</MudSelectItem>
                }
            </MudSelect>

            <MudSelect @bind-Value="selectedStatus"
                       Label="ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·"
                       Variant="Variant.Outlined"
                       Clearable="true">
                <MudSelectItem Value="@((string?)null)">ÎŒÎ»ÎµÏ‚</MudSelectItem>
                <MudSelectItem Value="@("Active")">Î•Î½ÎµÏÎ³Î¬</MudSelectItem>
                <MudSelectItem Value="@("Inactive")">Î‘Î½ÎµÎ½ÎµÏÎ³Î¬</MudSelectItem>
                <MudSelectItem Value="@("Suspended")">Î‘Î½Î±ÏƒÏ„Î¿Î»Î®</MudSelectItem>
            </MudSelect>
        </div>

        <!-- Desktop Data Table -->
        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <MudDataGrid Items="@filteredMembers"
                     Dense="true"
                     Hover="true"
                     Bordered="true"
                     Striped="true"
                     Loading="@loading"
                     LoadingProgressColor="Color.Primary"
                     ColumnSpacing="1"
                     Filterable="true"
                     FilterMode="DataGridFilterMode.ColumnFilterRow"
                     Class="thick-borders">
            <Columns>
                <PropertyColumn Property="x => x.MemberNumber" Title="Î‘ÏÎ¹Î¸Î¼ÏŒÏ‚" />
                <PropertyColumn Property="x => x.LastName" Title="Î•Ï€ÏÎ½Ï…Î¼Î¿" />
                <PropertyColumn Property="x => x.FirstName" Title="ÎŒÎ½Î¿Î¼Î±" />
                <PropertyColumn Property="x => x.Phone" Title="Î¤Î·Î»Î­Ï†Ï‰Î½Î¿" />
                <PropertyColumn Property="x => x.Email" Title="Email" />
                <TemplateColumn Title="Î¤Î¼Î®Î¼Î±">
                    <CellTemplate>
                        @(context.Item.Department?.Name ?? "-")
                    </CellTemplate>
                </TemplateColumn>
                <PropertyColumn Property="x => x.MembershipType.MonthlyFee" Title="ÎœÎ·Î½Î¹Î±Î¯Î± Î£Ï…Î½Î´ÏÎ¿Î¼Î®" Format="C2" />
                <TemplateColumn Title="ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·">
                    <CellTemplate>
                        <MudChip T="string" Size="Size.Small"
                                 Color="@GetStatusColor(context.Item.Status)">
                            @GetStatusText(context.Item.Status)
                        </MudChip>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Î—Î¼. Î•Î³Î³ÏÎ±Ï†Î®Ï‚">
                    <CellTemplate>
                        @context.Item.CreatedAt.ToString("dd/MM/yyyy")
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Î•Î³Î³ÏÎ±Ï†Î® Î±Ï€ÏŒ">
                    <CellTemplate>
                        @(context.Item.CreatedByUser?.FullName ?? "-")
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚" Sortable="false">
                    <CellTemplate>
                        <div class="d-flex gap-2">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Size="Size.Small"
                                           Color="Color.Primary"
                                           Variant="Variant.Filled"
                                           OnClick="() => EditMember(context.Item)"
                                           title="Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±" />
                            <MudIconButton Icon="@Icons.Material.Filled.AccountBalance"
                                           Size="Size.Small"
                                           Color="Color.Success"
                                           Variant="Variant.Filled"
                                           OnClick="() => ViewMemberCard(context.Item)"
                                           title="ÎšÎ±ÏÏ„Î­Î»Î± ÎœÎ­Î»Î¿Ï…Ï‚" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Size="Size.Small"
                                           Color="Color.Error"
                                           Variant="Variant.Filled"
                                           OnClick="() => DeleteMember(context.Item)"
                                           title="Î”Î¹Î±Î³ÏÎ±Ï†Î®" />
                        </div>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            </MudDataGrid>
        </MudHidden>

        <!-- Mobile Cards -->
        <MudHidden Breakpoint="Breakpoint.MdAndUp">
            <MudGrid>
                @foreach (var member in filteredMembers)
                {
                    <MudItem xs="12">
                        <MudCard Class="mb-3">
                            <MudCardContent>
                                <div class="d-flex justify-space-between align-center mb-2">
                                    <MudText Typo="Typo.h6">@member.FullName</MudText>
                                    <MudChip T="string" Size="Size.Small" Color="@GetStatusColor(member.Status)">
                                        @GetStatusText(member.Status)
                                    </MudChip>
                                </div>
                                <MudText Typo="Typo.body2" Class="mb-1">
                                    <MudIcon Icon="@Icons.Material.Filled.Badge" Size="Size.Small" /> @member.MemberNumber
                                </MudText>
                                <MudText Typo="Typo.body2" Class="mb-1">
                                    <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" /> @member.Phone
                                </MudText>
                                @if (!string.IsNullOrEmpty(member.Email))
                                {
                                    <MudText Typo="Typo.body2" Class="mb-1">
                                        <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" /> @member.Email
                                    </MudText>
                                }
                                @if (member.Gender.HasValue)
                                {
                                    <MudText Typo="Typo.body2" Class="mb-1">
                                        <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" /> @GetGenderText(member.Gender.Value)
                                    </MudText>
                                }
                                @if (!string.IsNullOrEmpty(member.City))
                                {
                                    <MudText Typo="Typo.body2" Class="mb-1">
                                        <MudIcon Icon="@Icons.Material.Filled.LocationCity" Size="Size.Small" /> @member.City
                                    </MudText>
                                }
                                <MudText Typo="Typo.body2" Class="mb-1">
                                    <MudIcon Icon="@Icons.Material.Filled.CreditCard" Size="Size.Small" /> @member.MembershipType.Name - â‚¬@member.MembershipType.MonthlyFee/Î¼Î®Î½Î±
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Default">
                                    Î•Î³Î³ÏÎ±Ï†Î®: @member.CreatedAt.ToString("dd/MM/yyyy")
                                </MudText>
                            </MudCardContent>
                            <MudCardActions>
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                               Size="Size.Small" 
                                               Color="Color.Primary"
                                               OnClick="() => EditMember(member)" />
                                <MudIconButton Icon="@Icons.Material.Filled.AccountBalance"
                                               Size="Size.Small"
                                               Color="Color.Success"
                                               OnClick="() => ViewMemberCard(member)" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                               Size="Size.Small" 
                                               Color="Color.Error"
                                               OnClick="() => DeleteMember(member)" />
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        </MudHidden>

        @if (!filteredMembers.Any() && !loading)
        {
            <div class="text-center pa-8">
                <MudIcon Icon="Icons.Material.Filled.PersonOff" Size="Size.Large" Color="Color.Default" />
                <MudText Typo="Typo.h6" Color="Color.Default" Class="mt-2">
                    Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î±Î¸Î»Î·Ï„Î­Ï‚/Î¼Î­Î»Î· Î¼Îµ Î±Ï…Ï„Î¬ Ï„Î± ÎºÏÎ¹Ï„Î®ÏÎ¹Î±
                </MudText>
            </div>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<Member> members = new();
    private List<MembershipType> membershipTypes = new();
    private List<Department> departments = new();
    private bool loading = true;

    private string searchString = "";
    private int selectedDepartmentId = 0;
    private int selectedMembershipType = 0;
    private string? selectedStatus = null;

    // Î¤Î¼Î®Î¼Î±Ï„Î± Ï€Î¿Ï… ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÏ„Î±Î¹ Î¿ Ï„ÏÎ­Ï‡Ï‰Î½ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î½Î± Î´ÎµÎ¹ (Î³Î¹Î± Treasurers)
    private List<int> allowedDepartmentIds = new();
    private bool isTreasurerWithDepartmentRestriction = false;

    private int totalMembers => members.Count;
    private int activeMembers => members.Count(m => m.Status == MemberStatus.Active);

    private IEnumerable<Member> filteredMembers => members.Where(m =>
        (string.IsNullOrWhiteSpace(searchString) ||
         m.FullName.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
         m.Phone.Contains(searchString) ||
         (m.Email?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false) ||
         m.MemberNumber.Contains(searchString, StringComparison.OrdinalIgnoreCase)) &&
        (selectedDepartmentId == 0 || m.DepartmentId == selectedDepartmentId) &&
        (selectedMembershipType == 0 || m.MembershipTypeId == selectedMembershipType) &&
        (selectedStatus == null || m.Status.ToString() == selectedStatus)
    );
    
    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }
    
    private async Task LoadData()
    {
        loading = true;

        try
        {
            using var scope = ScopeFactory.CreateScope();
            var dbContext = scope.ServiceProvider.GetRequiredService<MembersHubContext>();

            // Î Î±Î¯ÏÎ½Î¿Ï…Î¼Îµ Ï„Î¿Î½ Ï„ÏÎ­Ï‡Î¿Î½Ï„Î± Ï‡ÏÎ®ÏƒÏ„Î· Î³Î¹Î± Î½Î± ÎµÎ»Î­Î³Î¾Î¿Ï…Î¼Îµ Î±Î½ ÎµÎ¯Î½Î±Î¹ Treasurer Î¼Îµ Ï€ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼ÏŒ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½
            var currentUser = await SessionService.GetCurrentUserAsync();

            if (currentUser != null && currentUser.Role == UserRole.Treasurer)
            {
                // Î Î±Î¯ÏÎ½Î¿Ï…Î¼Îµ Ï„Î± Ï„Î¼Î®Î¼Î±Ï„Î± Ï€Î¿Ï… Î­Ï‡Î¿Ï…Î½ Î±Î½Î±Ï„ÎµÎ¸ÎµÎ¯ ÏƒÏ„Î¿Î½ Ï„Î±Î¼Î¯Î±
                allowedDepartmentIds = await dbContext.UserDepartments
                    .Where(ud => ud.UserId == currentUser.Id)
                    .Select(ud => ud.DepartmentId)
                    .ToListAsync();

                // Î‘Î½ Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ Ï„Î¼Î®Î¼Î±Ï„Î±, Î¿ Ï„Î±Î¼Î¯Î±Ï‚ Î­Ï‡ÎµÎ¹ Ï€ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼ÏŒ
                isTreasurerWithDepartmentRestriction = allowedDepartmentIds.Any();
            }
            else
            {
                allowedDepartmentIds.Clear();
                isTreasurerWithDepartmentRestriction = false;
            }

            // Query Î³Î¹Î± Î¼Î­Î»Î· - Ï†Î¹Î»Ï„ÏÎ¬ÏÎµÎ¹ Î²Î¬ÏƒÎµÎ¹ Ï„Î¼Î·Î¼Î¬Ï„Ï‰Î½ Î±Î½ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ ÎµÎ¯Î½Î±Î¹ Treasurer Î¼Îµ Ï€ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼ÏŒ
            var membersQuery = dbContext.Members
                .Include(m => m.MembershipType)
                .Include(m => m.Department)
                .Include(m => m.CreatedByUser)
                .AsQueryable();

            if (isTreasurerWithDepartmentRestriction)
            {
                membersQuery = membersQuery.Where(m => m.DepartmentId.HasValue && allowedDepartmentIds.Contains(m.DepartmentId.Value));
            }

            members = await membersQuery
                .OrderBy(m => m.MemberNumber)
                .ToListAsync();

            membershipTypes = await dbContext.MembershipTypes
                .Where(mt => mt.IsActive)
                .OrderBy(mt => mt.Name)
                .ToListAsync();

            // Î¦Î¹Î»Ï„ÏÎ¬ÏÎ¿Ï…Î¼Îµ ÎºÎ±Î¹ Ï„Î± Ï„Î¼Î®Î¼Î±Ï„Î± ÏƒÏ„Î¿ dropdown Î³Î¹Î± Ï„Î¿Ï…Ï‚ Treasurers Î¼Îµ Ï€ÎµÏÎ¹Î¿ÏÎ¹ÏƒÎ¼ÏŒ
            var departmentsQuery = dbContext.Departments
                .Where(d => d.IsActive);

            if (isTreasurerWithDepartmentRestriction)
            {
                departmentsQuery = departmentsQuery.Where(d => allowedDepartmentIds.Contains(d.Id));
            }

            departments = await departmentsQuery
                .OrderBy(d => d.Name)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }
    
    private Color GetStatusColor(MemberStatus status) => status switch
    {
        MemberStatus.Active => Color.Success,
        MemberStatus.Inactive => Color.Default,
        MemberStatus.Suspended => Color.Warning,
        _ => Color.Default
    };
    
    private string GetStatusText(MemberStatus status) => status switch
    {
        MemberStatus.Active => "Î•Î½ÎµÏÎ³ÏŒ",
        MemberStatus.Inactive => "Î‘Î½ÎµÎ½ÎµÏÎ³ÏŒ",
        MemberStatus.Suspended => "Î‘Î½Î±ÏƒÏ„Î¿Î»Î®",
        _ => "Î†Î³Î½Ï‰ÏƒÏ„Î¿"
    };

    private string GetGenderText(Gender gender) => gender switch
    {
        Gender.Male => "Î†Î½Î´ÏÎ±Ï‚",
        Gender.Female => "Î“Ï…Î½Î±Î¯ÎºÎ±",
        Gender.Other => "Î†Î»Î»Î¿",
        _ => "Î†Î³Î½Ï‰ÏƒÏ„Î¿"
    };
    
    private async Task OpenCreateDialog()
    {
        var options = new DialogOptions 
        { 
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };
        
        var dialog = await DialogService.ShowAsync<MemberDialog>(
            "ÎÎ­Î¿ ÎœÎ­Î»Î¿Ï‚", 
            options);
            
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            await LoadData();
        }
    }
    
    private async Task EditMember(Member member)
    {
        var parameters = new DialogParameters<MemberDialog>
        {
            { x => x.ExistingMember, member }
        };
        
        var options = new DialogOptions 
        { 
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };
        
        var dialog = await DialogService.ShowAsync<MemberDialog>(
            $"Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± ÎœÎ­Î»Î¿Ï…Ï‚ - {member.FullName}", 
            parameters,
            options);
            
        var result = await dialog.Result;
        if (result is not null && !result.Canceled)
        {
            await LoadData();
        }
    }
    
    private async Task ViewMemberCard(Member member)
    {
        var parameters = new DialogParameters<MemberFinancialCardDialog>
        {
            { x => x.Member, member }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.ExtraLarge,
            FullWidth = true
        };

        await DialogService.ShowAsync<MemberFinancialCardDialog>(
            $"ÎšÎ±ÏÏ„Î­Î»Î± ÎœÎ­Î»Î¿Ï…Ï‚ - {member.FullName}",
            parameters,
            options);
    }
    
    private async Task DeleteMember(Member member)
    {
        try
        {
            using var scope = ScopeFactory.CreateScope();
            var dbContext = scope.ServiceProvider.GetRequiredService<MembersHubContext>();

            // Check if member has any payments
            var hasPayments = await dbContext.Payments.AnyAsync(p => p.MemberId == member.Id);

            if (hasPayments)
            {
                await DialogService.ShowMessageBox(
                    "Î‘Î´Ï…Î½Î±Î¼Î¯Î± Î”Î¹Î±Î³ÏÎ±Ï†Î®Ï‚",
                    $"Î¤Î¿ Î¼Î­Î»Î¿Ï‚ '{member.FullName}' Î´ÎµÎ½ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Î³ÏÎ±Ï†ÎµÎ¯ ÎµÏ€ÎµÎ¹Î´Î® Î­Ï‡ÎµÎ¹ ÏƒÏ…Î½Î´ÎµÎ´ÎµÎ¼Î­Î½ÎµÏ‚ ÏƒÏ…Î½Î±Î»Î»Î±Î³Î­Ï‚ (Ï€Î»Î·ÏÏ‰Î¼Î­Ï‚). " +
                    $"Î“Î¹Î± Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Î±Ï…Ï„ÏŒ Ï„Î¿ Î¼Î­Î»Î¿Ï‚, Ï€ÏÎ­Ï€ÎµÎ¹ Ï€ÏÏÏ„Î± Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Î® Î½Î± Î¼ÎµÏ„Î±Ï†Î­ÏÎµÏ„Îµ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ ÏƒÏ…Î½Î±Î»Î»Î±Î³Î­Ï‚ Ï„Î¿Ï….",
                    yesText: "Î•Î½Ï„Î¬Î¾ÎµÎ¹");
                return;
            }

            var result = await DialogService.ShowMessageBox(
                "Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎœÎ­Î»Î¿Ï…Ï‚",
                $"Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Ï„Î¿ Î¼Î­Î»Î¿Ï‚ '{member.FullName}'?",
                yesText: "Î”Î¹Î±Î³ÏÎ±Ï†Î®",
                cancelText: "Î†ÎºÏ…ÏÎ¿");

            if (result == true)
            {
                var memberToDelete = await dbContext.Members.FindAsync(member.Id);
                if (memberToDelete != null)
                {
                    // Audit logging Î³Î¹Î± member deletion (Ï€ÏÎ¹Î½ Ï„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î®)
                    var currentUser = await SessionService.GetCurrentUserAsync();
                    if (currentUser != null)
                    {
                        await AuditService.LogDeleteAsync(memberToDelete,
                            currentUser.Id, currentUser.Username, currentUser.FullName,
                            HttpContextInfo.GetIpAddress());
                    }

                    dbContext.Members.Remove(memberToDelete);
                    await dbContext.SaveChangesAsync();

                    await LoadData();
                    Snackbar.Add($"Î¤Î¿ Î¼Î­Î»Î¿Ï‚ '{member.FullName}' Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚", Severity.Success);
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚: {ex.Message}", Severity.Error);
        }
    }
}