@page "/cashier-handover"
@using MembersHub.Core.Entities
@using MembersHub.Core.Interfaces
@using MembersHub.Infrastructure.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject ICashierHandoverService HandoverService
@inject ISessionService SessionService
@inject IDbContextFactory<MembersHubContext> ContextFactory
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@attribute [Authorize(Roles = "Admin,Owner,Treasurer")]

<PageTitle>Î Î±ÏÎ¬Î´Î¿ÏƒÎ· Î¤Î±Î¼ÎµÎ¯Î¿Ï… - MembersHub</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-6">ğŸ’¼ @(canSelectCashier ? "Î Î±ÏÎ±Î»Î±Î²Î® Î¤Î±Î¼ÎµÎ¯Î¿Ï…" : "Î Î±ÏÎ¬Î´Î¿ÏƒÎ· Î¤Î±Î¼ÎµÎ¯Î¿Ï…")</MudText>

    @if (loading)
    {
        <MudProgressLinear Indeterminate="true" Color="Color.Primary" Class="mb-4" />
    }
    else if (currentUser != null)
    {
        <!-- Cashier Selection (Admin/Owner Only) -->
        @if (canSelectCashier)
        {
            <MudCard Elevation="3" Class="mb-4">
                <MudCardContent>
                    <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
                        Î•Ï€Î¹Î»Î­Î¾Ï„Îµ Ï„Î¿Î½ Ï„Î±Î¼Î¯Î± Î±Ï€ÏŒ Ï„Î¿Î½ Î¿Ï€Î¿Î¯Î¿ Î¸Î± Ï€Î±ÏÎ±Î»Î¬Î²ÎµÏ„Îµ Ï„Î¿ Ï„Î±Î¼ÎµÎ¯Î¿.
                    </MudAlert>
                    <MudAutocomplete T="User"
                                     Value="selectedCashier"
                                     ValueChanged="OnCashierChanged"
                                     SearchFunc="SearchCashiers"
                                     ToStringFunc="@(u => u?.FullName ?? "")"
                                     Label="Î•Ï€Î¹Î»Î¿Î³Î® Î¤Î±Î¼Î¯Î± *"
                                     Placeholder="Î Î»Î·ÎºÏ„ÏÎ¿Î»Î¿Î³Î®ÏƒÏ„Îµ Î³Î¹Î± Î±Î½Î±Î¶Î®Ï„Î·ÏƒÎ·..."
                                     Variant="Variant.Outlined"
                                     Required="true"
                                     AdornmentIcon="@Icons.Material.Filled.Person"
                                     AdornmentColor="Color.Primary" />
                </MudCardContent>
            </MudCard>
        }

        <!-- Current Period Summary -->
        @if (selectedCashier != null)
        {
            <MudCard Elevation="3" Class="mb-6">
                <MudCardHeader>
                    <CardHeaderContent>
                        <MudText Typo="Typo.h6">ğŸ“Š Î¤ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Î ÎµÏÎ¯Î¿Î´Î¿Ï‚ - @selectedCashier.FullName</MudText>
                    </CardHeaderContent>
                </MudCardHeader>
                <MudCardContent>
                    @if (!canSelectCashier)
                    {
                        <MudAlert Severity="Severity.Info" Dense="true" Class="mb-4">
                            Î‘Ï…Ï„Î® Î· ÏƒÎµÎ»Î¯Î´Î± Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ Ï„Î± Î´Î¹ÎºÎ¬ ÏƒÎ±Ï‚ ÏƒÏ„Î¿Î¹Ï‡ÎµÎ¯Î±. ÎšÎ¬Î¸Îµ Ï„Î±Î¼ÎµÎ¯Î±Ï‚ ÎºÎ¬Î½ÎµÎ¹ Ï„Î·Î½ Ï€Î±ÏÎ¬Î´Î¿ÏƒÎ· Ï„Î¿Ï… Î±Î½ÎµÎ¾Î¬ÏÏ„Î·Ï„Î±.
                        </MudAlert>
                    }
                <MudGrid>
                    <MudItem xs="12" md="3">
                        <MudPaper Class="pa-4 text-center" Elevation="0">
                            <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Size="Size.Large" Color="Color.Info" Class="mb-2" />
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î± ÎˆÎ½Î±ÏÎ¾Î·Ï‚</MudText>
                            <MudText Typo="Typo.h6">@periodStart.ToString("dd/MM/yyyy")</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" md="3">
                        <MudPaper Class="pa-4 text-center" Elevation="0" Style="background-color: #e8f5e9;">
                            <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Size="Size.Large" Color="Color.Success" Class="mb-2" />
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Î£Ï…Î½Î¿Î»Î¹ÎºÎ­Ï‚ Î•Î¹ÏƒÏ€ÏÎ¬Î¾ÎµÎ¹Ï‚</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Success">â‚¬@totalCollections.ToString("N2")</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" md="3">
                        <MudPaper Class="pa-4 text-center" Elevation="0" Style="background-color: #ffebee;">
                            <MudIcon Icon="@Icons.Material.Filled.TrendingDown" Size="Size.Large" Color="Color.Error" Class="mb-2" />
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÎˆÎ¾Î¿Î´Î±</MudText>
                            <MudText Typo="Typo.h6" Color="Color.Error">â‚¬@totalExpenses.ToString("N2")</MudText>
                        </MudPaper>
                    </MudItem>
                    <MudItem xs="12" md="3">
                        <MudPaper Class="pa-4 text-center" Elevation="0" Style="background-color: #e3f2fd;">
                            <MudIcon Icon="@Icons.Material.Filled.AccountBalanceWallet" Size="Size.Large" Color="Color.Primary" Class="mb-2" />
                            <MudText Typo="Typo.body2" Color="Color.Secondary">ÎšÎ±Î¸Î±ÏÏŒ Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿</MudText>
                            <MudText Typo="Typo.h6" Color="@(netBalance >= 0 ? Color.Primary : Color.Error)">
                                â‚¬@netBalance.ToString("N2")
                            </MudText>
                        </MudPaper>
                    </MudItem>
                </MudGrid>

                <MudDivider Class="my-4" />

                <MudTextField @bind-Value="handoverNotes"
                              Label="Î£Î·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ Î Î±ÏÎ¬Î´Î¿ÏƒÎ·Ï‚"
                              Variant="Variant.Outlined"
                              Lines="3"
                              HelperText="Î ÏÎ¿ÏƒÎ¸Î­ÏƒÏ„Îµ Ï„Ï…Ï‡ÏŒÎ½ Ï€Î±ÏÎ±Ï„Î·ÏÎ®ÏƒÎµÎ¹Ï‚ Î® ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ Î³Î¹Î± Î±Ï…Ï„Î® Ï„Î·Î½ Ï€Î±ÏÎ¬Î´Î¿ÏƒÎ·" />
            </MudCardContent>
            <MudCardActions Class="d-flex justify-center pa-4">
                <MudButton Variant="Variant.Filled"
                           Color="Color.Success"
                           Size="Size.Large"
                           StartIcon="@Icons.Material.Filled.CheckCircle"
                           OnClick="CreateHandover"
                           Disabled="processing">
                    @if (processing)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±...</span>
                    }
                    else
                    {
                        <span>@(canSelectCashier ? "Î Î±ÏÎ±Î»Î±Î²Î® Î¤Î±Î¼ÎµÎ¯Î¿Ï…" : "Î Î±ÏÎ¬Î´Î¿ÏƒÎ· Î¤Î±Î¼ÎµÎ¯Î¿Ï…")</span>
                    }
                </MudButton>
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Default"
                           Size="Size.Large"
                           StartIcon="@Icons.Material.Filled.History"
                           OnClick="ViewHistory">
                    Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î Î±ÏÎ±Î´ÏŒÏƒÎµÏ‰Î½
                </MudButton>
            </MudCardActions>
        </MudCard>
        }

        <!-- Pending Handovers (Admin/Owner Only) -->
        <AuthorizeView Roles="Admin,Owner" Context="adminContext">
            <Authorized>
                @if (pendingHandovers.Any())
                {
                    <MudCard Elevation="3" Class="mb-6">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">â³ Î•ÎºÎºÏÎµÎ¼ÎµÎ¯Ï‚ Î Î±ÏÎ±Î´ÏŒÏƒÎµÎ¹Ï‚</MudText>
                            </CardHeaderContent>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudTable Items="@pendingHandovers" Hover="true" Dense="true">
                                <HeaderContent>
                                    <MudTh>Î¤Î±Î¼ÎµÎ¯Î±Ï‚</MudTh>
                                    <MudTh>Î ÎµÏÎ¯Î¿Î´Î¿Ï‚</MudTh>
                                    <MudTh>Î•Î¹ÏƒÏ€ÏÎ¬Î¾ÎµÎ¹Ï‚</MudTh>
                                    <MudTh>ÎˆÎ¾Î¿Î´Î±</MudTh>
                                    <MudTh>Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿</MudTh>
                                    <MudTh>Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±</MudTh>
                                    <MudTh>Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚</MudTh>
                                </HeaderContent>
                                <RowTemplate Context="handoverRow">
                                    <MudTd DataLabel="Î¤Î±Î¼ÎµÎ¯Î±Ï‚">@handoverRow.Cashier.FullName</MudTd>
                                    <MudTd DataLabel="Î ÎµÏÎ¯Î¿Î´Î¿Ï‚">
                                        @handoverRow.PeriodStartDate.ToString("dd/MM/yyyy") - @handoverRow.PeriodEndDate.ToString("dd/MM/yyyy")
                                    </MudTd>
                                    <MudTd DataLabel="Î•Î¹ÏƒÏ€ÏÎ¬Î¾ÎµÎ¹Ï‚">
                                        <MudText Color="Color.Success">â‚¬@handoverRow.TotalCollections.ToString("N2")</MudText>
                                    </MudTd>
                                    <MudTd DataLabel="ÎˆÎ¾Î¿Î´Î±">
                                        <MudText Color="Color.Error">â‚¬@handoverRow.TotalExpenses.ToString("N2")</MudText>
                                    </MudTd>
                                    <MudTd DataLabel="Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿">
                                        <MudText Color="@(handoverRow.NetBalance >= 0 ? Color.Primary : Color.Error)" Typo="Typo.body1" Style="font-weight: 600;">
                                            â‚¬@handoverRow.NetBalance.ToString("N2")
                                        </MudText>
                                    </MudTd>
                                    <MudTd DataLabel="Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±">@handoverRow.CreatedDate.ToString("dd/MM/yyyy HH:mm")</MudTd>
                                    <MudTd DataLabel="Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚">
                                        <MudButtonGroup Variant="Variant.Text" Size="Size.Small">
                                            <MudButton Color="Color.Success"
                                                       StartIcon="@Icons.Material.Filled.Check"
                                                       OnClick="@(() => ConfirmHandover(handoverRow.Id))">
                                                Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·
                                            </MudButton>
                                            <MudButton Color="Color.Error"
                                                       StartIcon="@Icons.Material.Filled.Close"
                                                       OnClick="@(() => RejectHandover(handoverRow.Id))">
                                                Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ·
                                            </MudButton>
                                        </MudButtonGroup>
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        </MudCardContent>
                    </MudCard>
                }
            </Authorized>
        </AuthorizeView>

        <!-- Information Panel -->
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                Î Î»Î·ÏÎ¿Ï†Î¿ÏÎ¯ÎµÏ‚
            </MudText>
            <MudText Typo="Typo.body2" Class="mb-2">
                â€¢ ÎšÎ¬Î¸Îµ Ï„Î±Î¼ÎµÎ¯Î±Ï‚ ÎºÎ¬Î½ÎµÎ¹ Ï„Î·Î½ Ï€Î±ÏÎ¬Î´Î¿ÏƒÎ· Ï„Î¿Ï… Î±Î½ÎµÎ¾Î¬ÏÏ„Î·Ï„Î± Î±Ï€ÏŒ Ï„Î¿Ï…Ï‚ Î¬Î»Î»Î¿Ï…Ï‚ Ï„Î±Î¼ÎµÎ¯ÎµÏ‚
            </MudText>
            <MudText Typo="Typo.body2" Class="mb-2">
                â€¢ Î— Ï€Î±ÏÎ¬Î´Î¿ÏƒÎ· ÎºÎ±Ï„Î±Î³ÏÎ¬Ï†ÎµÎ¹ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ ÎµÎ¹ÏƒÏ€ÏÎ¬Î¾ÎµÎ¹Ï‚ ÎºÎ±Î¹ Ï„Î± Î­Î¾Î¿Î´Î± Î±Ï€ÏŒ Ï„Î·Î½ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± ÏƒÎ±Ï‚ Ï€Î±ÏÎ¬Î´Î¿ÏƒÎ· Î¼Î­Ï‡ÏÎ¹ ÏƒÎ®Î¼ÎµÏÎ±
            </MudText>
            <MudText Typo="Typo.body2" Class="mb-2">
                â€¢ ÎœÎµÏ„Î¬ Ï„Î·Î½ Ï€Î±ÏÎ¬Î´Î¿ÏƒÎ·, Î· Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Ï€ÎµÏÎ¯Î¿Î´ÏŒÏ‚ ÏƒÎ±Ï‚ ÎºÎ»ÎµÎ¯Î½ÎµÎ¹ ÎºÎ±Î¹ Î¾ÎµÎºÎ¹Î½Î¬ Î¼Î¹Î± Î½Î­Î± Ï€ÎµÏÎ¯Î¿Î´Î¿Ï‚ Î±Ï€ÏŒ Ï„Î¿ Î¼Î·Î´Î­Î½
            </MudText>
            <MudText Typo="Typo.body2" Class="mb-2">
                â€¢ ÎŸÎ¹ Ï€Î±ÏÎ±Î´ÏŒÏƒÎµÎ¹Ï‚ Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÏ€Î¹Î²ÎµÎ²Î±Î¹Ï‰Î¸Î¿ÏÎ½ Î±Ï€ÏŒ Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î® Î® Î™Î´Î¹Î¿ÎºÏ„Î®Ï„Î·
            </MudText>
            <MudText Typo="Typo.body2">
                â€¢ ÎœÏ€Î¿ÏÎµÎ¯Ï„Îµ Î½Î± Î´ÎµÎ¯Ï„Îµ Ï„Î¿ Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Ï„Ï‰Î½ Î´Î¹ÎºÏÎ½ ÏƒÎ±Ï‚ Ï€Î±ÏÎ±Î´ÏŒÏƒÎµÏ‰Î½ ÏƒÏ„Î·Î½ ÎºÎ±ÏÏ„Î­Î»Î± "Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î Î±ÏÎ±Î´ÏŒÏƒÎµÏ‰Î½"
            </MudText>
        </MudPaper>
    }
</MudContainer>

@code {
    private User? currentUser;
    private User? selectedCashier;
    private bool loading = true;
    private bool processing = false;
    private bool canSelectCashier = false;

    private DateTime periodStart;
    private decimal totalCollections;
    private decimal totalExpenses;
    private decimal netBalance;
    private string handoverNotes = string.Empty;

    private List<CashierHandover> pendingHandovers = new();
    private List<User> allCashiers = new();

    protected override async Task OnInitializedAsync()
    {
        currentUser = await SessionService.GetCurrentUserAsync();
        if (currentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        // Determine if user can select cashier
        canSelectCashier = currentUser.Role == UserRole.Admin || currentUser.Role == UserRole.Owner;

        if (canSelectCashier)
        {
            // Admin/Owner: load cashiers list
            await LoadCashiers();
            loading = false;
        }
        else
        {
            // Treasurer: use their own data
            selectedCashier = currentUser;
            await LoadData();
        }
    }

    private async Task LoadCashiers()
    {
        try
        {
            using var context = ContextFactory.CreateDbContext();
            allCashiers = await context.Users
                .Where(u => u.Role == UserRole.Treasurer && u.IsActive)
                .OrderBy(u => u.LastName)
                .ThenBy(u => u.FirstName)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Ï„Î±Î¼Î¹ÏÎ½: {ex.Message}", Severity.Error);
        }
    }

    private async Task<IEnumerable<User>> SearchCashiers(string value, CancellationToken token)
    {
        if (string.IsNullOrWhiteSpace(value))
            return allCashiers.Take(10);

        return allCashiers
            .Where(u => u.FullName.Contains(value, StringComparison.OrdinalIgnoreCase) ||
                       u.Username.Contains(value, StringComparison.OrdinalIgnoreCase))
            .Take(10);
    }

    private async Task OnCashierChanged(User? cashier)
    {
        selectedCashier = cashier;
        if (selectedCashier != null)
        {
            await LoadData();
        }
    }

    private async Task LoadData()
    {
        if (selectedCashier == null) return;

        loading = true;
        try
        {
            // Load current period summary for the selected cashier
            var summary = await HandoverService.GetCashierCurrentPeriodSummaryAsync(selectedCashier.Id);
            periodStart = summary.PeriodStart == DateTime.MinValue ? DateTime.Now : summary.PeriodStart;
            totalCollections = summary.TotalCollections;
            totalExpenses = summary.TotalExpenses;
            netBalance = summary.NetBalance;

            // Load pending handovers if admin/owner
            if (currentUser != null && (currentUser.Role == UserRole.Admin || currentUser.Role == UserRole.Owner))
            {
                pendingHandovers = await HandoverService.GetPendingHandoversAsync();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task CreateHandover()
    {
        if (currentUser == null || selectedCashier == null) return;

        var title = canSelectCashier ? "Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Î Î±ÏÎ±Î»Î±Î²Î®Ï‚" : "Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Î Î±ÏÎ¬Î´Î¿ÏƒÎ·Ï‚";
        var message = canSelectCashier
            ? $"Î Î±ÏÎ±Î»Î±Î²Î® Î¤Î±Î¼ÎµÎ¯Î¿Ï… Î±Ï€ÏŒ: {selectedCashier.FullName}\n\n" +
              $"Î˜Î­Î»ÎµÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± Ï€Î±ÏÎ±Î»Î¬Î²ÎµÏ„Îµ Ï„Î¿ Ï„Î±Î¼ÎµÎ¯Î¿;\n\n" +
              $"Î£Ï…Î½Î¿Î»Î¹ÎºÎ­Ï‚ Î•Î¹ÏƒÏ€ÏÎ¬Î¾ÎµÎ¹Ï‚: â‚¬{totalCollections:N2}\n" +
              $"Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÎˆÎ¾Î¿Î´Î±: â‚¬{totalExpenses:N2}\n" +
              $"ÎšÎ±Î¸Î±ÏÏŒ Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: â‚¬{netBalance:N2}\n\n" +
              $"ÎœÎµÏ„Î¬ Ï„Î·Î½ Ï€Î±ÏÎ±Î»Î±Î²Î®, Î· Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Ï€ÎµÏÎ¯Î¿Î´Î¿Ï‚ Ï„Î¿Ï… Ï„Î±Î¼Î¯Î± Î¸Î± ÎºÎ»ÎµÎ¯ÏƒÎµÎ¹."
            : $"Î Î±ÏÎ¬Î´Î¿ÏƒÎ· Î¤Î±Î¼ÎµÎ¯Î¿Ï…: {selectedCashier.FullName}\n\n" +
              $"Î˜Î­Î»ÎµÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± ÎºÎ¬Î½ÎµÏ„Îµ Ï€Î±ÏÎ¬Î´Î¿ÏƒÎ· Ï„Î±Î¼ÎµÎ¯Î¿Ï…;\n\n" +
              $"Î£Ï…Î½Î¿Î»Î¹ÎºÎ­Ï‚ Î•Î¹ÏƒÏ€ÏÎ¬Î¾ÎµÎ¹Ï‚: â‚¬{totalCollections:N2}\n" +
              $"Î£Ï…Î½Î¿Î»Î¹ÎºÎ¬ ÎˆÎ¾Î¿Î´Î±: â‚¬{totalExpenses:N2}\n" +
              $"ÎšÎ±Î¸Î±ÏÏŒ Î¥Ï€ÏŒÎ»Î¿Î¹Ï€Î¿: â‚¬{netBalance:N2}\n\n" +
              $"ÎœÎµÏ„Î¬ Ï„Î·Î½ Ï€Î±ÏÎ¬Î´Î¿ÏƒÎ·, Î· Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ± Ï€ÎµÏÎ¯Î¿Î´ÏŒÏ‚ ÏƒÎ±Ï‚ Î¸Î± ÎºÎ»ÎµÎ¯ÏƒÎµÎ¹.";

        var result = await DialogService.ShowMessageBox(
            title,
            message,
            yesText: "Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·",
            cancelText: "Î‘ÎºÏÏÏ‰ÏƒÎ·");

        if (result != true) return;

        processing = true;
        try
        {
            var handover = await HandoverService.CreateHandoverAsync(selectedCashier.Id, handoverNotes);

            var successMessage = canSelectCashier
                ? "Î— Ï€Î±ÏÎ±Î»Î±Î²Î® Ï„Î±Î¼ÎµÎ¯Î¿Ï… ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®Î¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!"
                : "Î— Ï€Î±ÏÎ¬Î´Î¿ÏƒÎ· Ï„Î±Î¼ÎµÎ¯Î¿Ï… ÎºÎ±Ï„Î±Ï‡Ï‰ÏÎ®Î¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚! Î‘Î½Î±Î¼Î­Î½ÎµÎ¹ ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Î±Ï€ÏŒ Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®.";

            Snackbar.Add(successMessage, Severity.Success);

            // Reset form and reload data
            handoverNotes = string.Empty;
            await LoadData();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î·Î½ Ï€Î±ÏÎ¬Î´Î¿ÏƒÎ· Ï„Î±Î¼ÎµÎ¯Î¿Ï…: {ex.Message}", Severity.Error);
        }
        finally
        {
            processing = false;
        }
    }

    private async Task ConfirmHandover(int handoverId)
    {
        if (currentUser == null) return;

        var result = await DialogService.ShowMessageBox(
            "Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Î Î±ÏÎ¬Î´Î¿ÏƒÎ·Ï‚",
            "Î˜Î­Î»ÎµÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± ÎµÏ€Î¹Î²ÎµÎ²Î±Î¹ÏÏƒÎµÏ„Îµ Î±Ï…Ï„Î® Ï„Î·Î½ Ï€Î±ÏÎ¬Î´Î¿ÏƒÎ· Ï„Î±Î¼ÎµÎ¯Î¿Ï…;",
            yesText: "Î•Ï€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ·",
            cancelText: "Î‘ÎºÏÏÏ‰ÏƒÎ·");

        if (result != true) return;

        try
        {
            var success = await HandoverService.ConfirmHandoverAsync(handoverId, currentUser.Id);
            if (success)
            {
                Snackbar.Add("Î— Ï€Î±ÏÎ¬Î´Î¿ÏƒÎ· ÎµÏ€Î¹Î²ÎµÎ²Î±Î¹ÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!", Severity.Success);
                await LoadData();
            }
            else
            {
                Snackbar.Add("Î”ÎµÎ½ Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„Î® Î· ÎµÏ€Î¹Î²ÎµÎ²Î±Î¯Ï‰ÏƒÎ· Ï„Î·Ï‚ Ï€Î±ÏÎ¬Î´Î¿ÏƒÎ·Ï‚.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î±: {ex.Message}", Severity.Error);
        }
    }

    private async Task RejectHandover(int handoverId)
    {
        if (currentUser == null) return;

        // Prompt for rejection reason
        var parameters = new DialogParameters
        {
            { "Reason", "" }
        };
        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.Small };

        // You would create a simple dialog component for this, or use a simple input
        var result = await DialogService.ShowMessageBox(
            "Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ· Î Î±ÏÎ¬Î´Î¿ÏƒÎ·Ï‚",
            "Î˜Î­Î»ÎµÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ± Î½Î± Î±Ï€Î¿ÏÏÎ¯ÏˆÎµÏ„Îµ Î±Ï…Ï„Î® Ï„Î·Î½ Ï€Î±ÏÎ¬Î´Î¿ÏƒÎ· Ï„Î±Î¼ÎµÎ¯Î¿Ï…;\n(Î Î±ÏÎ±ÎºÎ±Î»Ï ÎºÎ±Ï„Î±Î³ÏÎ¬ÏˆÏ„Îµ Ï„Î¿Î½ Î»ÏŒÎ³Î¿ ÏƒÏ„Î¹Ï‚ ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚)",
            yesText: "Î‘Ï€ÏŒÏÏÎ¹ÏˆÎ·",
            cancelText: "Î‘ÎºÏÏÏ‰ÏƒÎ·");

        if (result != true) return;

        try
        {
            var success = await HandoverService.RejectHandoverAsync(handoverId, currentUser.Id, "Î‘Ï€Î¿ÏÏÎ¯Ï†Î¸Î·ÎºÎµ Î±Ï€ÏŒ Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®");
            if (success)
            {
                Snackbar.Add("Î— Ï€Î±ÏÎ¬Î´Î¿ÏƒÎ· Î±Ï€Î¿ÏÏÎ¯Ï†Î¸Î·ÎºÎµ.", Severity.Info);
                await LoadData();
            }
            else
            {
                Snackbar.Add("Î”ÎµÎ½ Î®Ï„Î±Î½ Î´Ï…Î½Î±Ï„Î® Î· Î±Ï€ÏŒÏÏÎ¹ÏˆÎ· Ï„Î·Ï‚ Ï€Î±ÏÎ¬Î´Î¿ÏƒÎ·Ï‚.", Severity.Warning);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î±: {ex.Message}", Severity.Error);
        }
    }

    private void ViewHistory()
    {
        Navigation.NavigateTo("/handover-history");
    }
}
