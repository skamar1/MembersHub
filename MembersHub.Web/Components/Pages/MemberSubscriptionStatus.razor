@page "/financial/member-subscription-status"
@using MembersHub.Core.Entities
@using MembersHub.Core.Interfaces
@using MembersHub.Infrastructure.Data
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@inject IDbContextFactory<MembersHubContext> ContextFactory
@inject ISnackbar Snackbar
@inject ISessionService SessionService
@inject NavigationManager Navigation
@attribute [Authorize(Roles = "Admin,Owner,Treasurer")]

<PageTitle>ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î£Ï…Î½Î´ÏÎ¿Î¼ÏÎ½ ÎœÎµÎ»ÏÎ½ - MembersHub</PageTitle>

<style>
    .subscription-table {
        font-size: 0.85rem;
    }

    .subscription-table th {
        background-color: #f5f5f5;
        font-weight: 600;
        text-align: center;
        padding: 8px 4px;
        border: 1px solid #ddd;
        white-space: nowrap;
    }

    .subscription-table td {
        text-align: center;
        padding: 8px 4px;
        border: 1px solid #ddd;
    }

    .member-name-cell {
        text-align: left !important;
        font-weight: 500;
        white-space: nowrap;
    }

    .status-paid {
        background-color: white;
        color: black;
    }

    .status-unpaid {
        background-color: #2196F3;
        color: white;
        font-weight: 500;
    }

    .status-overpaid {
        background-color: #9E9E9E;
        color: white;
    }

    .status-stopped {
        background-color: #F44336;
        color: white;
    }

    .status-future {
        background-color: #FFC107;
        color: black;
    }

    .status-empty {
        background-color: #f9f9f9;
        color: #ccc;
    }

    .total-column {
        background-color: #e3f2fd;
        font-weight: 600;
    }

    @@media print {
        .no-print {
            display: none !important;
        }

        .subscription-table {
            font-size: 0.7rem;
        }

        .subscription-table th,
        .subscription-table td {
            padding: 4px 2px;
        }
    }
</style>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <div class="d-flex justify-space-between align-center mb-4 no-print">
        <MudText Typo="Typo.h4">ğŸ“Š ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ· Î£Ï…Î½Î´ÏÎ¿Î¼ÏÎ½ ÎœÎµÎ»ÏÎ½</MudText>
        <MudButtonGroup>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Print"
                       OnClick="@(() => JSRuntime.InvokeVoidAsync("window.print"))">
                Î•ÎºÏ„ÏÏ€Ï‰ÏƒÎ·
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Secondary"
                       StartIcon="@Icons.Material.Filled.Refresh"
                       OnClick="LoadData">
                Î‘Î½Î±Î½Î­Ï‰ÏƒÎ·
            </MudButton>
        </MudButtonGroup>
    </div>

    <!-- Date Range Selection -->
    <MudCard Class="mb-4 no-print">
        <MudCardContent>
            <MudGrid>
                <MudItem xs="12" sm="4">
                    <MudDatePicker Label="Î‘Ï€ÏŒ"
                                   @bind-Date="startDate"
                                   DateFormat="MM/yyyy"
                                   OpenTo="OpenTo.Month"
                                   FixMonth="@startDate?.Month"
                                   FixYear="@startDate?.Year" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudDatePicker Label="ÎˆÏ‰Ï‚"
                                   @bind-Date="endDate"
                                   DateFormat="MM/yyyy"
                                   OpenTo="OpenTo.Month"
                                   FixMonth="@endDate?.Month"
                                   FixYear="@endDate?.Year" />
                </MudItem>
                <MudItem xs="12" sm="4">
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               FullWidth="true"
                               OnClick="LoadData"
                               Class="mt-3">
                        Î•Ï†Î±ÏÎ¼Î¿Î³Î®
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudCardContent>
    </MudCard>

    <!-- Legend -->
    <MudPaper Class="pa-3 mb-4 no-print" Elevation="2">
        <MudText Typo="Typo.h6" Class="mb-2">Î¥Ï€ÏŒÎ¼Î½Î·Î¼Î± Î§ÏÏ‰Î¼Î¬Ï„Ï‰Î½:</MudText>
        <MudGrid>
            <MudItem xs="6" sm="4" md="2">
                <MudChip T="string" Color="Color.Default" Style="background-color: white; border: 1px solid #ddd;">Î Î»Î·ÏÏ‰Î¼Î­Î½Î¿</MudChip>
            </MudItem>
            <MudItem xs="6" sm="4" md="2">
                <MudChip T="string" Style="background-color: #2196F3; color: white;">Î•ÎºÎºÏÎµÎ¼ÎµÎ¯</MudChip>
            </MudItem>
            <MudItem xs="6" sm="4" md="2">
                <MudChip T="string" Style="background-color: #9E9E9E; color: white;">Î ÏÎ¿Ï€Î»Î·ÏÏ‰Î¼Î®</MudChip>
            </MudItem>
            <MudItem xs="6" sm="4" md="2">
                <MudChip T="string" Style="background-color: #F44336; color: white;">Î”Î¹Î±ÎºÎ¿Ï€Î®</MudChip>
            </MudItem>
            <MudItem xs="6" sm="4" md="2">
                <MudChip T="string" Style="background-color: #FFC107; color: black;">ÎœÎµÎ»Î»Î¿Î½Ï„Î¹ÎºÏŒ</MudChip>
            </MudItem>
        </MudGrid>
    </MudPaper>

    @if (loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" />
    }
    else if (memberStatusData.Any())
    {
        <MudPaper Elevation="3" Class="pa-0">
            <div style="overflow-x: auto;">
                <table class="subscription-table" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="min-width: 50px;">Î‘/Î‘</th>
                            <th style="min-width: 80px;">Î¤Î¼Î®Î¼Î±</th>
                            <th style="min-width: 200px;">Î•Ï€ÏÎ½Ï…Î¼Î¿ ÎŒÎ½Î¿Î¼Î±</th>
                            @foreach (var month in monthColumns)
                            {
                                <th style="min-width: 60px;">@month.ShortName</th>
                            }
                            <th style="min-width: 80px;">Î£ÏÎ½Î¿Î»Î¿</th>
                        </tr>
                    </thead>
                    <tbody>
                        @{
                            int rowNumber = 1;
                        }
                        @foreach (var memberStatus in memberStatusData)
                        {
                            <tr>
                                <td>@rowNumber</td>
                                <td>@memberStatus.Department</td>
                                <td class="member-name-cell">@memberStatus.FullName</td>
                                @foreach (var month in monthColumns)
                                {
                                    var status = memberStatus.MonthlyStatus.FirstOrDefault(m => m.Year == month.Year && m.Month == month.Month);
                                    <td class="@GetStatusClass(status)">
                                        @if (status != null && status.Amount > 0)
                                        {
                                            @status.Amount.ToString("N0")
                                        }
                                    </td>
                                }
                                <td class="total-column">@memberStatus.TotalPaid.ToString("N0")</td>
                            </tr>
                            rowNumber++;
                        }
                    </tbody>
                </table>
            </div>
        </MudPaper>
    }
    else
    {
        <MudAlert Severity="Severity.Info">Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Î´ÎµÎ´Î¿Î¼Î­Î½Î± Î³Î¹Î± Ï„Î¿ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿ Ï‡ÏÎ¿Î½Î¹ÎºÏŒ Î´Î¹Î¬ÏƒÏ„Î·Î¼Î±.</MudAlert>
    }
</MudContainer>

@code {
    [Inject] private IJSRuntime JSRuntime { get; set; } = default!;

    private bool loading = true;
    private DateTime? startDate = new DateTime(DateTime.Now.Year, 1, 1);
    private DateTime? endDate = DateTime.Now;
    private List<MonthColumn> monthColumns = new();
    private List<MemberSubscriptionStatusData> memberStatusData = new();

    public class MonthColumn
    {
        public int Year { get; set; }
        public int Month { get; set; }
        public string ShortName { get; set; } = "";
        public string FullName { get; set; } = "";
    }

    public class MonthlyStatusInfo
    {
        public int Year { get; set; }
        public int Month { get; set; }
        public decimal Amount { get; set; }
        public SubscriptionStatusType Status { get; set; }
    }

    public enum SubscriptionStatusType
    {
        Empty,          // Î”ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®
        Paid,           // Î Î»Î·ÏÏ‰Î¼Î­Î½Î¿ ÎºÎ±Î½Î¿Î½Î¹ÎºÎ¬
        Unpaid,         // Î•ÎºÎºÏÎµÎ¼ÎµÎ¯ Ï€Î»Î·ÏÏ‰Î¼Î®
        Overpaid,       // Î ÏÎ¿Ï€Î»Î·ÏÏ‰Î¼Î® (Ï€Î»Î®ÏÏ‰ÏƒÎµ Î³Î¹Î± Ï€Î¿Î»Î»Î¿ÏÏ‚ Î¼Î®Î½ÎµÏ‚)
        Stopped,        // Î”Î¹Î±ÎºÎ¿Ï€Î® ÏƒÏ…Î½Î´ÏÎ¿Î¼Î®Ï‚
        Future          // ÎœÎµÎ»Î»Î¿Î½Ï„Î¹ÎºÎ® ÏƒÏ…Î½Î´ÏÎ¿Î¼Î® (Î´ÎµÎ½ ÎµÎ¯Ï‡Îµ Ï€ÏÎ¹Î½)
    }

    public class MemberSubscriptionStatusData
    {
        public int MemberId { get; set; }
        public string FullName { get; set; } = "";
        public string Department { get; set; } = "";
        public List<MonthlyStatusInfo> MonthlyStatus { get; set; } = new();
        public decimal TotalPaid { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        var currentUser = await SessionService.GetCurrentUserAsync();
        if (currentUser == null)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        await LoadData();
    }

    private async Task LoadData()
    {
        loading = true;
        try
        {
            if (startDate == null || endDate == null)
            {
                Snackbar.Add("Î Î±ÏÎ±ÎºÎ±Î»Ï ÎµÏ€Î¹Î»Î­Î¾Ï„Îµ Ï‡ÏÎ¿Î½Î¹ÎºÏŒ Î´Î¹Î¬ÏƒÏ„Î·Î¼Î±", Severity.Warning);
                return;
            }

            // Generate month columns
            GenerateMonthColumns();

            using var context = ContextFactory.CreateDbContext();

            // Get all active members
            var members = await context.Members
                .Where(m => m.Status == MemberStatus.Active)
                .OrderBy(m => m.LastName)
                .ThenBy(m => m.FirstName)
                .ToListAsync();

            // Get all subscriptions in date range
            var subscriptions = await context.Subscriptions
                .Include(s => s.Member)
                .Where(s => (s.Year > startDate.Value.Year || (s.Year == startDate.Value.Year && s.Month >= startDate.Value.Month)) &&
                           (s.Year < endDate.Value.Year || (s.Year == endDate.Value.Year && s.Month <= endDate.Value.Month)))
                .ToListAsync();

            // Get all payments in date range with their subscription allocations
            var payments = await context.Payments
                .Where(p => p.Status == PaymentStatus.Confirmed &&
                           p.PaymentDate >= startDate.Value &&
                           p.PaymentDate <= endDate.Value)
                .ToListAsync();

            memberStatusData = new List<MemberSubscriptionStatusData>();

            foreach (var member in members)
            {
                var memberSubscriptions = subscriptions.Where(s => s.MemberId == member.Id).ToList();

                // Skip members with no subscriptions in this period
                if (!memberSubscriptions.Any())
                    continue;

                var memberData = new MemberSubscriptionStatusData
                {
                    MemberId = member.Id,
                    FullName = $"{member.LastName} {member.FirstName}",
                    Department = member.MemberNumber.StartsWith("VA") ? "VA" :
                                member.MemberNumber.StartsWith("VAR") ? "VAR" :
                                member.MemberNumber.StartsWith("TE") ? "TE" : "N/A",
                    MonthlyStatus = new List<MonthlyStatusInfo>()
                };

                decimal totalPaid = 0;

                foreach (var monthCol in monthColumns)
                {
                    var subscription = memberSubscriptions
                        .FirstOrDefault(s => s.Year == monthCol.Year && s.Month == monthCol.Month);

                    if (subscription != null)
                    {
                        var status = DetermineSubscriptionStatus(
                            subscription,
                            memberSubscriptions,
                            payments.Where(p => p.MemberId == member.Id).ToList(),
                            monthCol);

                        memberData.MonthlyStatus.Add(new MonthlyStatusInfo
                        {
                            Year = monthCol.Year,
                            Month = monthCol.Month,
                            Amount = subscription.Amount,
                            Status = status
                        });

                        if (subscription.Status == SubscriptionStatus.Paid)
                        {
                            totalPaid += subscription.Amount;
                        }
                    }
                    else
                    {
                        // Check if this is a gap before future subscriptions (yellow)
                        var hasFutureSubscriptions = memberSubscriptions.Any(s =>
                            s.Year > monthCol.Year || (s.Year == monthCol.Year && s.Month > monthCol.Month));

                        var hasPastSubscriptions = memberSubscriptions.Any(s =>
                            s.Year < monthCol.Year || (s.Year == monthCol.Year && s.Month < monthCol.Month));

                        if (hasFutureSubscriptions && hasPastSubscriptions)
                        {
                            memberData.MonthlyStatus.Add(new MonthlyStatusInfo
                            {
                                Year = monthCol.Year,
                                Month = monthCol.Month,
                                Amount = 0,
                                Status = SubscriptionStatusType.Future
                            });
                        }
                        else
                        {
                            memberData.MonthlyStatus.Add(new MonthlyStatusInfo
                            {
                                Year = monthCol.Year,
                                Month = monthCol.Month,
                                Amount = 0,
                                Status = SubscriptionStatusType.Empty
                            });
                        }
                    }
                }

                memberData.TotalPaid = totalPaid;
                memberStatusData.Add(memberData);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± ÎºÎ±Ï„Î¬ Ï„Î· Ï†ÏŒÏÏ„Ï‰ÏƒÎ· Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private SubscriptionStatusType DetermineSubscriptionStatus(
        Subscription subscription,
        List<Subscription> allMemberSubscriptions,
        List<Payment> memberPayments,
        MonthColumn currentMonth)
    {
        // Check if subscription is paid
        if (subscription.Status == SubscriptionStatus.Paid)
        {
            // Check if this month was paid as part of a multi-month payment (overpaid/gray)
            var paymentForThisSubscription = memberPayments
                .Where(p => p.SubscriptionId == subscription.Id)
                .OrderBy(p => p.PaymentDate)
                .FirstOrDefault();

            if (paymentForThisSubscription != null)
            {
                // Check if payment amount covers multiple months
                var monthsCouldCover = (int)(paymentForThisSubscription.Amount / subscription.Amount);

                if (monthsCouldCover > 1)
                {
                    // This is part of a multi-month payment
                    return SubscriptionStatusType.Overpaid;
                }
            }

            return SubscriptionStatusType.Paid;
        }

        // Check if subscription is unpaid (blue)
        if (subscription.Status == SubscriptionStatus.Pending || subscription.Status == SubscriptionStatus.Overdue)
        {
            return SubscriptionStatusType.Unpaid;
        }

        // Check if this is where subscription stopped (red)
        var nextMonth = currentMonth.Month == 12 ? 1 : currentMonth.Month + 1;
        var nextYear = currentMonth.Month == 12 ? currentMonth.Year + 1 : currentMonth.Year;

        var hasNextSubscription = allMemberSubscriptions.Any(s =>
            s.Year == nextYear && s.Month == nextMonth);

        if (!hasNextSubscription && subscription.Status != SubscriptionStatus.Paid)
        {
            return SubscriptionStatusType.Stopped;
        }

        return SubscriptionStatusType.Paid;
    }

    private void GenerateMonthColumns()
    {
        monthColumns.Clear();

        if (startDate == null || endDate == null)
            return;

        var current = new DateTime(startDate.Value.Year, startDate.Value.Month, 1);
        var end = new DateTime(endDate.Value.Year, endDate.Value.Month, 1);

        var greekMonths = new[] { "", "Î™Î‘Î", "Î¦Î•Î’", "ÎœÎ‘Î¡", "Î‘Î Î¡", "ÎœÎ‘Î™", "Î™ÎŸÎ¥Î", "Î™ÎŸÎ¥Î›", "Î‘Î¥Î“", "Î£Î•Î ", "ÎŸÎšÎ¤", "ÎÎŸÎ•", "Î”Î•Îš" };
        var greekMonthsFull = new[] { "", "Î™Î±Î½Î¿Ï…Î¬ÏÎ¹Î¿Ï‚", "Î¦ÎµÎ²ÏÎ¿Ï…Î¬ÏÎ¹Î¿Ï‚", "ÎœÎ¬ÏÏ„Î¹Î¿Ï‚", "Î‘Ï€ÏÎ¯Î»Î¹Î¿Ï‚", "ÎœÎ¬Î¹Î¿Ï‚", "Î™Î¿ÏÎ½Î¹Î¿Ï‚",
                                      "Î™Î¿ÏÎ»Î¹Î¿Ï‚", "Î‘ÏÎ³Î¿Ï…ÏƒÏ„Î¿Ï‚", "Î£ÎµÏ€Ï„Î­Î¼Î²ÏÎ¹Î¿Ï‚", "ÎŸÎºÏ„ÏÎ²ÏÎ¹Î¿Ï‚", "ÎÎ¿Î­Î¼Î²ÏÎ¹Î¿Ï‚", "Î”ÎµÎºÎ­Î¼Î²ÏÎ¹Î¿Ï‚" };

        while (current <= end)
        {
            monthColumns.Add(new MonthColumn
            {
                Year = current.Year,
                Month = current.Month,
                ShortName = greekMonths[current.Month],
                FullName = $"{greekMonthsFull[current.Month]} {current.Year}"
            });

            current = current.AddMonths(1);
        }
    }

    private string GetStatusClass(MonthlyStatusInfo? status)
    {
        if (status == null)
            return "status-empty";

        return status.Status switch
        {
            SubscriptionStatusType.Paid => "status-paid",
            SubscriptionStatusType.Unpaid => "status-unpaid",
            SubscriptionStatusType.Overpaid => "status-overpaid",
            SubscriptionStatusType.Stopped => "status-stopped",
            SubscriptionStatusType.Future => "status-future",
            _ => "status-empty"
        };
    }
}
