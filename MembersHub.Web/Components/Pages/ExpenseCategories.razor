@page "/expense-categories"
@using Microsoft.AspNetCore.Authorization
@using MembersHub.Core.Entities
@using MembersHub.Core.Interfaces
@using MembersHub.Web.Components.Dialogs
@attribute [Authorize(Roles = "Owner,Admin")]
@using MudBlazor
@inject IExpenseCategoryService ExpenseCategoryService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· ÎšÎ±Ï„Î·Î³Î¿ÏÎ¹ÏÎ½ Î•Î¾ÏŒÎ´Ï‰Î½ - MembersHub</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Color="Color.Primary">
        ğŸ“‚ Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· ÎšÎ±Ï„Î·Î³Î¿ÏÎ¹ÏÎ½ Î•Î¾ÏŒÎ´Ï‰Î½
    </MudText>

    <MudPaper Class="pa-4 mt-4" Elevation="2">
        <!-- Header Î¼Îµ ÎºÎ¿Ï…Î¼Ï€Î¯ Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ·Ï‚ -->
        <div class="d-flex justify-space-between align-center mb-4">
            <MudText Typo="Typo.h6">
                Î£Ï…Î½Î¿Î»Î¹ÎºÎ­Ï‚ ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚: @categories.Count (@activeCount ÎµÎ½ÎµÏÎ³Î­Ï‚)
            </MudText>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="@OpenCreateDialog">
                ÎÎ­Î± ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±
            </MudButton>
        </div>

        <!-- Search -->
        <MudTextField @bind-Value="searchString"
                      Label="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·..."
                      Variant="Variant.Outlined"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Class="mb-4" />

        <!-- Desktop DataGrid -->
        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <MudDataGrid Items="@filteredCategories"
                         Dense="true"
                         Hover="true"
                         Bordered="true"
                         Striped="true"
                         Loading="@loading"
                         LoadingProgressColor="Color.Primary">
                <Columns>
                    <PropertyColumn Property="x => x.Name" Title="ÎŒÎ½Î¿Î¼Î±" />
                    <PropertyColumn Property="x => x.Description" Title="Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®" />
                    <TemplateColumn Title="Icon">
                        <CellTemplate>
                            @if (!string.IsNullOrEmpty(context.Item.IconName))
                            {
                                <MudIcon Icon="@context.Item.IconName" Size="Size.Small" />
                            }
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Î§ÏÏÎ¼Î±">
                        <CellTemplate>
                            @if (!string.IsNullOrEmpty(context.Item.ColorCode))
                            {
                                <div style="width: 30px; height: 20px; background-color: @context.Item.ColorCode; border: 1px solid #ccc; border-radius: 4px;"></div>
                            }
                        </CellTemplate>
                    </TemplateColumn>
                    <PropertyColumn Property="x => x.DisplayOrder" Title="Î£ÎµÎ¹ÏÎ¬" />
                    <TemplateColumn Title="ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·">
                        <CellTemplate>
                            <MudChip T="string" Size="Size.Small"
                                     Color="@(context.Item.IsActive ? Color.Success : Color.Default)">
                                @(context.Item.IsActive ? "Î•Î½ÎµÏÎ³Î®" : "Î‘Î½ÎµÎ½ÎµÏÎ³Î®")
                            </MudChip>
                        </CellTemplate>
                    </TemplateColumn>
                    <TemplateColumn Title="Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚" Sortable="false">
                        <CellTemplate>
                            <div class="d-flex gap-2">
                                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                               Size="Size.Small"
                                               Color="Color.Primary"
                                               Variant="Variant.Filled"
                                               OnClick="() => EditCategory(context.Item)"
                                               title="Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±" />
                                <MudIconButton Icon="@(context.Item.IsActive ? Icons.Material.Filled.ToggleOff : Icons.Material.Filled.ToggleOn)"
                                               Size="Size.Small"
                                               Color="Color.Warning"
                                               Variant="Variant.Filled"
                                               OnClick="() => ToggleCategoryStatus(context.Item)"
                                               title="@(context.Item.IsActive ? "Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ·" : "Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ·")" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Size="Size.Small"
                                               Color="Color.Error"
                                               Variant="Variant.Filled"
                                               OnClick="() => DeleteCategory(context.Item)"
                                               title="Î”Î¹Î±Î³ÏÎ±Ï†Î®" />
                            </div>
                        </CellTemplate>
                    </TemplateColumn>
                </Columns>
            </MudDataGrid>
        </MudHidden>

        <!-- Mobile Cards -->
        <MudHidden Breakpoint="Breakpoint.MdAndUp">
            <MudGrid>
                @foreach (var category in filteredCategories)
                {
                    <MudItem xs="12">
                        <MudCard Class="mb-3">
                            <MudCardContent>
                                <div class="d-flex justify-space-between align-center mb-2">
                                    <div class="d-flex align-center gap-2">
                                        @if (!string.IsNullOrEmpty(category.IconName))
                                        {
                                            <MudIcon Icon="@category.IconName" Size="Size.Medium" />
                                        }
                                        <MudText Typo="Typo.h6">@category.Name</MudText>
                                    </div>
                                    <MudChip T="string" Size="Size.Small"
                                             Color="@(category.IsActive ? Color.Success : Color.Default)">
                                        @(category.IsActive ? "Î•Î½ÎµÏÎ³Î®" : "Î‘Î½ÎµÎ½ÎµÏÎ³Î®")
                                    </MudChip>
                                </div>
                                @if (!string.IsNullOrEmpty(category.Description))
                                {
                                    <MudText Typo="Typo.body2" Class="mb-2">
                                        @category.Description
                                    </MudText>
                                }
                                <div class="d-flex align-center gap-2">
                                    <MudText Typo="Typo.caption">Î£ÎµÎ¹ÏÎ¬: @category.DisplayOrder</MudText>
                                    @if (!string.IsNullOrEmpty(category.ColorCode))
                                    {
                                        <div style="width: 30px; height: 20px; background-color: @category.ColorCode; border: 1px solid #ccc; border-radius: 4px;"></div>
                                    }
                                </div>
                            </MudCardContent>
                            <MudCardActions>
                                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                               Size="Size.Small"
                                               Color="Color.Primary"
                                               OnClick="() => EditCategory(category)" />
                                <MudIconButton Icon="@(category.IsActive ? Icons.Material.Filled.ToggleOff : Icons.Material.Filled.ToggleOn)"
                                               Size="Size.Small"
                                               Color="Color.Warning"
                                               OnClick="() => ToggleCategoryStatus(category)" />
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Size="Size.Small"
                                               Color="Color.Error"
                                               OnClick="() => DeleteCategory(category)" />
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        </MudHidden>

        @if (!filteredCategories.Any() && !loading)
        {
            <div class="text-center pa-8">
                <MudIcon Icon="@Icons.Material.Filled.Category" Size="Size.Large" Color="Color.Default" />
                <MudText Typo="Typo.h6" Color="Color.Default" Class="mt-2">
                    Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚
                </MudText>
            </div>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<ExpenseCategory> categories = new();
    private bool loading = true;
    private string searchString = "";

    private int activeCount => categories.Count(c => c.IsActive);

    private IEnumerable<ExpenseCategory> filteredCategories => categories.Where(c =>
        string.IsNullOrWhiteSpace(searchString) ||
        c.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
        (c.Description?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false)
    ).OrderBy(c => c.DisplayOrder).ThenBy(c => c.Name);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        loading = true;
        try
        {
            categories = await ExpenseCategoryService.GetAllCategoriesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task OpenCreateDialog()
    {
        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ExpenseCategoryDialog>("ÎÎ­Î± ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î± Î•Î¾ÏŒÎ´Î¿Ï…", options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            await LoadData();
        }
    }

    private async Task EditCategory(ExpenseCategory category)
    {
        var parameters = new DialogParameters<ExpenseCategoryDialog>
        {
            { x => x.ExistingCategory, category }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ExpenseCategoryDialog>($"Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚ - {category.Name}", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            await LoadData();
        }
    }

    private async Task ToggleCategoryStatus(ExpenseCategory category)
    {
        var action = category.IsActive ? "Î±Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ" : "ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ„Îµ";
        var result = await DialogService.ShowMessageBox(
            $"{(category.IsActive ? "Î‘Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ·" : "Î•Î½ÎµÏÎ³Î¿Ï€Î¿Î¯Î·ÏƒÎ·")} ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚",
            $"Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± {action} Ï„Î·Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± '{category.Name}';",
            yesText: "ÎÎ±Î¹",
            cancelText: "Î†ÎºÏ…ÏÎ¿");

        if (result == true)
        {
            try
            {
                await ExpenseCategoryService.ToggleCategoryStatusAsync(category.Id);
                Snackbar.Add($"Î— ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± '{category.Name}' {(category.IsActive ? "Î±Ï€ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎµ" : "ÎµÎ½ÎµÏÎ³Î¿Ï€Î¿Î¹Î®Î¸Î·ÎºÎµ")} ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚", Severity.Success);
                await LoadData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î±: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteCategory(ExpenseCategory category)
    {
        var result = await DialogService.ShowMessageBox(
            "Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎšÎ±Ï„Î·Î³Î¿ÏÎ¯Î±Ï‚",
            $"Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Ï„Î·Î½ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± '{category.Name}'; " +
            "Î— Î´Î¹Î±Î³ÏÎ±Ï†Î® Î¸Î± Î±Ï€Î¿Ï„ÏÏ‡ÎµÎ¹ Î±Î½ Î· ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î±Ï€ÏŒ Î­Î¾Î¿Î´Î±.",
            yesText: "Î”Î¹Î±Î³ÏÎ±Ï†Î®",
            cancelText: "Î†ÎºÏ…ÏÎ¿");

        if (result == true)
        {
            try
            {
                await ExpenseCategoryService.DeleteCategoryAsync(category.Id);
                Snackbar.Add($"Î— ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î± '{category.Name}' Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚", Severity.Success);
                await LoadData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚: {ex.Message}", Severity.Warning);
            }
        }
    }
}
