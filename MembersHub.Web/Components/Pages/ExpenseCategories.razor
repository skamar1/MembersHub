@page "/expense-categories"
@using Microsoft.AspNetCore.Authorization
@using MembersHub.Core.Entities
@using MembersHub.Core.Interfaces
@using MembersHub.Web.Components.Dialogs
@attribute [Authorize(Roles = "Owner,Admin")]
@using MudBlazor
@inject IExpenseCategoryService ExpenseCategoryService
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Διαχείριση Κατηγοριών Εξόδων - MembersHub</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Color="Color.Primary">
        Διαχείριση Κατηγοριών Εξόδων
    </MudText>

    <MudPaper Class="pa-4 mt-4" Elevation="2">
        <!-- Header με κουμπί προσθήκης -->
        <div class="d-flex justify-space-between align-center mb-4 flex-wrap gap-2">
            <MudText Typo="Typo.h6">
                Κατηγορίες: @parentCategories.Count | Υποκατηγορίες: @subCategoryCount (@activeCount ενεργές)
            </MudText>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="@OpenCreateDialog">
                Νέα Κατηγορία
            </MudButton>
        </div>

        <!-- Search -->
        <MudTextField @bind-Value="searchString"
                      Label="Αναζήτηση..."
                      Variant="Variant.Outlined"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Class="mb-4" />

        @if (loading)
        {
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
        }
        else if (!filteredParentCategories.Any())
        {
            <div class="text-center pa-8">
                <MudIcon Icon="@Icons.Material.Filled.Category" Size="Size.Large" Color="Color.Default" />
                <MudText Typo="Typo.h6" Color="Color.Default" Class="mt-2">
                    Δεν βρέθηκαν κατηγορίες
                </MudText>
            </div>
        }
        else
        {
            <!-- Hierarchical view with expansion panels -->
            <MudExpansionPanels MultiExpansion="true">
                @foreach (var parent in filteredParentCategories)
                {
                    <MudExpansionPanel>
                        <TitleContent>
                            <div class="d-flex justify-space-between align-center" style="width: 100%;">
                                <div class="d-flex align-center gap-2">
                                    @if (!string.IsNullOrEmpty(parent.IconName))
                                    {
                                        <MudIcon Icon="@parent.IconName" Size="Size.Medium"
                                                 Style="@($"color: {(parent.ColorCode ?? "#666")}")" />
                                    }
                                    <MudText Typo="Typo.subtitle1" Style="font-weight: 600;">
                                        @parent.Name
                                    </MudText>
                                    <MudChip T="string" Size="Size.Small"
                                             Color="@(parent.IsActive ? Color.Success : Color.Default)">
                                        @(parent.IsActive ? "Ενεργή" : "Ανενεργή")
                                    </MudChip>
                                    @if (parent.SubCategories.Any())
                                    {
                                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                                            @parent.SubCategories.Count υποκατ.
                                        </MudChip>
                                    }
                                </div>
                                <div class="d-flex gap-1" @onclick:stopPropagation="true">
                                    <MudIconButton Icon="@Icons.Material.Filled.AddCircle"
                                                   Size="Size.Small"
                                                   Color="Color.Success"
                                                   OnClick="() => OpenCreateSubcategoryDialog(parent)"
                                                   Title="Προσθήκη Υποκατηγορίας" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                   Size="Size.Small"
                                                   Color="Color.Primary"
                                                   OnClick="() => EditCategory(parent)"
                                                   Title="Επεξεργασία" />
                                    <MudIconButton Icon="@(parent.IsActive ? Icons.Material.Filled.ToggleOff : Icons.Material.Filled.ToggleOn)"
                                                   Size="Size.Small"
                                                   Color="Color.Warning"
                                                   OnClick="() => ToggleCategoryStatus(parent)"
                                                   Title="@(parent.IsActive ? "Απενεργοποίηση" : "Ενεργοποίηση")" />
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                   Size="Size.Small"
                                                   Color="Color.Error"
                                                   OnClick="() => DeleteCategory(parent)"
                                                   Title="Διαγραφή" />
                                </div>
                            </div>
                        </TitleContent>
                        <ChildContent>
                            @if (!string.IsNullOrEmpty(parent.Description))
                            {
                                <MudText Typo="Typo.body2" Class="mb-3" Color="Color.Secondary">
                                    @parent.Description
                                </MudText>
                            }

                            @if (parent.SubCategories.Any())
                            {
                                <MudTable Items="@parent.SubCategories.OrderBy(s => s.DisplayOrder).ThenBy(s => s.Name)"
                                          Dense="true" Hover="true" Bordered="true">
                                    <HeaderContent>
                                        <MudTh>Υποκατηγορία</MudTh>
                                        <MudTh>Περιγραφή</MudTh>
                                        <MudTh>Icon</MudTh>
                                        <MudTh>Σειρά</MudTh>
                                        <MudTh>Κατάσταση</MudTh>
                                        <MudTh>Ενέργειες</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd DataLabel="Υποκατηγορία">
                                            <div class="d-flex align-center gap-2">
                                                @if (!string.IsNullOrEmpty(context.IconName))
                                                {
                                                    <MudIcon Icon="@context.IconName" Size="Size.Small"
                                                             Style="@($"color: {(context.ColorCode ?? "#666")}")" />
                                                }
                                                @context.Name
                                            </div>
                                        </MudTd>
                                        <MudTd DataLabel="Περιγραφή">@(context.Description ?? "-")</MudTd>
                                        <MudTd DataLabel="Icon">
                                            @if (!string.IsNullOrEmpty(context.IconName))
                                            {
                                                <MudIcon Icon="@context.IconName" Size="Size.Small" />
                                            }
                                        </MudTd>
                                        <MudTd DataLabel="Σειρά">@context.DisplayOrder</MudTd>
                                        <MudTd DataLabel="Κατάσταση">
                                            <MudChip T="string" Size="Size.Small"
                                                     Color="@(context.IsActive ? Color.Success : Color.Default)">
                                                @(context.IsActive ? "Ενεργή" : "Ανενεργή")
                                            </MudChip>
                                        </MudTd>
                                        <MudTd DataLabel="Ενέργειες">
                                            <div class="d-flex gap-1">
                                                <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                                               Size="Size.Small"
                                                               Color="Color.Primary"
                                                               OnClick="() => EditCategory(context)"
                                                               Title="Επεξεργασία" />
                                                <MudIconButton Icon="@(context.IsActive ? Icons.Material.Filled.ToggleOff : Icons.Material.Filled.ToggleOn)"
                                                               Size="Size.Small"
                                                               Color="Color.Warning"
                                                               OnClick="() => ToggleCategoryStatus(context)"
                                                               Title="@(context.IsActive ? "Απενεργοποίηση" : "Ενεργοποίηση")" />
                                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                               Size="Size.Small"
                                                               Color="Color.Error"
                                                               OnClick="() => DeleteCategory(context)"
                                                               Title="Διαγραφή" />
                                            </div>
                                        </MudTd>
                                    </RowTemplate>
                                </MudTable>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Info" Dense="true">
                                    Δεν υπάρχουν υποκατηγορίες.
                                    <MudLink OnClick="() => OpenCreateSubcategoryDialog(parent)">Προσθέστε μία</MudLink>
                                </MudAlert>
                            }
                        </ChildContent>
                    </MudExpansionPanel>
                }
            </MudExpansionPanels>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<ExpenseCategory> parentCategories = new();
    private bool loading = true;
    private string searchString = "";

    private int subCategoryCount => parentCategories.Sum(p => p.SubCategories.Count);
    private int activeCount => parentCategories.Count(c => c.IsActive) +
                               parentCategories.Sum(p => p.SubCategories.Count(s => s.IsActive));

    private IEnumerable<ExpenseCategory> filteredParentCategories => parentCategories.Where(c =>
        string.IsNullOrWhiteSpace(searchString) ||
        c.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
        (c.Description?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false) ||
        c.SubCategories.Any(s => s.Name.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
                                 (s.Description?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false))
    ).OrderBy(c => c.DisplayOrder).ThenBy(c => c.Name);

    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }

    private async Task LoadData()
    {
        loading = true;
        try
        {
            parentCategories = await ExpenseCategoryService.GetCategoriesWithSubCategoriesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Σφάλμα φόρτωσης δεδομένων: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }

    private async Task OpenCreateDialog()
    {
        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ExpenseCategoryDialog>("Νέα Κατηγορία Εξόδου", options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            await LoadData();
        }
    }

    private async Task OpenCreateSubcategoryDialog(ExpenseCategory parentCategory)
    {
        var parameters = new DialogParameters<ExpenseCategoryDialog>
        {
            { x => x.ParentCategory, parentCategory }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var dialog = await DialogService.ShowAsync<ExpenseCategoryDialog>($"Νέα Υποκατηγορία - {parentCategory.Name}", parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            await LoadData();
        }
    }

    private async Task EditCategory(ExpenseCategory category)
    {
        var parameters = new DialogParameters<ExpenseCategoryDialog>
        {
            { x => x.ExistingCategory, category }
        };

        var options = new DialogOptions
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };

        var title = category.ParentCategoryId.HasValue
            ? $"Επεξεργασία Υποκατηγορίας - {category.Name}"
            : $"Επεξεργασία Κατηγορίας - {category.Name}";

        var dialog = await DialogService.ShowAsync<ExpenseCategoryDialog>(title, parameters, options);
        var result = await dialog.Result;

        if (result is not null && !result.Canceled)
        {
            await LoadData();
        }
    }

    private async Task ToggleCategoryStatus(ExpenseCategory category)
    {
        var label = category.ParentCategoryId.HasValue ? "υποκατηγορία" : "κατηγορία";
        var action = category.IsActive ? "απενεργοποιήσετε" : "ενεργοποιήσετε";
        var result = await DialogService.ShowMessageBox(
            $"{(category.IsActive ? "Απενεργοποίηση" : "Ενεργοποίηση")}",
            $"Είστε σίγουροι ότι θέλετε να {action} την {label} '{category.Name}';",
            yesText: "Ναι",
            cancelText: "Άκυρο");

        if (result == true)
        {
            try
            {
                await ExpenseCategoryService.ToggleCategoryStatusAsync(category.Id);
                Snackbar.Add($"Η {label} '{category.Name}' {(category.IsActive ? "απενεργοποιήθηκε" : "ενεργοποιήθηκε")} επιτυχώς", Severity.Success);
                await LoadData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Σφάλμα: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteCategory(ExpenseCategory category)
    {
        var label = category.ParentCategoryId.HasValue ? "υποκατηγορία" : "κατηγορία";
        var extraWarning = category.ParentCategoryId.HasValue
            ? ""
            : " Αν έχει υποκατηγορίες, πρέπει πρώτα να τις διαγράψετε.";

        var result = await DialogService.ShowMessageBox(
            $"Διαγραφή {(category.ParentCategoryId.HasValue ? "Υποκατηγορίας" : "Κατηγορίας")}",
            $"Είστε σίγουροι ότι θέλετε να διαγράψετε την {label} '{category.Name}'; " +
            $"Η διαγραφή θα αποτύχει αν χρησιμοποιείται από έξοδα.{extraWarning}",
            yesText: "Διαγραφή",
            cancelText: "Άκυρο");

        if (result == true)
        {
            try
            {
                await ExpenseCategoryService.DeleteCategoryAsync(category.Id);
                Snackbar.Add($"Η {label} '{category.Name}' διαγράφηκε επιτυχώς", Severity.Success);
                await LoadData();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Σφάλμα διαγραφής: {ex.Message}", Severity.Warning);
            }
        }
    }
}
