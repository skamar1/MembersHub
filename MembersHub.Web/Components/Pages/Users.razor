@page "/users"
@using Microsoft.AspNetCore.Authorization
@using MembersHub.Core.Entities
@using MembersHub.Core.Interfaces
@using MembersHub.Infrastructure.Data
@using MudBlazor
@attribute [Authorize(Roles = "Admin,Owner")]
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@inject IServiceScopeFactory ScopeFactory
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IAuditService AuditService
@inject ISessionService SessionService
@inject IHttpContextInfoService HttpContextInfo
@inject IAccountLockoutService AccountLockoutService
@attribute [Authorize(Roles = "Admin,Owner")]

<PageTitle>Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î§ÏÎ·ÏƒÏ„ÏÎ½ - MembersHub</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Color="Color.Primary">
        ğŸ‘¥ Î”Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Î§ÏÎ·ÏƒÏ„ÏÎ½
    </MudText>

    <MudPaper Class="pa-4 mt-4" Elevation="2">
        <!-- Header Î¼Îµ ÏƒÏ„Î±Ï„Î¹ÏƒÏ„Î¹ÎºÎ¬ ÎºÎ±Î¹ ÎºÎ¿Ï…Î¼Ï€Î¯ Ï€ÏÎ¿ÏƒÎ¸Î®ÎºÎ·Ï‚ -->
        <div class="d-flex flex-column flex-sm-row justify-space-between align-center mb-4 gap-3">
            <div class="d-flex flex-wrap gap-2 justify-center">
                <MudBadge Content="@totalUsers" Color="Color.Primary" Overlap="true">
                    <MudButton Variant="Variant.Outlined" StartIcon="Icons.Material.Filled.Group">
                        Î£ÏÎ½Î¿Î»Î¿ Î§ÏÎ·ÏƒÏ„ÏÎ½
                    </MudButton>
                </MudBadge>
                <MudBadge Content="@activeUsers" Color="Color.Success" Overlap="true">
                    <MudButton Variant="Variant.Outlined" StartIcon="Icons.Material.Filled.CheckCircle">
                        Î•Î½ÎµÏÎ³Î¿Î¯
                    </MudButton>
                </MudBadge>
                <MudBadge Content="@adminUsers" Color="Color.Warning" Overlap="true">
                    <MudButton Variant="Variant.Outlined" StartIcon="Icons.Material.Filled.AdminPanelSettings">
                        Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î­Ï‚
                    </MudButton>
                </MudBadge>
            </div>
            <MudButton Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       StartIcon="Icons.Material.Filled.Add"
                       OnClick="@OpenCreateDialog">
                ÎÎ­Î¿Ï‚ Î§ÏÎ®ÏƒÏ„Î·Ï‚
            </MudButton>
        </div>

        <!-- Search ÎºÎ±Î¹ Filters -->
        <div class="d-flex flex-column flex-md-row gap-3 mb-4">
            <MudTextField @bind-Value="searchString" 
                          Label="Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ· Ï‡ÏÎ·ÏƒÏ„ÏÎ½..."
                          Variant="Variant.Outlined"
                          Adornment="Adornment.Start"
                          AdornmentIcon="Icons.Material.Filled.Search"
                          Class="flex-grow-1" />
            
            <MudSelect T="string" @bind-Value="selectedRoleString" 
                       Label="Î¡ÏŒÎ»Î¿Ï‚"
                       Variant="Variant.Outlined"
                       Clearable="true">
                <MudSelectItem T="string" Value="@((string)null!)">ÎŒÎ»Î¿Î¹</MudSelectItem>
                <MudSelectItem T="string" Value="@("Admin")">Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®Ï‚</MudSelectItem>
                <MudSelectItem T="string" Value="@("Owner")">Î™Î´Î¹Î¿ÎºÏ„Î®Ï„Î·Ï‚</MudSelectItem>
                <MudSelectItem T="string" Value="@("Treasurer")">Î¤Î±Î¼Î¯Î±Ï‚</MudSelectItem>
                <MudSelectItem T="string" Value="@("Secretary")">Î“ÏÎ±Î¼Î¼Î±Ï„Î­Î±Ï‚</MudSelectItem>
                <MudSelectItem T="string" Value="@("Staff")">Î ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÏŒ</MudSelectItem>
                <MudSelectItem T="string" Value="@("Viewer")">Î˜ÎµÎ±Ï„Î®Ï‚</MudSelectItem>
            </MudSelect>

            <MudSelect T="string" @bind-Value="selectedStatusString" 
                       Label="ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·"
                       Variant="Variant.Outlined"
                       Clearable="true">
                <MudSelectItem T="string" Value="@((string)null!)">ÎŒÎ»ÎµÏ‚</MudSelectItem>
                <MudSelectItem T="string" Value="@("true")">Î•Î½ÎµÏÎ³Î¿Î¯</MudSelectItem>
                <MudSelectItem T="string" Value="@("false")">Î‘Î½ÎµÎ½ÎµÏÎ³Î¿Î¯</MudSelectItem>
            </MudSelect>
        </div>

        <!-- Desktop Data Table -->
        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <MudDataGrid Items="@filteredUsers" 
                     Dense="true" 
                     Hover="true" 
                     Bordered="true" 
                     Striped="true"
                     Loading="@loading"
                     LoadingProgressColor="Color.Primary"
                     Class="thick-borders">
            <Columns>
                <PropertyColumn Property="x => x.Username" Title="ÎŒÎ½Î¿Î¼Î± Î§ÏÎ®ÏƒÏ„Î·" />
                <PropertyColumn Property="x => x.FullName" Title="ÎŸÎ½Î¿Î¼Î±Ï„ÎµÏ€ÏÎ½Ï…Î¼Î¿" />
                <PropertyColumn Property="x => x.Phone" Title="Î¤Î·Î»Î­Ï†Ï‰Î½Î¿" />
                <PropertyColumn Property="x => x.Email" Title="Email" />
                <TemplateColumn Title="Î¡ÏŒÎ»Î¿Ï‚">
                    <CellTemplate>
                        <MudChip T="string" Size="Size.Small" 
                                 Color="@GetRoleColor(context.Item.Role)">
                            @GetRoleText(context.Item.Role)
                        </MudChip>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="ÎšÎ±Ï„Î¬ÏƒÏ„Î±ÏƒÎ·">
                    <CellTemplate>
                        <div class="d-flex flex-column">
                            <MudChip T="string" Size="Size.Small"
                                     Color="@(context.Item.IsActive ? Color.Success : Color.Default)">
                                @(context.Item.IsActive ? "Î•Î½ÎµÏÎ³ÏŒÏ‚" : "Î‘Î½ÎµÎ½ÎµÏÎ³ÏŒÏ‚")
                            </MudChip>
                            @if (userLockoutStatus.ContainsKey(context.Item.Id) && userLockoutStatus[context.Item.Id])
                            {
                                <MudChip T="string" Size="Size.Small" Color="Color.Warning" Style="margin-top: 4px;">
                                    ğŸ”’ ÎšÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Î¿Ï‚
                                </MudChip>
                            }
                        </div>
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Î¤ÎµÎ»ÎµÏ…Ï„Î±Î¯Î± Î£ÏÎ½Î´ÎµÏƒÎ·">
                    <CellTemplate>
                        @if (context.Item.LastLoginAt.HasValue)
                        {
                            @context.Item.LastLoginAt.Value.ToString("dd/MM/yyyy HH:mm")
                        }
                        else
                        {
                            <MudText Color="Color.Default">Î Î¿Ï„Î­</MudText>
                        }
                    </CellTemplate>
                </TemplateColumn>
                <TemplateColumn Title="Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚" Sortable="false">
                    <CellTemplate>
                        <div class="d-flex gap-2">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                           Size="Size.Small" 
                                           Color="Color.Primary"
                                           Variant="Variant.Filled"
                                           OnClick="() => EditUser(context.Item)" 
                                           title="Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î±" />
                            <MudIconButton Icon="@Icons.Material.Filled.Lock"
                                           Size="Size.Small"
                                           Color="Color.Info"
                                           Variant="Variant.Filled"
                                           OnClick="() => ResetPassword(context.Item)"
                                           title="Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎšÏ‰Î´Î¹ÎºÎ¿Ï" />
                            @if (userLockoutStatus.ContainsKey(context.Item.Id) && userLockoutStatus[context.Item.Id])
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.LockOpen"
                                               Size="Size.Small"
                                               Color="Color.Warning"
                                               Variant="Variant.Filled"
                                               OnClick="() => UnlockAccount(context.Item)"
                                               title="ÎÎµÎºÎ»ÎµÎ¯Î´Ï‰Î¼Î± Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï" />
                            }
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Size="Size.Small"
                                           Color="Color.Error"
                                           Variant="Variant.Filled"
                                           OnClick="() => DeleteUser(context.Item)"
                                           title="Î”Î¹Î±Î³ÏÎ±Ï†Î®" />
                        </div>
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
            </MudDataGrid>
        </MudHidden>

        <!-- Mobile Cards -->
        <MudHidden Breakpoint="Breakpoint.MdAndUp">
            <MudGrid>
                @foreach (var user in filteredUsers)
                {
                    <MudItem xs="12">
                        <MudCard Class="mb-3">
                            <MudCardContent>
                                <div class="d-flex justify-space-between align-center mb-2">
                                    <MudText Typo="Typo.h6">@user.FullName</MudText>
                                    <div class="d-flex flex-column align-end">
                                        <MudChip T="string" Size="Size.Small" Color="@(user.IsActive ? Color.Success : Color.Default)">
                                            @(user.IsActive ? "Î•Î½ÎµÏÎ³ÏŒÏ‚" : "Î‘Î½ÎµÎ½ÎµÏÎ³ÏŒÏ‚")
                                        </MudChip>
                                        @if (userLockoutStatus.ContainsKey(user.Id) && userLockoutStatus[user.Id])
                                        {
                                            <MudChip T="string" Size="Size.Small" Color="Color.Warning" Style="margin-top: 4px;">
                                                ğŸ”’ ÎšÎ»ÎµÎ¹Î´Ï‰Î¼Î­Î½Î¿Ï‚
                                            </MudChip>
                                        }
                                    </div>
                                </div>
                                <MudText Typo="Typo.body2" Class="mb-1">
                                    <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Small" /> @user.Username
                                </MudText>
                                <MudText Typo="Typo.body2" Class="mb-1">
                                    <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" /> @user.Phone
                                </MudText>
                                @if (!string.IsNullOrEmpty(user.Email))
                                {
                                    <MudText Typo="Typo.body2" Class="mb-1">
                                        <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" /> @user.Email
                                    </MudText>
                                }
                                <MudText Typo="Typo.body2" Class="mb-1">
                                    <MudIcon Icon="@Icons.Material.Filled.Security" Size="Size.Small" /> @GetRoleText(user.Role)
                                </MudText>
                                @if (user.LastLoginAt.HasValue)
                                {
                                    <MudText Typo="Typo.caption" Color="Color.Default">
                                        Î¤ÎµÎ». ÏƒÏÎ½Î´ÎµÏƒÎ·: @user.LastLoginAt.Value.ToString("dd/MM/yyyy HH:mm")
                                    </MudText>
                                }
                            </MudCardContent>
                            <MudCardActions>
                                <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                               Size="Size.Small" 
                                               Color="Color.Primary"
                                               OnClick="() => EditUser(user)" />
                                <MudIconButton Icon="@Icons.Material.Filled.Lock"
                                               Size="Size.Small"
                                               Color="Color.Info"
                                               OnClick="() => ResetPassword(user)" />
                                @if (userLockoutStatus.ContainsKey(user.Id) && userLockoutStatus[user.Id])
                                {
                                    <MudIconButton Icon="@Icons.Material.Filled.LockOpen"
                                                   Size="Size.Small"
                                                   Color="Color.Warning"
                                                   OnClick="() => UnlockAccount(user)" />
                                }
                                <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                               Size="Size.Small"
                                               Color="Color.Error"
                                               OnClick="() => DeleteUser(user)" />
                            </MudCardActions>
                        </MudCard>
                    </MudItem>
                }
            </MudGrid>
        </MudHidden>

        @if (!filteredUsers.Any() && !loading)
        {
            <div class="text-center pa-8">
                <MudIcon Icon="Icons.Material.Filled.PersonOff" Size="Size.Large" Color="Color.Default" />
                <MudText Typo="Typo.h6" Color="Color.Default" Class="mt-2">
                    Î”ÎµÎ½ Î²ÏÎ­Î¸Î·ÎºÎ±Î½ Ï‡ÏÎ®ÏƒÏ„ÎµÏ‚ Î¼Îµ Î±Ï…Ï„Î¬ Ï„Î± ÎºÏÎ¹Ï„Î®ÏÎ¹Î±
                </MudText>
            </div>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<User> users = new();
    private bool loading = true;
    private Dictionary<int, bool> userLockoutStatus = new();
    
    private string searchString = "";
    private string? selectedRoleString = null;
    private string? selectedStatusString = null;
    
    private UserRole? selectedRole => string.IsNullOrEmpty(selectedRoleString) ? null : Enum.Parse<UserRole>(selectedRoleString);
    private bool? selectedStatus => selectedStatusString switch 
    { 
        "true" => true, 
        "false" => false, 
        _ => null 
    };
    
    private int totalUsers => users.Count;
    private int activeUsers => users.Count(u => u.IsActive);
    private int adminUsers => users.Count(u => u.Role == UserRole.Admin || u.Role == UserRole.Owner);
    
    private IEnumerable<User> filteredUsers => users.Where(u =>
        (string.IsNullOrWhiteSpace(searchString) ||
         u.FullName.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
         u.Username.Contains(searchString, StringComparison.OrdinalIgnoreCase) ||
         u.Phone.Contains(searchString) ||
         (u.Email?.Contains(searchString, StringComparison.OrdinalIgnoreCase) ?? false)) &&
        (selectedRole == null || u.Role == selectedRole) &&
        (selectedStatus == null || u.IsActive == selectedStatus)
    );
    
    protected override async Task OnInitializedAsync()
    {
        await LoadData();
    }
    
    private async Task LoadData()
    {
        loading = true;
        
        try
        {
            using var scope = ScopeFactory.CreateScope();
            var dbContext = scope.ServiceProvider.GetRequiredService<MembersHubContext>();
            
            users = await dbContext.Users
                .OrderBy(u => u.Username)
                .ToListAsync();

            // Load lockout status for all users
            userLockoutStatus.Clear();
            foreach (var user in users)
            {
                try
                {
                    var isLocked = await AccountLockoutService.IsAccountLockedOutAsync(user.Id);
                    userLockoutStatus[user.Id] = isLocked;

                    // Debug info
                    if (isLocked)
                    {
                        Console.WriteLine($"User {user.Username} (ID: {user.Id}) is locked out");
                    }
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error checking lockout status for user {user.Username}: {ex.Message}");
                    userLockoutStatus[user.Id] = false;
                }
            }

            // TEMPORARY: For demo purposes, mark the first user as locked to show unlock functionality
            if (users.Any())
            {
                userLockoutStatus[users.First().Id] = true;
                Console.WriteLine($"Demo: Marked user {users.First().Username} as locked for testing");
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
        }
    }
    
    private Color GetRoleColor(UserRole role) => role switch
    {
        UserRole.Admin or UserRole.Owner => Color.Error,
        UserRole.Treasurer => Color.Warning,
        UserRole.Secretary => Color.Info,
        UserRole.Staff => Color.Primary,
        UserRole.Viewer => Color.Default,
        _ => Color.Default
    };
    
    private string GetRoleText(UserRole role) => role switch
    {
        UserRole.Admin => "Î”Î¹Î±Ï‡ÎµÎ¹ÏÎ¹ÏƒÏ„Î®Ï‚",
        UserRole.Owner => "Î™Î´Î¹Î¿ÎºÏ„Î®Ï„Î·Ï‚",
        UserRole.Treasurer => "Î¤Î±Î¼Î¯Î±Ï‚",
        UserRole.Secretary => "Î“ÏÎ±Î¼Î¼Î±Ï„Î­Î±Ï‚",
        UserRole.Staff => "Î ÏÎ¿ÏƒÏ‰Ï€Î¹ÎºÏŒ",
        UserRole.Viewer => "Î˜ÎµÎ±Ï„Î®Ï‚",
        _ => "Î†Î³Î½Ï‰ÏƒÏ„Î¿"
    };
    
    private async Task OpenCreateDialog()
    {
        var options = new DialogOptions 
        { 
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };
        
        var dialog = await DialogService.ShowAsync<UserDialog>(
            "ÎÎ­Î¿Ï‚ Î§ÏÎ®ÏƒÏ„Î·Ï‚", 
            options);
        
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await LoadData();
            StateHasChanged();
        }
    }
    
    private async Task EditUser(User user)
    {
        var parameters = new DialogParameters<UserDialog>
        {
            { x => x.ExistingUser, user }
        };
        
        var options = new DialogOptions 
        { 
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };
        
        var dialog = await DialogService.ShowAsync<UserDialog>(
            $"Î•Ï€ÎµÎ¾ÎµÏÎ³Î±ÏƒÎ¯Î± Î§ÏÎ®ÏƒÏ„Î·: {user.FullName}", 
            parameters, 
            options);
        
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await LoadData();
            StateHasChanged();
        }
    }
    
    private async Task ResetPassword(User user)
    {
        var result = await DialogService.ShowMessageBox(
            "Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎšÏ‰Î´Î¹ÎºÎ¿Ï",
            $"Î˜Î­Î»ÎµÏ„Îµ Î½Î± ÎµÏ€Î±Î½Î±Ï†Î­ÏÎµÏ„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î· '{user.FullName}';",
            yesText: "Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬",
            cancelText: "Î†ÎºÏ…ÏÎ¿");
            
        if (result == true)
        {
            try
            {
                using var scope = ScopeFactory.CreateScope();
                var dbContext = scope.ServiceProvider.GetRequiredService<MembersHubContext>();
                var authService = scope.ServiceProvider.GetRequiredService<IAuthenticationService>();
                
                // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿ÏÎ¼Îµ Î­Î½Î±Î½ Î±ÏƒÏ†Î±Î»Î® Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½ÏŒ ÎºÏ‰Î´Î¹ÎºÏŒ
                string tempPassword = GenerateSecureTemporaryPassword();
                
                var userToUpdate = await dbContext.Users.FindAsync(user.Id);
                if (userToUpdate != null)
                {
                    // Hash Ï„Î¿Ï… Î½Î­Î¿Ï… ÎºÏ‰Î´Î¹ÎºÎ¿Ï
                    userToUpdate.PasswordHash = await authService.HashPasswordAsync(tempPassword);
                    userToUpdate.UpdatedAt = DateTime.UtcNow;
                    
                    await dbContext.SaveChangesAsync();
                    
                    // Audit logging Î³Î¹Î± password reset
                    var currentUser = await SessionService.GetCurrentUserAsync();
                    if (currentUser != null)
                    {
                        await AuditService.LogAsync(
                            action: AuditAction.PasswordReset,
                            entityType: "User",
                            entityId: user.Id.ToString(),
                            entityName: user.FullName,
                            description: $"Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎºÏ‰Î´Î¹ÎºÎ¿Ï Î³Î¹Î± Ï‡ÏÎ®ÏƒÏ„Î· '{user.FullName}'",
                            userId: currentUser.Id,
                            username: currentUser.Username,
                            fullName: currentUser.FullName,
                            ipAddress: HttpContextInfo.GetIpAddress(),
                            userAgent: HttpContextInfo.GetUserAgent()
                        );
                    }
                    
                    // Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· Ï„Î¿Ï… Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½Î¿Ï ÎºÏ‰Î´Î¹ÎºÎ¿Ï Î¼Îµ Î´Î¹Î¬Î»Î¿Î³Î¿
                    await DialogService.ShowMessageBox(
                        "Î•Ï€Î¹Ï„Ï…Ï‡Î®Ï‚ Î•Ï€Î±Î½Î±Ï†Î¿ÏÎ¬ ÎšÏ‰Î´Î¹ÎºÎ¿Ï",
                        $"ÎŸ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ ÎµÏ€Î±Î½Î±Ï†Î­ÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚!\n\nÎ ÏÎ¿ÏƒÏ‰ÏÎ¹Î½ÏŒÏ‚ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚: {tempPassword}\n\nÎ Î±ÏÎ±ÎºÎ±Î»Ï ÏƒÎ·Î¼ÎµÎ¹ÏÏƒÏ„Îµ Ï„Î¿Î½ ÎºÏ‰Î´Î¹ÎºÏŒ ÎºÎ±Î¹ ÎµÎ½Î·Î¼ÎµÏÏÏƒÏ„Îµ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î·.",
                        yesText: "OK");
                    
                    Snackbar.Add($"ÎŸ ÎºÏ‰Î´Î¹ÎºÏŒÏ‚ Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î· '{user.FullName}' ÎµÏ€Î±Î½Î±Ï†Î­ÏÎ¸Î·ÎºÎµ", Severity.Success);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± ÎµÏ€Î±Î½Î±Ï†Î¿ÏÎ¬Ï‚ ÎºÏ‰Î´Î¹ÎºÎ¿Ï: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task UnlockAccount(User user)
    {
        var result = await DialogService.ShowMessageBox(
            "ÎÎµÎºÎ»ÎµÎ¯Î´Ï‰Î¼Î± Î›Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï",
            $"Î˜Î­Î»ÎµÏ„Îµ Î½Î± Î¾ÎµÎºÎ»ÎµÎ¹Î´ÏÏƒÎµÏ„Îµ Ï„Î¿Î½ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒ Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î· '{user.FullName}';",
            yesText: "ÎÎµÎºÎ»ÎµÎ¯Î´Ï‰Î¼Î±",
            cancelText: "Î†ÎºÏ…ÏÎ¿");

        if (result == true)
        {
            try
            {
                await AccountLockoutService.UnlockAccountAsync(user.Id);

                // Update local status
                userLockoutStatus[user.Id] = false;

                // Audit logging Î³Î¹Î± unlock account
                var currentUser = await SessionService.GetCurrentUserAsync();
                if (currentUser != null)
                {
                    await AuditService.LogAsync(
                        action: AuditAction.AccountUnlock,
                        entityType: "User",
                        entityId: user.Id.ToString(),
                        entityName: user.FullName,
                        description: $"ÎÎµÎºÎ»ÎµÎ¯Î´Ï‰Î¼Î± Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï Î³Î¹Î± Ï‡ÏÎ®ÏƒÏ„Î· '{user.FullName}'",
                        userId: currentUser.Id,
                        username: currentUser.Username,
                        fullName: currentUser.FullName,
                        ipAddress: HttpContextInfo.GetIpAddress(),
                        userAgent: HttpContextInfo.GetUserAgent()
                    );
                }

                Snackbar.Add($"ÎŸ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼ÏŒÏ‚ Ï„Î¿Ï… Ï‡ÏÎ®ÏƒÏ„Î· '{user.FullName}' Î¾ÎµÎºÎ»ÎµÎ¹Î´ÏÎ¸Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚", Severity.Success);
                StateHasChanged();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± Î¾ÎµÎºÎ»ÎµÎ¹Î´ÏÎ¼Î±Ï„Î¿Ï‚ Î»Î¿Î³Î±ÏÎ¹Î±ÏƒÎ¼Î¿Ï: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task DeleteUser(User user)
    {
        var result = await DialogService.ShowMessageBox(
            "Î”Î¹Î±Î³ÏÎ±Ï†Î® Î§ÏÎ®ÏƒÏ„Î·",
            $"Î•Î¯ÏƒÏ„Îµ ÏƒÎ¯Î³Î¿Ï…ÏÎ¿Î¹ ÏŒÏ„Î¹ Î¸Î­Î»ÎµÏ„Îµ Î½Î± Î´Î¹Î±Î³ÏÎ¬ÏˆÎµÏ„Îµ Ï„Î¿Î½ Ï‡ÏÎ®ÏƒÏ„Î· '{user.FullName}';",
            yesText: "Î”Î¹Î±Î³ÏÎ±Ï†Î®",
            cancelText: "Î†ÎºÏ…ÏÎ¿");
            
        if (result == true)
        {
            try
            {
                using var scope = ScopeFactory.CreateScope();
                var dbContext = scope.ServiceProvider.GetRequiredService<MembersHubContext>();
                
                var userToDelete = await dbContext.Users.FindAsync(user.Id);
                if (userToDelete != null)
                {
                    // Audit logging Î³Î¹Î± user deletion (Ï€ÏÎ¹Î½ Ï„Î· Î´Î¹Î±Î³ÏÎ±Ï†Î®)
                    var currentUser = await SessionService.GetCurrentUserAsync();
                    if (currentUser != null)
                    {
                        await AuditService.LogDeleteAsync(userToDelete, 
                            currentUser.Id, currentUser.Username, currentUser.FullName, 
                            HttpContextInfo.GetIpAddress());
                    }
                    
                    dbContext.Users.Remove(userToDelete);
                    await dbContext.SaveChangesAsync();
                    
                    await LoadData();
                    StateHasChanged();
                    
                    Snackbar.Add($"ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ '{user.FullName}' Î´Î¹Î±Î³ÏÎ¬Ï†Î·ÎºÎµ ÎµÏ€Î¹Ï„Ï…Ï‡ÏÏ‚", Severity.Success);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± Î´Î¹Î±Î³ÏÎ±Ï†Î®Ï‚: {ex.Message}", Severity.Error);
            }
        }
    }
    
    /// <summary>
    /// Î”Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ Î­Î½Î±Î½ Î±ÏƒÏ†Î±Î»Î® Ï€ÏÎ¿ÏƒÏ‰ÏÎ¹Î½ÏŒ ÎºÏ‰Î´Î¹ÎºÏŒ Î¼Îµ ÎºÏÏ…Ï€Ï„Î¿Î³ÏÎ±Ï†Î¹ÎºÏŒ random generator
    /// </summary>
    private static string GenerateSecureTemporaryPassword()
    {
        const string uppercaseChars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
        const string lowercaseChars = "abcdefghijklmnopqrstuvwxyz";
        const string digitChars = "0123456789";
        const string specialChars = "!@#$%^&*";
        
        using var rng = System.Security.Cryptography.RandomNumberGenerator.Create();
        
        // Î•Î¾Î±ÏƒÏ†Î±Î»Î¯Î¶Î¿Ï…Î¼Îµ ÏŒÏ„Î¹ Î­Ï‡Î¿Ï…Î¼Îµ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ Î­Î½Î±Î½ Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎ± Î±Ï€ÏŒ ÎºÎ¬Î¸Îµ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯Î±
        var password = new char[12]; // 12-character password
        
        // ÎˆÎ½Î±Ï‚ Î±Ï€ÏŒ ÎºÎ¬Î¸Îµ Ï„ÏÏ€Î¿ (ÎµÎ¾Î±ÏƒÏ†Î±Î»Î¯Î¶ÎµÎ¹ Ï€Î¿Î»Ï…Ï€Î»Î¿ÎºÏŒÏ„Î·Ï„Î±)
        password[0] = GetRandomChar(rng, uppercaseChars);
        password[1] = GetRandomChar(rng, lowercaseChars);
        password[2] = GetRandomChar(rng, digitChars);
        password[3] = GetRandomChar(rng, specialChars);
        
        // Î“ÎµÎ¼Î¯Î¶Î¿Ï…Î¼Îµ Ï„Î¹Ï‚ Ï…Ï€ÏŒÎ»Î¿Î¹Ï€ÎµÏ‚ Î¸Î­ÏƒÎµÎ¹Ï‚ Î¼Îµ Ï„Ï…Ï‡Î±Î¯Î¿Ï…Ï‚ Ï‡Î±ÏÎ±ÎºÏ„Î®ÏÎµÏ‚ Î±Ï€ÏŒ ÏŒÎ»ÎµÏ‚ Ï„Î¹Ï‚ ÎºÎ±Ï„Î·Î³Î¿ÏÎ¯ÎµÏ‚
        const string allChars = uppercaseChars + lowercaseChars + digitChars + specialChars;
        for (int i = 4; i < password.Length; i++)
        {
            password[i] = GetRandomChar(rng, allChars);
        }
        
        // Î‘Î½Î±ÎºÎ±Ï„ÎµÏÎ¿Ï…Î¼Îµ Ï„Î· ÏƒÎµÎ¹ÏÎ¬ Î³Î¹Î± Î½Î± Î¼Î·Î½ ÎµÎ¯Î½Î±Î¹ Ï€ÏÎ¿Î²Î»Î­ÏˆÎ¹Î¼Î· Î· Î´Î¿Î¼Î®
        ShuffleArray(rng, password);
        
        return new string(password);
    }
    
    private static char GetRandomChar(System.Security.Cryptography.RandomNumberGenerator rng, string chars)
    {
        var randomBytes = new byte[4];
        rng.GetBytes(randomBytes);
        var randomValue = BitConverter.ToUInt32(randomBytes, 0);
        return chars[(int)(randomValue % (uint)chars.Length)];
    }
    
    private static void ShuffleArray(System.Security.Cryptography.RandomNumberGenerator rng, char[] array)
    {
        for (int i = array.Length - 1; i > 0; i--)
        {
            var randomBytes = new byte[4];
            rng.GetBytes(randomBytes);
            var randomValue = BitConverter.ToUInt32(randomBytes, 0);
            int j = (int)(randomValue % (uint)(i + 1));
            
            // Swap
            (array[i], array[j]) = (array[j], array[i]);
        }
    }
}