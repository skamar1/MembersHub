@page "/audit-logs"
@using Microsoft.AspNetCore.Authorization
@using MembersHub.Core.Entities
@using MembersHub.Core.Interfaces
@using MembersHub.Web.Components.Dialogs
@using MudBlazor
@attribute [Authorize(Roles = "Admin,Owner")]
@inject IAuditService AuditService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@attribute [Authorize(Roles = "Admin,Owner")]

<PageTitle>Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î•Î½ÎµÏÎ³ÎµÎ¹ÏÎ½ - MembersHub</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h4" Color="Color.Primary">
        ğŸ“‹ Î™ÏƒÏ„Î¿ÏÎ¹ÎºÏŒ Î•Î½ÎµÏÎ³ÎµÎ¹ÏÎ½
    </MudText>

    <MudPaper Class="pa-4 mt-4" Elevation="2">
        <!-- Filters -->
        <MudGrid Class="mb-4">
            <MudItem xs="12" sm="6" md="3">
                <MudSelect T="AuditAction?" @bind-Value="selectedAction" Label="Î•Î½Î­ÏÎ³ÎµÎ¹Î±" Variant="Variant.Outlined" Clearable="true">
                    <MudSelectItem T="AuditAction?" Value="@((AuditAction?)null)">ÎŒÎ»ÎµÏ‚</MudSelectItem>
                    <MudSelectItem T="AuditAction?" Value="@((AuditAction?)AuditAction.Login)">Î£ÏÎ½Î´ÎµÏƒÎ·</MudSelectItem>
                    <MudSelectItem T="AuditAction?" Value="@((AuditAction?)AuditAction.Logout)">Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·</MudSelectItem>
                    <MudSelectItem T="AuditAction?" Value="@((AuditAction?)AuditAction.LoginFailed)">Î‘Ï€Î¿Ï„Ï…Ï‡Î·Î¼Î­Î½Î· Î£ÏÎ½Î´ÎµÏƒÎ·</MudSelectItem>
                    <MudSelectItem T="AuditAction?" Value="@((AuditAction?)AuditAction.MemberCreate)">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎœÎ­Î»Î¿Ï…Ï‚</MudSelectItem>
                    <MudSelectItem T="AuditAction?" Value="@((AuditAction?)AuditAction.MemberUpdate)">Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎœÎ­Î»Î¿Ï…Ï‚</MudSelectItem>
                    <MudSelectItem T="AuditAction?" Value="@((AuditAction?)AuditAction.MemberDelete)">Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎœÎ­Î»Î¿Ï…Ï‚</MudSelectItem>
                    <MudSelectItem T="AuditAction?" Value="@((AuditAction?)AuditAction.UserCreate)">Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î§ÏÎ®ÏƒÏ„Î·</MudSelectItem>
                    <MudSelectItem T="AuditAction?" Value="@((AuditAction?)AuditAction.UserUpdate)">Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î§ÏÎ®ÏƒÏ„Î·</MudSelectItem>
                    <MudSelectItem T="AuditAction?" Value="@((AuditAction?)AuditAction.UserDelete)">Î”Î¹Î±Î³ÏÎ±Ï†Î® Î§ÏÎ®ÏƒÏ„Î·</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudTextField @bind-Value="entityTypeFilter" Label="Î¤ÏÏ€Î¿Ï‚ ÎŸÎ½Ï„ÏŒÏ„Î·Ï„Î±Ï‚" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudDatePicker @bind-Date="fromDate" Label="Î‘Ï€ÏŒ Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" sm="6" md="3">
                <MudDatePicker @bind-Date="toDate" Label="ÎˆÏ‰Ï‚ Î—Î¼ÎµÏÎ¿Î¼Î·Î½Î¯Î±" Variant="Variant.Outlined" />
            </MudItem>
        </MudGrid>

        <MudGrid Class="mb-4">
            <MudItem xs="12" sm="6" md="4">
                <MudTextField @bind-Value="usernameFilter" Label="ÎŒÎ½Î¿Î¼Î± Î§ÏÎ®ÏƒÏ„Î·" Variant="Variant.Outlined" />
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="LoadAuditLogs">
                    <MudIcon Icon="Icons.Material.Filled.Search" Class="mr-2" />
                    Î‘Î½Î±Î¶Î®Ï„Î·ÏƒÎ·
                </MudButton>
            </MudItem>
            <MudItem xs="12" sm="6" md="4">
                <MudButton Variant="Variant.Outlined" Color="Color.Secondary" OnClick="ClearFilters">
                    <MudIcon Icon="Icons.Material.Filled.Clear" Class="mr-2" />
                    ÎšÎ±Î¸Î±ÏÎ¹ÏƒÎ¼ÏŒÏ‚
                </MudButton>
            </MudItem>
        </MudGrid>

        <!-- Statistics -->
        <div class="d-flex flex-wrap gap-2 mb-4">
            <MudBadge Content="@totalRecords" Color="Color.Primary" Overlap="true">
                <MudButton Variant="Variant.Outlined" StartIcon="Icons.Material.Filled.List">
                    Î£ÏÎ½Î¿Î»Î¿ Î•Î³Î³ÏÎ±Ï†ÏÎ½
                </MudButton>
            </MudBadge>
            <MudBadge Content="@loginCount" Color="Color.Success" Overlap="true">
                <MudButton Variant="Variant.Outlined" StartIcon="Icons.Material.Filled.Login">
                    Î£Ï…Î½Î´Î­ÏƒÎµÎ¹Ï‚
                </MudButton>
            </MudBadge>
            <MudBadge Content="@failedLoginCount" Color="Color.Error" Overlap="true">
                <MudButton Variant="Variant.Outlined" StartIcon="Icons.Material.Filled.Block">
                    Î‘Ï€Î¿Ï„Ï…Ï‡Î·Î¼Î­Î½ÎµÏ‚ Î£Ï…Î½Î´Î­ÏƒÎµÎ¹Ï‚
                </MudButton>
            </MudBadge>
        </div>

        <!-- Data Table -->
        <MudDataGrid @ref="dataGrid" Items="@auditLogs" Loading="@loading" Filterable="false" SortMode="@SortMode.None">
            <Columns>
                <PropertyColumn Property="x => x.Timestamp" Title="Î§ÏÏŒÎ½Î¿Ï‚" Format="dd/MM/yyyy HH:mm:ss">
                    <CellTemplate>
                        <MudText>@context.Item.Timestamp.ToString("dd/MM/yyyy HH:mm:ss")</MudText>
                    </CellTemplate>
                </PropertyColumn>
                
                <PropertyColumn Property="x => x.FullName" Title="Î§ÏÎ®ÏƒÏ„Î·Ï‚">
                    <CellTemplate>
                        <div class="d-flex align-center">
                            <MudIcon Icon="@GetUserIcon(context.Item.Action)" Size="Size.Small" Class="mr-2" Color="@GetActionColor(context.Item.Action)" />
                            <MudText>@context.Item.FullName (@context.Item.Username)</MudText>
                        </div>
                    </CellTemplate>
                </PropertyColumn>
                
                <PropertyColumn Property="x => x.Action" Title="Î•Î½Î­ÏÎ³ÎµÎ¹Î±">
                    <CellTemplate>
                        <MudChip Size="Size.Small" Color="@GetActionColor(context.Item.Action)">
                            @GetActionDisplayName(context.Item.Action)
                        </MudChip>
                    </CellTemplate>
                </PropertyColumn>
                
                <PropertyColumn Property="x => x.Description" Title="Î ÎµÏÎ¹Î³ÏÎ±Ï†Î®">
                    <CellTemplate>
                        <MudText Style="max-width: 300px;" Class="text-truncate">@context.Item.Description</MudText>
                    </CellTemplate>
                </PropertyColumn>
                
                <PropertyColumn Property="x => x.IpAddress" Title="IP Address">
                    <CellTemplate>
                        <MudText Typo="Typo.body2">@(context.Item.IpAddress ?? "-")</MudText>
                    </CellTemplate>
                </PropertyColumn>

                <TemplateColumn Title="Î•Î½Î­ÏÎ³ÎµÎ¹ÎµÏ‚">
                    <CellTemplate>
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                       Size="Size.Small" 
                                       Color="Color.Info" 
                                       OnClick="@(() => ViewDetails(context.Item))" />
                    </CellTemplate>
                </TemplateColumn>
            </Columns>
        </MudDataGrid>

        <!-- Pagination -->
        <div class="d-flex justify-space-between align-center mt-4">
            <MudText Typo="Typo.body2">
                Î•Î¼Ï†Î¬Î½Î¹ÏƒÎ· @((currentPage * pageSize) + 1)-@Math.Min((currentPage + 1) * pageSize, totalRecords) Î±Ï€ÏŒ @totalRecords ÎµÎ³Î³ÏÎ±Ï†Î­Ï‚
            </MudText>
            <MudPagination Count="@totalPages" Selected="@currentPage" SelectedChanged="OnPageChanged" />
        </div>
    </MudPaper>
</MudContainer>

@code {
    private MudDataGrid<AuditLog> dataGrid = null!;
    private List<AuditLog> auditLogs = new();
    private bool loading = false;
    
    // Filters
    private AuditAction? selectedAction;
    private string entityTypeFilter = "";
    private string usernameFilter = "";
    private DateTime? fromDate = DateTime.Today.AddDays(-7);
    private DateTime? toDate = DateTime.Today.AddDays(1);
    
    // Pagination
    private int currentPage = 1;
    private int pageSize = 25;
    private int totalRecords = 0;
    private int totalPages = 0;
    
    // Statistics
    private int loginCount = 0;
    private int failedLoginCount = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadAuditLogs();
    }

    private async Task LoadAuditLogs()
    {
        if (loading) return; // Prevent multiple concurrent loads
        
        loading = true;
        StateHasChanged();

        try
        {
            var skip = (currentPage - 1) * pageSize;
            
            // Convert username filter to userId if needed
            int? userId = null;
            if (!string.IsNullOrEmpty(usernameFilter))
            {
                // For now, we'll search by username in the service
                // In a real implementation, you might want to first find the user ID
            }

            // Reset previous data
            auditLogs.Clear();
            totalRecords = 0;
            loginCount = 0;
            failedLoginCount = 0;

            auditLogs = (await AuditService.GetAuditLogsAsync(
                userId: userId,
                action: selectedAction,
                entityType: string.IsNullOrEmpty(entityTypeFilter) ? null : entityTypeFilter,
                fromDate: fromDate,
                toDate: toDate,
                skip: skip,
                take: pageSize
            )).ToList();

            totalRecords = await AuditService.GetAuditLogsCountAsync(
                userId: userId,
                action: selectedAction,
                entityType: string.IsNullOrEmpty(entityTypeFilter) ? null : entityTypeFilter,
                fromDate: fromDate,
                toDate: toDate
            );

            totalPages = (int)Math.Ceiling((double)totalRecords / pageSize);

            // Calculate statistics
            loginCount = auditLogs.Count(x => x.Action == AuditAction.Login);
            failedLoginCount = auditLogs.Count(x => x.Action == AuditAction.LoginFailed);
        }
        catch (Exception ex)
        {
            auditLogs.Clear();
            totalRecords = 0;
            loginCount = 0;
            failedLoginCount = 0;
            Snackbar.Add($"Î£Ï†Î¬Î»Î¼Î± Ï†ÏŒÏÏ„Ï‰ÏƒÎ·Ï‚ Î´ÎµÎ´Î¿Î¼Î­Î½Ï‰Î½: {ex.Message}", Severity.Error);
        }
        finally
        {
            loading = false;
            StateHasChanged();
        }
    }

    private async Task ClearFilters()
    {
        selectedAction = null;
        entityTypeFilter = "";
        usernameFilter = "";
        fromDate = DateTime.Today.AddDays(-7);
        toDate = DateTime.Today.AddDays(1);
        currentPage = 1;
        await LoadAuditLogs();
    }

    private async Task OnPageChanged(int page)
    {
        currentPage = page;
        await LoadAuditLogs();
    }

    private async Task ViewDetails(AuditLog auditLog)
    {
        var parameters = new DialogParameters<AuditLogDetailsDialog>
        {
            { x => x.AuditLog, auditLog }
        };
        
        var options = new DialogOptions 
        { 
            CloseButton = true,
            MaxWidth = MaxWidth.Large,
            FullWidth = true
        };
        
        await DialogService.ShowAsync<AuditLogDetailsDialog>(
            $"Î›ÎµÏ€Ï„Î¿Î¼Î­ÏÎµÎ¹ÎµÏ‚ Î•Î½Î­ÏÎ³ÎµÎ¹Î±Ï‚ - {GetActionDisplayName(auditLog.Action)}", 
            parameters,
            options);
    }

    private string GetActionDisplayName(AuditAction action) => action switch
    {
        AuditAction.Login => "Î£ÏÎ½Î´ÎµÏƒÎ·",
        AuditAction.Logout => "Î‘Ï€Î¿ÏƒÏÎ½Î´ÎµÏƒÎ·",
        AuditAction.LoginFailed => "Î‘Ï€Î¿Ï„Ï…Ï‡Î·Î¼Î­Î½Î· Î£ÏÎ½Î´ÎµÏƒÎ·",
        AuditAction.MemberCreate => "Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎœÎ­Î»Î¿Ï…Ï‚",
        AuditAction.MemberUpdate => "Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· ÎœÎ­Î»Î¿Ï…Ï‚",
        AuditAction.MemberDelete => "Î”Î¹Î±Î³ÏÎ±Ï†Î® ÎœÎ­Î»Î¿Ï…Ï‚",
        AuditAction.UserCreate => "Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Î§ÏÎ®ÏƒÏ„Î·",
        AuditAction.UserUpdate => "Î•Î½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î§ÏÎ®ÏƒÏ„Î·",
        AuditAction.UserDelete => "Î”Î¹Î±Î³ÏÎ±Ï†Î® Î§ÏÎ®ÏƒÏ„Î·",
        AuditAction.PaymentCreate => "ÎÎ­Î± Î Î»Î·ÏÏ‰Î¼Î®",
        AuditAction.ExpenseCreate => "ÎÎ­Î¿ ÎˆÎ¾Î¿Î´Î¿",
        _ => action.ToString()
    };

    private Color GetActionColor(AuditAction action) => action switch
    {
        AuditAction.Login => Color.Success,
        AuditAction.Logout => Color.Info,
        AuditAction.LoginFailed => Color.Error,
        AuditAction.MemberCreate or AuditAction.UserCreate or AuditAction.PaymentCreate or AuditAction.ExpenseCreate => Color.Primary,
        AuditAction.MemberUpdate or AuditAction.UserUpdate => Color.Warning,
        AuditAction.MemberDelete or AuditAction.UserDelete => Color.Error,
        AuditAction.UnauthorizedAccess => Color.Error,
        _ => Color.Default
    };

    private string GetUserIcon(AuditAction action) => action switch
    {
        AuditAction.Login => Icons.Material.Filled.Login,
        AuditAction.Logout => Icons.Material.Filled.Logout,
        AuditAction.LoginFailed => Icons.Material.Filled.Block,
        AuditAction.MemberCreate or AuditAction.MemberUpdate or AuditAction.MemberDelete => Icons.Material.Filled.Group,
        AuditAction.UserCreate or AuditAction.UserUpdate or AuditAction.UserDelete => Icons.Material.Filled.AdminPanelSettings,
        AuditAction.PaymentCreate => Icons.Material.Filled.Payment,
        AuditAction.ExpenseCreate => Icons.Material.Filled.Receipt,
        AuditAction.UnauthorizedAccess => Icons.Material.Filled.Security,
        _ => Icons.Material.Filled.History
    };
}