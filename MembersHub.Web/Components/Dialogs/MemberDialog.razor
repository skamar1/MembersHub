@using MembersHub.Core.Entities
@using MembersHub.Application.DTOs
@using MembersHub.Application.Services
@using MembersHub.Core.Interfaces
@using Microsoft.EntityFrameworkCore
@using MembersHub.Infrastructure.Data
@using System.ComponentModel.DataAnnotations
@using MudBlazor
@inject IMemberService MemberService
@inject IDbContextFactory<MembersHubContext> ContextFactory
@inject ISnackbar Snackbar
@inject IAuditService AuditService
@inject ISessionService SessionService
@inject IHttpContextInfoService HttpContextInfo
@inject TimeZoneService TimeZone

<MudDialog Style="min-width: 800px;">
    <DialogContent>
        <MudForm @ref="form" @bind-IsValid="@success" @bind-Errors="@errors">
            <MudTabs Elevation="2" ApplyEffectsToContainer="true" PanelClass="pa-6">
                <!-- Basic Information Tab -->
                <MudTabPanel Text="Βασικά Στοιχεία" Icon="@Icons.Material.Filled.Person">
                    <MudGrid Spacing="3">
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="model.FirstName"
                                          Label="Όνομα"
                                          Required="true"
                                          RequiredError="Το όνομα είναι υποχρεωτικό"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="model.LastName"
                                          Label="Επώνυμο"
                                          Required="true"
                                          RequiredError="Το επώνυμο είναι υποχρεωτικό"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudDatePicker @bind-Date="dateOfBirth"
                                           Label="Ημερομηνία Γέννησης"
                                           Editable="true"
                                           DateFormat="dd/MM/yyyy"
                                           Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudSelect T="Gender?" @bind-Value="model.Gender"
                                       Label="Φύλο"
                                       Variant="Variant.Outlined">
                                <MudSelectItem T="Gender?" Value="@((Gender?)null)">Δεν προσδιορίζεται</MudSelectItem>
                                <MudSelectItem T="Gender?" Value="@((Gender?)Gender.Male)">Άνδρας</MudSelectItem>
                                <MudSelectItem T="Gender?" Value="@((Gender?)Gender.Female)">Γυναίκα</MudSelectItem>
                                <MudSelectItem T="Gender?" Value="@((Gender?)Gender.Other)">Άλλο</MudSelectItem>
                            </MudSelect>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="model.Phone"
                                          Label="Τηλέφωνο"
                                          Required="true"
                                          RequiredError="Το τηλέφωνο είναι υποχρεωτικό"
                                          InputType="InputType.Telephone"
                                          HelperText="π.χ. 6912345678 ή 2101234567"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="model.Email"
                                          Label="Email (προαιρετικό)"
                                          InputType="InputType.Email"
                                          Validation="@(new EmailAddressAttribute() { ErrorMessage = "Μη έγκυρο email" })"
                                          HelperText="Μπορεί να είναι κοινό για παιδιά (π.χ. email γονέα)"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudSelect @bind-Value="model.MembershipTypeId"
                                       Label="Τύπος Συνδρομής"
                                       Required="true"
                                       RequiredError="Επιλέξτε τύπο συνδρομής"
                                       Variant="Variant.Outlined">
                                @foreach (var type in membershipTypes)
                                {
                                    <MudSelectItem Value="@type.Id">
                                        @type.Name - €@type.MonthlyFee/μήνα
                                    </MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                        @if (IsEdit)
                        {
                            <MudItem xs="12" sm="6">
                                <MudSelect @bind-Value="updateModel.Status"
                                           Label="Κατάσταση"
                                           Variant="Variant.Outlined">
                                    <MudSelectItem Value="MemberStatus.Active">Ενεργό</MudSelectItem>
                                    <MudSelectItem Value="MemberStatus.Inactive">Ανενεργό</MudSelectItem>
                                    <MudSelectItem Value="MemberStatus.Suspended">Αναστολή</MudSelectItem>
                                </MudSelect>
                            </MudItem>
                            <MudItem xs="12" sm="6">
                                <MudTextField Value="@existingMember?.MemberNumber"
                                              Label="Αριθμός Μέλους"
                                              ReadOnly="true"
                                              Variant="Variant.Outlined" />
                            </MudItem>
                        }
                        <MudItem xs="12" sm="6">
                            <MudSelect T="int?" @bind-Value="model.DepartmentId"
                                       Label="Τμήμα"
                                       Variant="Variant.Outlined"
                                       Clearable="true">
                                @foreach (var dept in departments)
                                {
                                    <MudSelectItem T="int?" Value="@dept.Id">@dept.Name</MudSelectItem>
                                }
                            </MudSelect>
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- Parents & Guardian Tab -->
                <MudTabPanel Text="Γονείς & Κηδεμόνας" Icon="@Icons.Material.Filled.FamilyRestroom">
                    <MudGrid Spacing="3">
                        <MudItem xs="12">
                            <MudDivider Class="my-3">
                                <MudText Typo="Typo.subtitle2">Στοιχεία Γονέων</MudText>
                            </MudDivider>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="model.FatherFullName"
                                          Label="Όνομα και Επώνυμο Πατρός"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="model.MotherFullName"
                                          Label="Όνομα και Επώνυμο Μητρός"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudDivider Class="my-3">
                                <MudText Typo="Typo.subtitle2">Στοιχεία Κηδεμόνα</MudText>
                            </MudDivider>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="model.GuardianFullName"
                                          Label="Όνομα και Επώνυμο Κηδεμόνα"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="model.GuardianPhone"
                                          Label="Τηλέφωνο Κηδεμόνα"
                                          InputType="InputType.Telephone"
                                          OnBlur="ValidateGuardianPhone"
                                          Error="@guardianPhoneError"
                                          ErrorText="Το τηλέφωνο πρέπει να έχει 10 ψηφία"
                                          HelperText="π.χ. 6912345678"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="model.GuardianEmail"
                                          Label="Email Κηδεμόνα"
                                          InputType="InputType.Email"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="model.GuardianTaxNumber"
                                          Label="ΑΦΜ Κηδεμόνα"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

                <!-- Address & Documents Tab -->
                <MudTabPanel Text="Διεύθυνση & Έγγραφα" Icon="@Icons.Material.Filled.LocationOn">
                    <MudGrid Spacing="3">
                        <MudItem xs="12">
                            <MudTextField @bind-Value="model.Address"
                                          Label="Διεύθυνση"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="model.PostalCode"
                                          Label="Ταχυδρομικός Κώδικας"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="model.City"
                                          Label="Πόλη"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12">
                            <MudDivider Class="my-3">
                                <MudText Typo="Typo.subtitle2">Επίσημα Έγγραφα</MudText>
                            </MudDivider>
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="model.IdNumber"
                                          Label="Αριθμός Ταυτότητας"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="model.SocialSecurityNumber"
                                          Label="ΑΜΚΑ"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField @bind-Value="model.TaxNumber"
                                          Label="ΑΦΜ"
                                          Variant="Variant.Outlined" />
                        </MudItem>
                    </MudGrid>
                </MudTabPanel>

            </MudTabs>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Άκυρο</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled" 
                   OnClick="Submit"
                   Disabled="@processing">
            @if (processing)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">Αποθήκευση...</MudText>
            }
            else
            {
                <MudText>@(IsEdit ? "Ενημέρωση" : "Δημιουργία")</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    public IMudDialogInstance MudDialog { get; set; } = null!;
    
    [Parameter] 
    public Member? ExistingMember { get; set; }

    private bool IsEdit => ExistingMember != null;
    private MudForm form = null!;
    private bool success;
    private string[] errors = { };
    private bool processing = false;
    private bool guardianPhoneError = false;

    private CreateMemberDto model = new();
    private UpdateMemberDto updateModel = new();
    private Member? existingMember;
    private DateTime? dateOfBirth;
    private List<MembershipType> membershipTypes = new();
    private List<Department> departments = new();

    protected override async Task OnInitializedAsync()
    {
        // Load membership types and departments
        using var context = ContextFactory.CreateDbContext();
        membershipTypes = await context.MembershipTypes
            .Where(mt => mt.IsActive)
            .OrderBy(mt => mt.Name)
            .ToListAsync();

        departments = await context.Departments
            .Where(d => d.IsActive)
            .OrderBy(d => d.Name)
            .ToListAsync();

        if (IsEdit && ExistingMember != null)
        {
            existingMember = ExistingMember;
            // Populate update model
            updateModel = new UpdateMemberDto
            {
                Id = existingMember.Id,
                FirstName = existingMember.FirstName,
                LastName = existingMember.LastName,
                Email = existingMember.Email,
                Phone = existingMember.Phone,
                DateOfBirth = existingMember.DateOfBirth,
                Gender = existingMember.Gender,
                ApplicationNumber = existingMember.ApplicationNumber,
                DepartmentId = existingMember.DepartmentId,
                FatherFullName = existingMember.FatherFullName,
                MotherFullName = existingMember.MotherFullName,
                Address = existingMember.Address,
                PostalCode = existingMember.PostalCode,
                City = existingMember.City,
                IdNumber = existingMember.IdNumber,
                SocialSecurityNumber = existingMember.SocialSecurityNumber,
                TaxNumber = existingMember.TaxNumber,
                GuardianFullName = existingMember.GuardianFullName,
                GuardianPhone = existingMember.GuardianPhone,
                GuardianTaxNumber = existingMember.GuardianTaxNumber,
                GuardianEmail = existingMember.GuardianEmail,
                MembershipTypeId = existingMember.MembershipTypeId,
                Status = existingMember.Status
            };
            model = new CreateMemberDto
            {
                FirstName = existingMember.FirstName,
                LastName = existingMember.LastName,
                Email = existingMember.Email,
                Phone = existingMember.Phone,
                DateOfBirth = existingMember.DateOfBirth,
                Gender = existingMember.Gender,
                ApplicationNumber = existingMember.ApplicationNumber,
                DepartmentId = existingMember.DepartmentId,
                FatherFullName = existingMember.FatherFullName,
                MotherFullName = existingMember.MotherFullName,
                Address = existingMember.Address,
                PostalCode = existingMember.PostalCode,
                City = existingMember.City,
                IdNumber = existingMember.IdNumber,
                SocialSecurityNumber = existingMember.SocialSecurityNumber,
                TaxNumber = existingMember.TaxNumber,
                GuardianFullName = existingMember.GuardianFullName,
                GuardianPhone = existingMember.GuardianPhone,
                GuardianTaxNumber = existingMember.GuardianTaxNumber,
                GuardianEmail = existingMember.GuardianEmail,
                MembershipTypeId = existingMember.MembershipTypeId
            };
            // Convert UTC date from database to Greek time for display in DatePicker
            if (existingMember.DateOfBirth.HasValue)
            {
                dateOfBirth = TimeZone.ConvertToGreekTime(existingMember.DateOfBirth.Value).Date;
            }
        }
    }

    private void ValidateGuardianPhone()
    {
        guardianPhoneError = !string.IsNullOrEmpty(model.GuardianPhone) &&
                             !System.Text.RegularExpressions.Regex.IsMatch(model.GuardianPhone, @"^\d{10}$");
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private async Task Submit()
    {
        if (form != null)
        {
            await form.Validate();
            
            if (!success)
            {
                Snackbar.Add("Παρακαλώ διορθώστε τα σφάλματα στη φόρμα", Severity.Warning);
                return;
            }
        }

        processing = true;
        StateHasChanged();

        try
        {
            // Update date of birth from picker and convert to UTC
            if (dateOfBirth.HasValue)
            {
                // Treat date as Greek timezone date and convert to UTC for database
                var dateOnly = new DateTime(dateOfBirth.Value.Year, dateOfBirth.Value.Month, dateOfBirth.Value.Day);
                model.DateOfBirth = TimeZone.ConvertToUtc(dateOnly);
                if (IsEdit) updateModel.DateOfBirth = TimeZone.ConvertToUtc(dateOnly);
            }

            if (IsEdit)
            {
                // Update existing member
                // Get old values for audit (AsNoTracking για accurate snapshot)
                using var context = ContextFactory.CreateDbContext();
                var oldMember = await context.Members
                    .AsNoTracking()
                    .FirstOrDefaultAsync(m => m.Id == updateModel.Id);
                
                var member = await MemberService.GetByIdAsync(updateModel.Id);
                if (member != null && oldMember != null)
                {
                    // Basic Information
                    member.FirstName = model.FirstName;
                    member.LastName = model.LastName;
                    member.Email = model.Email;
                    member.Phone = model.Phone;
                    member.DateOfBirth = model.DateOfBirth;
                    member.Gender = model.Gender;

                    // Application Information
                    member.ApplicationNumber = model.ApplicationNumber;
                    member.DepartmentId = model.DepartmentId;

                    // Parents Information
                    member.FatherFullName = model.FatherFullName;
                    member.MotherFullName = model.MotherFullName;

                    // Address Information
                    member.Address = model.Address;
                    member.PostalCode = model.PostalCode;
                    member.City = model.City;

                    // Official Documents
                    member.IdNumber = model.IdNumber;
                    member.SocialSecurityNumber = model.SocialSecurityNumber;
                    member.TaxNumber = model.TaxNumber;

                    // Guardian Information
                    member.GuardianFullName = model.GuardianFullName;
                    member.GuardianPhone = model.GuardianPhone;
                    member.GuardianTaxNumber = model.GuardianTaxNumber;
                    member.GuardianEmail = model.GuardianEmail;

                    // Membership Information
                    member.MembershipTypeId = model.MembershipTypeId;
                    member.Status = updateModel.Status;
                    
                    await MemberService.UpdateAsync(member);
                    
                    // Audit logging για member update
                    var currentUser = await SessionService.GetCurrentUserAsync();
                    if (currentUser != null)
                    {
                        await AuditService.LogUpdateAsync(oldMember, member, 
                            currentUser.Id, currentUser.Username, currentUser.FullName, 
                            HttpContextInfo.GetIpAddress());
                    }
                    
                    Snackbar.Add($"Το μέλος '{member.FullName}' ενημερώθηκε επιτυχώς", Severity.Success);
                }
            }
            else
            {
                // Create new member
                var newMember = model.ToEntity();
                var currentUser = await SessionService.GetCurrentUserAsync();
                await MemberService.CreateAsync(newMember, currentUser?.Id);

                // Audit logging για member creation
                if (currentUser != null)
                {
                    await AuditService.LogCreateAsync(newMember, 
                        currentUser.Id, currentUser.Username, currentUser.FullName, 
                        HttpContextInfo.GetIpAddress());
                }
                
                Snackbar.Add($"Το μέλος '{newMember.FullName}' δημιουργήθηκε επιτυχώς με αριθμό {newMember.MemberNumber}", Severity.Success);
            }
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (ArgumentException ex)
        {
            // Display validation errors clearly
            Snackbar.Add(ex.Message, Severity.Error);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Σφάλμα: {ex.Message}", Severity.Error);
        }
        finally
        {
            processing = false;
            StateHasChanged();
        }
    }
}