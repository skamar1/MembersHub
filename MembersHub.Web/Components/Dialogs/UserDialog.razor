@using MembersHub.Core.Entities
@using MembersHub.Core.Interfaces
@using Microsoft.EntityFrameworkCore
@using MembersHub.Infrastructure.Data
@using System.ComponentModel.DataAnnotations
@using MudBlazor
@inject IDbContextFactory<MembersHubContext> ContextFactory
@inject ISnackbar Snackbar
@inject IAuthenticationService AuthService
@inject IAuditService AuditService
@inject ISessionService SessionService
@inject IHttpContextInfoService HttpContextInfo

<MudDialog>
    <DialogContent>
        <MudForm @ref="form" @bind-IsValid="@success" @bind-Errors="@errors">
            <MudGrid Spacing="2">
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="model.FirstName" 
                                  Label="Όνομα" 
                                  Required="true" 
                                  RequiredError="Το όνομα είναι υποχρεωτικό"
                                  Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="model.LastName" 
                                  Label="Επώνυμο" 
                                  Required="true" 
                                  RequiredError="Το επώνυμο είναι υποχρεωτικό"
                                  Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="model.Username" 
                                  Label="Όνομα Χρήστη" 
                                  Required="true" 
                                  RequiredError="Το όνομα χρήστη είναι υποχρεωτικό"
                                  Variant="Variant.Outlined"
                                  ReadOnly="@IsEdit" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="model.Phone"
                                  Label="Τηλέφωνο"
                                  Required="true"
                                  RequiredError="Το τηλέφωνο είναι υποχρεωτικό"
                                  InputType="InputType.Telephone"
                                  OnBlur="ValidatePhone"
                                  Error="@phoneError"
                                  ErrorText="Το τηλέφωνο πρέπει να έχει 10 ψηφία"
                                  HelperText="π.χ. 6912345678"
                                  Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="model.Email" 
                                  Label="Email" 
                                  InputType="InputType.Email"
                                  Validation="@(new EmailAddressAttribute() { ErrorMessage = "Μη έγκυρο email" })"
                                  Variant="Variant.Outlined" />
                </MudItem>
                <MudItem xs="12" sm="6">
                    <MudSelect T="UserRole" @bind-Value="model.Role" 
                               Label="Ρόλος Χρήστη" 
                               Required="true"
                               RequiredError="Επιλέξτε ρόλο χρήστη"
                               Variant="Variant.Outlined">
                        <MudSelectItem T="UserRole" Value="UserRole.Admin">Διαχειριστής</MudSelectItem>
                        <MudSelectItem T="UserRole" Value="UserRole.Owner">Ιδιοκτήτης</MudSelectItem>
                        <MudSelectItem T="UserRole" Value="UserRole.Treasurer">Ταμίας</MudSelectItem>
                        <MudSelectItem T="UserRole" Value="UserRole.Secretary">Γραμματέας</MudSelectItem>
                        <MudSelectItem T="UserRole" Value="UserRole.Staff">Προσωπικό</MudSelectItem>
                        <MudSelectItem T="UserRole" Value="UserRole.Viewer">Θεατής</MudSelectItem>
                    </MudSelect>
                </MudItem>
                @if (!IsEdit)
                {
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="model.Password" 
                                      Label="Κωδικός Πρόσβασης" 
                                      InputType="@passwordInput"
                                      Required="true" 
                                      RequiredError="Ο κωδικός είναι υποχρεωτικός"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@passwordInputIcon"
                                      OnAdornmentClick="TogglePasswordVisibility"
                                      AdornmentAriaLabel="Show Password"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField @bind-Value="confirmPassword" 
                                      Label="Επιβεβαίωση Κωδικού" 
                                      InputType="@confirmPasswordInput"
                                      Required="true" 
                                      RequiredError="Η επιβεβαίωση κωδικού είναι υποχρεωτική"
                                      Validation="@(new Func<string, string>(ValidatePasswordConfirmation))"
                                      Adornment="Adornment.End"
                                      AdornmentIcon="@confirmPasswordInputIcon"
                                      OnAdornmentClick="ToggleConfirmPasswordVisibility"
                                      AdornmentAriaLabel="Show Password"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                }
                @if (IsEdit)
                {
                    <MudItem xs="12" sm="6">
                        <MudSwitch @bind-Value="model.IsActive"
                                   Label="Ενεργός Χρήστης"
                                   Color="Color.Primary" />
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudTextField Value="@(existingUser?.CreatedAt.ToString("dd/MM/yyyy HH:mm"))"
                                      Label="Ημερομηνία Δημιουργίας"
                                      ReadOnly="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                }
                @if (canAssignDepartments && model.Role == UserRole.Treasurer)
                {
                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.subtitle1" Class="mb-2">Τμήματα που μπορεί να διαχειριστεί ο Ταμίας</MudText>
                        @if (!allDepartments.Any())
                        {
                            <MudText Typo="Typo.caption" Color="Color.Default">Δεν υπάρχουν διαθέσιμα τμήματα</MudText>
                        }
                        else
                        {
                            <div style="max-height: 300px; overflow-y: auto;">
                                @foreach (var dept in allDepartments)
                                {
                                    <MudCheckBox T="bool"
                                                 Value="@selectedDepartmentIdSet.Contains(dept.Id)"
                                                 ValueChanged="@((bool value) => OnDepartmentCheckChanged(dept.Id, value))"
                                                 Label="@dept.Name"
                                                 Color="Color.Primary"
                                                 Dense="true" />
                                }
                            </div>
                        }
                        @if (!selectedDepartmentIdSet.Any())
                        {
                            <MudText Typo="Typo.caption" Color="Color.Warning" Class="mt-2">
                                Αν δεν επιλεγεί κανένα τμήμα, ο ταμίας θα βλέπει όλους τους αθλητές/μέλη
                            </MudText>
                        }
                    </MudItem>
                }
            </MudGrid>
        </MudForm>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Άκυρο</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled" 
                   OnClick="Submit"
                   Disabled="@processing">
            @if (processing)
            {
                <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                <MudText Class="ms-2">Αποθήκευση...</MudText>
            }
            else
            {
                <MudText>@(IsEdit ? "Ενημέρωση" : "Δημιουργία")</MudText>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] 
    public IMudDialogInstance MudDialog { get; set; } = null!;
    
    [Parameter] 
    public User? ExistingUser { get; set; }

    private bool IsEdit => ExistingUser != null;
    private MudForm form = null!;
    private bool success;
    private string[] errors = { };
    private bool processing = false;
    private bool phoneError = false;

    private UserModel model = new();
    private User? existingUser;

    // Department assignment for treasurers
    private List<Department> allDepartments = new();
    private HashSet<int> selectedDepartmentIdSet = new();
    private bool canAssignDepartments = false;

    // Password visibility
    private bool isPasswordVisible;
    private InputType passwordInput = InputType.Password;
    private string passwordInputIcon = Icons.Material.Filled.VisibilityOff;
    
    private bool isConfirmPasswordVisible;
    private InputType confirmPasswordInput = InputType.Password;
    private string confirmPasswordInputIcon = Icons.Material.Filled.VisibilityOff;
    
    private string confirmPassword = "";

    protected override async Task OnInitializedAsync()
    {
        // Check if current user can assign departments (Admin or Owner)
        var currentUser = await SessionService.GetCurrentUserAsync();
        canAssignDepartments = currentUser != null &&
            (currentUser.Role == UserRole.Admin || currentUser.Role == UserRole.Owner);

        // Load all departments for assignment
        if (canAssignDepartments)
        {
            using var context = ContextFactory.CreateDbContext();
            allDepartments = await context.Departments
                .Where(d => d.IsActive)
                .OrderBy(d => d.Name)
                .ToListAsync();
        }

        if (IsEdit && ExistingUser != null)
        {
            existingUser = ExistingUser;
            // Populate model for editing
            model = new UserModel
            {
                FirstName = existingUser.FirstName,
                LastName = existingUser.LastName,
                Username = existingUser.Username,
                Email = existingUser.Email,
                Phone = existingUser.Phone,
                Role = existingUser.Role,
                IsActive = existingUser.IsActive
            };

            // Load assigned departments for this user
            if (canAssignDepartments && existingUser.Role == UserRole.Treasurer)
            {
                using var context = ContextFactory.CreateDbContext();
                var userDeptIds = await context.UserDepartments
                    .Where(ud => ud.UserId == existingUser.Id)
                    .Select(ud => ud.DepartmentId)
                    .ToListAsync();
                selectedDepartmentIdSet = new HashSet<int>(userDeptIds);
            }
        }
        else
        {
            // Set default values for new user
            model.IsActive = true;
            model.Role = UserRole.Viewer;
        }
    }

    private void ValidatePhone()
    {
        phoneError = !string.IsNullOrEmpty(model.Phone) &&
                     !System.Text.RegularExpressions.Regex.IsMatch(model.Phone, @"^\d{10}$");
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private void TogglePasswordVisibility()
    {
        if (isPasswordVisible)
        {
            isPasswordVisible = false;
            passwordInputIcon = Icons.Material.Filled.VisibilityOff;
            passwordInput = InputType.Password;
        }
        else
        {
            isPasswordVisible = true;
            passwordInputIcon = Icons.Material.Filled.Visibility;
            passwordInput = InputType.Text;
        }
    }
    
    private void ToggleConfirmPasswordVisibility()
    {
        if (isConfirmPasswordVisible)
        {
            isConfirmPasswordVisible = false;
            confirmPasswordInputIcon = Icons.Material.Filled.VisibilityOff;
            confirmPasswordInput = InputType.Password;
        }
        else
        {
            isConfirmPasswordVisible = true;
            confirmPasswordInputIcon = Icons.Material.Filled.Visibility;
            confirmPasswordInput = InputType.Text;
        }
    }
    
    private string ValidatePasswordConfirmation(string confirmPwd)
    {
        if (string.IsNullOrEmpty(confirmPwd))
            return "Η επιβεβαίωση κωδικού είναι υποχρεωτική";
            
        if (confirmPwd != model.Password)
            return "Οι κωδικοί δεν ταιριάζουν";
            
        return null!;
    }

    private async Task Submit()
    {
        if (form != null)
        {
            await form.Validate();
            
            if (!success)
            {
                Snackbar.Add("Παρακαλώ διορθώστε τα σφάλματα στη φόρμα", Severity.Warning);
                return;
            }
        }
        
        // Additional validation for new users
        if (!IsEdit && string.IsNullOrEmpty(model.Password))
        {
            Snackbar.Add("Ο κωδικός πρόσβασης είναι υποχρεωτικός", Severity.Warning);
            return;
        }
        
        if (!IsEdit && model.Password != confirmPassword)
        {
            Snackbar.Add("Οι κωδικοί πρόσβασης δεν ταιριάζουν", Severity.Warning);
            return;
        }

        processing = true;
        StateHasChanged();

        try
        {
            if (IsEdit && existingUser != null)
            {
                using var context = ContextFactory.CreateDbContext();

                // Get old values for audit (AsNoTracking για accurate snapshot)
                var oldUser = await context.Users
                    .AsNoTracking()
                    .FirstOrDefaultAsync(u => u.Id == existingUser.Id);

                if (oldUser == null)
                {
                    Snackbar.Add("Σφάλμα: Ο χρήστης δεν βρέθηκε", Severity.Error);
                    return;
                }

                // Get fresh entity from database for update
                var userToUpdate = await context.Users.FindAsync(existingUser.Id);
                if (userToUpdate == null)
                {
                    Snackbar.Add("Σφάλμα: Ο χρήστης δεν βρέθηκε", Severity.Error);
                    return;
                }

                // Update user properties
                userToUpdate.FirstName = model.FirstName;
                userToUpdate.LastName = model.LastName;
                userToUpdate.Email = model.Email;
                userToUpdate.Phone = model.Phone;
                userToUpdate.Role = model.Role;
                userToUpdate.IsActive = model.IsActive;
                userToUpdate.UpdatedAt = DateTime.UtcNow;

                await context.SaveChangesAsync();

                // Save department assignments for Treasurers
                if (canAssignDepartments && model.Role == UserRole.Treasurer)
                {
                    await SaveUserDepartmentsAsync(context, existingUser.Id);
                }

                // Audit logging για user update
                var currentUser = await SessionService.GetCurrentUserAsync();
                if (currentUser != null)
                {
                    await AuditService.LogUpdateAsync(oldUser, userToUpdate,
                        currentUser.Id, currentUser.Username, currentUser.FullName,
                        HttpContextInfo.GetIpAddress());
                }

                Snackbar.Add($"Ο χρήστης '{userToUpdate.FullName}' ενημερώθηκε επιτυχώς", Severity.Success);
            }
            else
            {
                using var context = ContextFactory.CreateDbContext();

                // Check if username already exists
                var existingUsername = await context.Users
                    .AnyAsync(u => u.Username == model.Username);

                if (existingUsername)
                {
                    Snackbar.Add("Το όνομα χρήστη υπάρχει ήδη", Severity.Error);
                    return;
                }

                // Create new user
                var newUser = new User
                {
                    Username = model.Username,
                    PasswordHash = await AuthService.HashPasswordAsync(model.Password),
                    FirstName = model.FirstName,
                    LastName = model.LastName,
                    Email = model.Email,
                    Phone = model.Phone,
                    Role = model.Role,
                    IsActive = model.IsActive,
                    CreatedAt = DateTime.UtcNow,
                    UpdatedAt = DateTime.UtcNow
                };

                context.Users.Add(newUser);
                await context.SaveChangesAsync();

                // Save department assignments for Treasurers
                if (canAssignDepartments && model.Role == UserRole.Treasurer)
                {
                    await SaveUserDepartmentsAsync(context, newUser.Id);
                }

                // Audit logging για user creation
                var currentUser = await SessionService.GetCurrentUserAsync();
                if (currentUser != null)
                {
                    await AuditService.LogCreateAsync(newUser,
                        currentUser.Id, currentUser.Username, currentUser.FullName,
                        HttpContextInfo.GetIpAddress());
                }

                Snackbar.Add($"Ο χρήστης '{newUser.FullName}' δημιουργήθηκε επιτυχώς", Severity.Success);
            }
            
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Σφάλμα: {ex.Message}", Severity.Error);
        }
        finally
        {
            processing = false;
            StateHasChanged();
        }
    }
    

    private void OnDepartmentCheckChanged(int deptId, bool isChecked)
    {
        if (isChecked)
        {
            selectedDepartmentIdSet.Add(deptId);
        }
        else
        {
            selectedDepartmentIdSet.Remove(deptId);
        }
    }

    private async Task SaveUserDepartmentsAsync(MembersHubContext context, int userId)
    {
        // Remove existing assignments
        var existingAssignments = await context.UserDepartments
            .Where(ud => ud.UserId == userId)
            .ToListAsync();
        context.UserDepartments.RemoveRange(existingAssignments);

        // Add new assignments
        foreach (var deptId in selectedDepartmentIdSet)
        {
            context.UserDepartments.Add(new UserDepartment
            {
                UserId = userId,
                DepartmentId = deptId
            });
        }

        await context.SaveChangesAsync();
    }

    public class UserModel
    {
        public string FirstName { get; set; } = string.Empty;
        public string LastName { get; set; } = string.Empty;
        public string Username { get; set; } = string.Empty;
        public string? Email { get; set; }
        public string Phone { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public UserRole Role { get; set; } = UserRole.Viewer;
        public bool IsActive { get; set; } = true;
    }
}