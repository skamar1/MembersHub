@using MembersHub.Core.Entities
@using MembersHub.Core.Interfaces
@using MudBlazor
@inject IExpenseCategoryService ExpenseCategoryService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudGrid Spacing="3">
            <MudItem xs="12">
                @if (ExistingCategory != null)
                {
                    <MudAlert Severity="Severity.Info">
                        Επεξεργασία @(ExistingCategory.ParentCategoryId.HasValue ? "Υποκατηγορίας" : "Κατηγορίας"): @ExistingCategory.Name
                    </MudAlert>
                }
                else if (ParentCategory != null)
                {
                    <MudAlert Severity="Severity.Info">
                        Δημιουργία Υποκατηγορίας για: @ParentCategory.Name
                    </MudAlert>
                }
            </MudItem>

            @if (ExistingCategory == null && ParentCategory == null)
            {
                <MudItem xs="12">
                    <MudSelect T="int?" Label="Γονική Κατηγορία" @bind-Value="category.ParentCategoryId"
                               Variant="Variant.Outlined"
                               HelperText="Αφήστε κενό για δημιουργία κύριας κατηγορίας">
                        <MudSelectItem T="int?" Value="@((int?)null)">-- Καμία (Κύρια Κατηγορία) --</MudSelectItem>
                        @foreach (var parent in parentCategories)
                        {
                            <MudSelectItem T="int?" Value="@parent.Id">@parent.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
            }

            <MudItem xs="12">
                <MudTextField Label="@(ParentCategory != null || category.ParentCategoryId.HasValue ? "Όνομα Υποκατηγορίας *" : "Όνομα Κατηγορίας *")"
                              @bind-Value="category.Name"
                              Required="true"
                              Variant="Variant.Outlined"
                              MaxLength="100"
                              Counter="100" />
            </MudItem>

            <MudItem xs="12">
                <MudTextField Label="Περιγραφή"
                              @bind-Value="category.Description"
                              Variant="Variant.Outlined"
                              Lines="3"
                              MaxLength="500"
                              Counter="500" />
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudSelect T="string" Label="Icon" @bind-Value="category.IconName"
                           Variant="Variant.Outlined" AnchorOrigin="Origin.BottomCenter">
                    @foreach (var icon in availableIcons)
                    {
                        <MudSelectItem T="string" Value="@icon.Value">
                            <div class="d-flex align-center">
                                <MudIcon Icon="@icon.Value" Class="mr-2" Size="Size.Small" />
                                @icon.Name
                            </div>
                        </MudSelectItem>
                    }
                </MudSelect>
            </MudItem>

            <MudItem xs="12" sm="6">
                <MudColorPicker Label="Χρώμα"
                                @bind-Text="category.ColorCode"
                                Variant="Variant.Outlined"
                                ColorPickerView="ColorPickerView.Palette"
                                Placeholder="#RRGGBB" />
            </MudItem>

            <MudItem xs="12">
                <MudNumericField T="int"
                                 Label="Σειρά Εμφάνισης"
                                 @bind-Value="category.DisplayOrder"
                                 Variant="Variant.Outlined"
                                 Min="0"
                                 HelperText="Χαμηλότερος αριθμός = εμφάνιση πρώτα" />
            </MudItem>

            @if (ExistingCategory != null)
            {
                <MudItem xs="12">
                    <MudSwitch T="bool"
                               @bind-Value="category.IsActive"
                               Color="Color.Primary"
                               Label="Ενεργή Κατηγορία" />
                </MudItem>
            }

            @if (saving)
            {
                <MudItem xs="12">
                    <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
                </MudItem>
            }
        </MudGrid>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Άκυρο</MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="Save"
                   Disabled="@saving">
            @(ExistingCategory != null ? "Ενημέρωση" : "Δημιουργία")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    public IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public ExpenseCategory? ExistingCategory { get; set; }

    [Parameter]
    public ExpenseCategory? ParentCategory { get; set; }

    private ExpenseCategory category = new();
    private List<ExpenseCategory> parentCategories = new();
    private bool saving = false;

    private readonly List<(string Name, string Value)> availableIcons = new()
    {
        ("Απόδειξη", Icons.Material.Filled.Receipt),
        ("Αγορές", Icons.Material.Filled.ShoppingCart),
        ("Καύσιμα", Icons.Material.Filled.LocalGasStation),
        ("Εστιατόριο", Icons.Material.Filled.Restaurant),
        ("Υγεία", Icons.Material.Filled.LocalHospital),
        ("Σπίτι", Icons.Material.Filled.Home),
        ("Ηλεκτρικό", Icons.Material.Filled.ElectricBolt),
        ("Μεταφορές", Icons.Material.Filled.DirectionsBus),
        ("Χρήματα", Icons.Material.Filled.AttachMoney),
        ("Τράπεζα", Icons.Material.Filled.AccountBalance),
        ("Συντήρηση", Icons.Material.Filled.Build),
        ("Υπολογιστής", Icons.Material.Filled.Computer),
        ("Τηλέφωνο", Icons.Material.Filled.Phone),
        ("Εκτύπωση", Icons.Material.Filled.Print),
        ("Εκπαίδευση", Icons.Material.Filled.School),
        ("Ασφάλεια", Icons.Material.Filled.Security),
        ("Internet", Icons.Material.Filled.Wifi),
        ("Γραφείο", Icons.Material.Filled.Business),
        ("Αθλητισμός", Icons.Material.Filled.SportsSoccer),
        ("Εκδήλωση", Icons.Material.Filled.Event),
        ("Ταξίδι", Icons.Material.Filled.Flight),
        ("Νερό", Icons.Material.Filled.Water),
        ("Καθαριότητα", Icons.Material.Filled.CleaningServices),
        ("Νομικά", Icons.Material.Filled.Gavel),
        ("Άλλο", Icons.Material.Filled.Category)
    };

    protected override async Task OnInitializedAsync()
    {
        // Load parent categories for dropdown
        parentCategories = await ExpenseCategoryService.GetParentCategoriesAsync();

        if (ExistingCategory != null)
        {
            category = new ExpenseCategory
            {
                Id = ExistingCategory.Id,
                Name = ExistingCategory.Name,
                Description = ExistingCategory.Description,
                IconName = ExistingCategory.IconName,
                ColorCode = ExistingCategory.ColorCode,
                DisplayOrder = ExistingCategory.DisplayOrder,
                IsActive = ExistingCategory.IsActive,
                ParentCategoryId = ExistingCategory.ParentCategoryId
            };
        }
        else if (ParentCategory != null)
        {
            // Creating a subcategory
            category.ParentCategoryId = ParentCategory.Id;
            category.IsActive = true;
        }
        else
        {
            category.IsActive = true;
        }
    }

    private async Task Save()
    {
        if (string.IsNullOrWhiteSpace(category.Name))
        {
            Snackbar.Add("Παρακαλώ συμπληρώστε το όνομα της κατηγορίας", Severity.Error);
            return;
        }

        saving = true;
        try
        {
            if (ExistingCategory != null)
            {
                // Update existing category
                var updated = await ExpenseCategoryService.UpdateCategoryAsync(category);
                var label = updated.ParentCategoryId.HasValue ? "υποκατηγορία" : "κατηγορία";
                Snackbar.Add($"Η {label} '{updated.Name}' ενημερώθηκε επιτυχώς", Severity.Success);
                MudDialog.Close(DialogResult.Ok(updated));
            }
            else
            {
                // Create new category
                var created = await ExpenseCategoryService.CreateCategoryAsync(category);
                var label = created.ParentCategoryId.HasValue ? "υποκατηγορία" : "κατηγορία";
                Snackbar.Add($"Η {label} '{created.Name}' δημιουργήθηκε επιτυχώς", Severity.Success);
                MudDialog.Close(DialogResult.Ok(created));
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Σφάλμα: {ex.Message}", Severity.Error);
        }
        finally
        {
            saving = false;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
